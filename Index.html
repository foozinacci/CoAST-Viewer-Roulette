<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CARLO Viewer Slot Machine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#020617;
      --panel:#020617;
      --border:#1f2937;
      --accent:#f9fafb;
      --blue:#38bdf8;
      --red:#fb4b4b;
      --green:#22c55e;
      --gold:#facc15;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --danger:#f97373;
      --ok:#4ade80;
      --spin:#facc15; /* default spin button color */
    }

    /* WHITE ‚Äì bright, gold, ‚Äúsun‚Äù feel */
    body.theme-white{
      --bg:#020617;
      --panel:#0b1120;
      --border:#4b5563;
      --accent:#fefce8;
      --gold:#facc15;
      --blue:#60a5fa;
      --red:#f97373;
      --green:#4ade80;
      --text:#f9fafb;
      --muted:#e5e7eb;
      --spin:#facc15;
    }
    /* BLUE ‚Äì neon teal, ‚Äúislands / tempo‚Äù */
    body.theme-blue{
      --bg:#020617;
      --panel:#020617;
      --border:#1f2937;
      --accent:#e0f2fe;
      --gold:#38bdf8;
      --blue:#38bdf8;
      --red:#fb4b4b;
      --green:#22c55e;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --spin:#38bdf8;
    }
    /* BLACK ‚Äì purple / lavender ‚Äúswamp‚Äù glam */
    body.theme-black{
      --bg:#020617;
      --panel:#050016;
      --border:#4c1d95;
      --accent:#e9d5ff;
      --gold:#eab308;
      --blue:#6366f1;
      --red:#fb4b4b;
      --green:#22c55e;
      --text:#f9fafb;
      --muted:#a855f7;
      --spin:#a855f7;
    }
    /* RED ‚Äì ember / lava */
    body.theme-red{
      --bg:#111827;
      --panel:#1f0a0a;
      --border:#7f1d1d;
      --accent:#fee2e2;
      --gold:#fb923c;
      --blue:#22d3ee;
      --red:#ef4444;
      --green:#22c55e;
      --text:#fee2e2;
      --muted:#fecaca;
      --spin:#ef4444;
    }
    /* GREEN ‚Äì forest + neon */
    body.theme-green{
      --bg:#022c22;
      --panel:#041f1a;
      --border:#064e3b;
      --accent:#dcfce7;
      --gold:#a3e635;
      --blue:#38bdf8;
      --red:#fb4b4b;
      --green:#22c55e;
      --text:#ecfdf5;
      --muted:#a7f3d0;
      --spin:#22c55e;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#0f172a 0,var(--bg) 45%,#000 100%);
      color:var(--text);
      display:flex;
      justify-content:center;
      min-height:100vh;
    }
    #app{
      width:100%;
      max-width:1200px;
      margin:8px;
      border-radius:18px;
      border:1px solid var(--border);
      background:linear-gradient(145deg,var(--bg) 0,var(--bg) 40%,#050816 100%);
      box-shadow:0 0 40px rgba(0,0,0,.8);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }
    header{
      padding:10px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .title{
      font-size:20px;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--gold);
      text-shadow:0 0 10px rgba(250,204,21,.55);
    }
    .subtitle{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .header-left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      font-size:11px;
    }
    .event-selector{
      display:flex;
      gap:4px;
      flex-wrap:wrap;
      font-size:11px;
      color:var(--muted);
      align-items:center;
    }
    .event-chip{
      border-radius:999px;
      border:1px solid var(--border);
      padding:3px 8px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.08em;
      opacity:.6;
    }
    .event-chip.active{
      opacity:1;
      border-color:var(--blue);
      box-shadow:0 0 10px rgba(56,189,248,.7);
      color:var(--blue);
    }

    .theme-toggle{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .theme-chip{
      width:18px;height:18px;
      border-radius:999px;
      border:1px solid var(--border);
      cursor:pointer;
      opacity:.6;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:9px;
      font-weight:700;
      text-shadow:0 0 4px rgba(0,0,0,.8);
    }
    .theme-chip.active{
      opacity:1;
      box-shadow:0 0 10px rgba(148,163,184,.9);
    }
    .theme-chip[data-color="W"]{background:#f9fafb;color:#111827;}
    .theme-chip[data-color="U"]{background:#0ea5e9;color:#e0f2fe;}
    .theme-chip[data-color="B"]{background:#020617;color:#f9fafb;}
    .theme-chip[data-color="R"]{background:#ef4444;color:#fef2f2;}
    .theme-chip[data-color="G"]{background:#22c55e;color:#ecfdf5;}

    main{
      flex:1;
      display:flex;
      flex-direction:column;
      overflow:auto;
    }

    /* SLOT PANEL */
    .slot-panel{
      background:radial-gradient(circle at top,var(--panel) 0,var(--bg) 40%,#000 100%);
      border-radius:16px;
      border:1px solid var(--border);
      padding:12px;
      margin:10px;
      position:relative;
      overflow:hidden;
    }
    .slot-panel::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at top,rgba(250,250,250,.04) 0,transparent 55%),
        radial-gradient(circle at center,rgba(56,189,248,.05) 0,transparent 55%),
        radial-gradient(circle at bottom,rgba(236,72,153,.07) 0,transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .slot-header{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-bottom:8px;
      position:relative;
      z-index:1;
    }
    .slot-title{
      font-size:13px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .spin-meta{
      font-size:11px;
      color:var(--muted);
    }

    .reels-box{
      position:relative;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.35);
      background:linear-gradient(180deg,var(--bg) 0,var(--bg) 40%,#000 100%);
      padding:10px 8px 14px;
      box-shadow:
        inset 0 0 18px rgba(15,23,42,.9),
        0 0 26px rgba(15,23,42,.9);
      overflow:hidden;
      z-index:1;
    }
    .reel-labels{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
      font-size:10px;
      color:var(--muted);
      letter-spacing:.18em;
      text-transform:uppercase;
    }
    .reels{
      display:flex;
      gap:6px;
      justify-content:space-between;
    }
    .reel{
      flex:1;
      background:radial-gradient(circle at top,var(--bg) 0,#000 70%);
      border-radius:12px;
      border:1px solid rgba(148,163,184,.45);
      padding:16px 4px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      box-shadow:
        inset 0 0 18px rgba(15,23,42,.9),
        0 0 18px rgba(15,23,42,.9);
    }
    .reel-inner{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      transform:translateY(0);
      transition:transform .18s ease-out;
    }
    .reel-symbol{
      font-size:16px;
      font-weight:800;
      text-transform:uppercase;
      padding:4px 8px;
      border-radius:8px;
      min-width:70px;
      max-width:100%;
      text-align:center;
      box-shadow:0 0 10px rgba(15,23,42,.9);
      white-space:normal;
      line-height:1.1;
      word-break:break-word;
    }
    .reel-symbol.player{
      background:rgba(15,23,42,.95);
      border:1px solid rgba(148,163,184,.75);
      color:var(--accent);
      text-shadow:0 0 8px rgba(248,250,252,.7);
    }
    .reel-symbol.letter{
      background:rgba(15,23,42,.95);
      border:1px solid var(--gold);
      color:var(--gold);
      text-shadow:0 0 12px rgba(250,204,21,.9);
    }
    .reel-symbol.luna{
      background:rgba(15,23,42,.95);
      border:1px solid #f973fa;
      box-shadow:0 0 16px rgba(244,114,182,.9);
      color:#f9a8d4;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .reel-symbol.luna img{
      max-width:42px;
      max-height:42px;
      border-radius:999px;
      display:block;
    }

    .reel:nth-child(1) .reel-symbol.player{
      border-color:#fef9c3;
      box-shadow:0 0 12px rgba(250,250,209,.9);
      color:#fefce8;
    }
    .reel:nth-child(2) .reel-symbol.player{
      border-color:#38bdf8;
      box-shadow:0 0 12px rgba(56,189,248,.9);
      color:#e0f2fe;
    }
    .reel:nth-child(3) .reel-symbol.player{
      border-color:#4b5563;
      box-shadow:0 0 12px rgba(15,23,42,.95);
      color:#f9fafb;
    }
    .reel:nth-child(4) .reel-symbol.player{
      border-color:#fb4b4b;
      box-shadow:0 0 12px rgba(248,113,113,.9);
      color:#fee2e2;
    }
    .reel:nth-child(5) .reel-symbol.player{
      border-color:#22c55e;
      box-shadow:0 0 12px rgba(34,197,94,.9);
      color:#dcfce7;
    }

    .reel.glow-win{
      box-shadow:
        0 0 28px rgba(250,204,21,.8),
        inset 0 0 20px rgba(250,250,250,.1);
      border-color:var(--gold);
    }
    .reel.glow-luna{
      box-shadow:
        0 0 24px rgba(244,114,182,.95),
        inset 0 0 18px rgba(24,24,27,.9);
      border-color:#f973fa;
    }

    @keyframes reelSpin{
      0%{transform:translateY(0);}
      100%{transform:translateY(-40%);}
    }
    .reel.spinning .reel-inner{animation:reelSpin .25s linear infinite;}

    .slot-controls{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      position:relative;
      z-index:1;
      flex-wrap:wrap;
    }
    .lever-area{display:flex;align-items:center;gap:10px;}
    .lever{
      width:22px;height:80px;
      border-radius:999px;
      background:linear-gradient(180deg,#111827 0,#020617 100%);
      border:1px solid #4b5563;
      position:relative;
      box-shadow:
        inset 0 0 8px rgba(15,23,42,.9),
        0 0 16px rgba(0,0,0,.8);
      cursor:pointer;
    }
    .lever-knob{
      width:26px;height:26px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#fee2e2 0,#f97373 35%,#7f1d1d 100%);
      border:2px solid #fef2f2;
      position:absolute;
      left:50%;transform:translateX(-50%);
      top:-13px;
      box-shadow:0 0 16px rgba(248,113,113,.85);
      transition:top .12s ease-out;
    }
    .lever.pull .lever-knob{top:54px;}

    /* SPIN BUTTON ‚Äì theme-colored, no glow */
    .spin-button{
      border-radius:999px;
      padding:8px 18px;
      border:none;
      font-size:13px;
      font-weight:800;
      letter-spacing:.18em;
      text-transform:uppercase;
      cursor:pointer;
      background:var(--spin);
      color:#0b1120;
      text-shadow:none;
      box-shadow:none;
      transition:transform .1s ease-out, opacity .1s ease-out;
    }
    .spin-button:disabled{
      opacity:.45;
      cursor:default;
      box-shadow:none;
    }
    .spin-button:active:not(:disabled){
      transform:translateY(1px) scale(.98);
    }

    .status-text{font-size:11px;color:var(--muted);min-height:14px;}

    /* LEADERBOARD */
    .leaderboard-panel{
      background:var(--panel);
      border-top:1px solid var(--border);
      padding:10px;
    }
    .leaderboard-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      font-size:12px;
      color:var(--muted);
      flex-wrap:wrap;
      gap:4px;
    }
    .add-player-form{
      display:flex;
      gap:6px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .add-player-form input{
      flex:1;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-size:11px;
      padding:6px 8px;
    }
    .add-player-form button{
      border-radius:999px;
      border:1px solid var(--blue);
      background:radial-gradient(circle at top,#38bdf8 0,#0ea5e9 40%,#0369a1 100%);
      font-size:11px;
      padding:6px 10px;
      color:#0b1120;
      text-transform:uppercase;
      letter-spacing:.12em;
      cursor:pointer;
      box-shadow:
        0 0 12px rgba(56,189,248,.7),
        inset 0 0 6px rgba(255,255,255,.4);
    }

    .leaderboard-wrapper{
      max-height:260px;
      overflow:auto;
      border-radius:10px;
      border:1px solid var(--border);
    }
    .leaderboard-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .leaderboard-table thead{
      background:#020617;
      position:sticky;
      top:0;
      z-index:1;
    }
    .leaderboard-table th,
    .leaderboard-table td{
      border-bottom:1px solid var(--border);
      padding:4px 6px;
      text-align:left;
      vertical-align:top;
    }
    .leaderboard-table th{
      text-transform:uppercase;
      letter-spacing:.12em;
      font-size:10px;
      color:var(--muted);
    }
    .player-row{cursor:pointer;}
    .player-row:hover{background:rgba(15,23,42,.8);}

    .pity-count{font-size:10px;color:var(--muted);}

    .reel-tickets-cell{
      display:flex;
      gap:4px;
      flex-wrap:wrap;
    }
    .reel-ticket{
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:9px;
      background:var(--panel);
      border-radius:6px;
      padding:2px 3px;
      border:1px solid var(--border);
      min-width:32px;
    }
    .reel-ticket label{
      font-size:8px;
      color:var(--muted);
    }
    .reel-ticket span{
      font-size:10px;
      margin:1px 0;
    }
    .reel-ticket button{
      border:none;
      border-radius:999px;
      background:#111827;
      color:var(--muted);
      font-size:9px;
      width:16px;
      height:14px;
      cursor:pointer;
      padding:0;
      line-height:1;
    }

    .log{
      margin-top:8px;
      padding-top:6px;
      border-top:1px solid var(--border);
      font-size:11px;
      max-height:120px;
      overflow-y:auto;
      color:var(--muted);
    }

    /* OVERLAYS */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.85);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .overlay.show{display:flex;}

    .winner-card{
      width:100%;
      max-width:420px;
      border-radius:18px;
      border:1px solid rgba(250,204,21,.6);
      background:radial-gradient(circle at top,#1e293b 0,#020617 50%,#000 100%);
      padding:14px 16px 18px;
      box-shadow:0 0 40px rgba(250,204,21,.8);
      text-align:center;
      position:relative;
    }
    .winner-heading{
      font-size:20px;
      font-weight:900;
      letter-spacing:.25em;
      text-transform:uppercase;
      color:var(--gold);
      text-shadow:0 0 14px rgba(250,204,21,1);
      margin-bottom:6px;
    }
    .winner-name{
      font-size:18px;
      font-weight:800;
      margin-bottom:4px;
    }
    .winner-meta{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .winner-actions{
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .winner-actions button{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:#020617;
      font-size:11px;
      padding:6px 10px;
      cursor:pointer;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .winner-luna-sticker{
      position:absolute;
      right:-6px;
      bottom:-6px;
      width:96px;
      height:96px;
      opacity:.95;
    }
    .winner-luna-sticker img{
      width:100%;
      height:100%;
      object-fit:contain;
    }

    .finish-card{
      width:100%;
      max-width:460px;
      border-radius:18px;
      border:1px solid var(--border);
      background:var(--panel);
      padding:14px 16px 18px;
      box-shadow:0 0 30px rgba(0,0,0,.9);
      font-size:12px;
    }
    .finish-title{
      font-size:14px;
      font-weight:700;
      margin-bottom:4px;
    }
    .finish-sub{
      font-size:11px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .finish-field{
      margin-bottom:8px;
      text-align:left;
    }
    .finish-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-bottom:4px;
    }
    .finish-input-row{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .finish-input-row input[type="number"]{
      width:80px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      font-size:12px;
      padding:4px 8px;
    }
    .color-chips{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .color-chip{
      border-radius:999px;
      border:1px solid var(--border);
      padding:3px 8px;
      font-size:11px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.08em;
      opacity:.7;
    }
    .color-chip.active{
      opacity:1;
      border-color:var(--gold);
      box-shadow:0 0 10px rgba(250,204,21,.7);
    }
    .color-chip[data-color="W"]{background:#e5e7eb;color:#111827;}
    .color-chip[data-color="U"]{background:#0ea5e9;color:#e0f2fe;}
    .color-chip[data-color="B"]{background:#020617;color:#f9fafb;}
    .color-chip[data-color="R"]{background:#ef4444;color:#fef2f2;}
    .color-chip[data-color="G"]{background:#22c55e;color:#ecfdf5;}
    .color-chip[data-color="C"]{background:#9ca3af;color:#020617;}

    .queue-choice{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .queue-chip{
      border-radius:999px;
      border:1px solid var(--border);
      padding:4px 10px;
      font-size:11px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.1em;
      opacity:.7;
    }
    .queue-chip.active{
      opacity:1;
      border-color:var(--blue);
      box-shadow:0 0 10px rgba(56,189,248,.8);
      color:var(--blue);
    }
    .finish-actions{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-top:8px;
    }
    .finish-actions button{
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--muted);
      font-size:11px;
      padding:6px 10px;
      text-transform:uppercase;
      letter-spacing:.12em;
      cursor:pointer;
    }
    .finish-actions button.primary{
      border-color:var(--gold);
      color:var(--gold);
    }

    /* Player card overlay */
    #playerCardOverlay .finish-card{
      max-width:420px;
    }

    @media(max-width:768px){
      .reel-symbol{
        font-size:13px;
        min-width:50px;
      }
      /* Hide Slot Wins and W/L on tiny screens */
      .leaderboard-table th:nth-child(4),
      .leaderboard-table td:nth-child(4),
      .leaderboard-table th:nth-child(5),
      .leaderboard-table td:nth-child(5){
        display:none;
      }
      .leaderboard-wrapper{
        max-height:210px;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="header-left">
      <div class="title">CARLO SLOT</div>
      <div class="subtitle">Viewer Deck Machine</div>
      <div class="event-selector">
        Event:
        <span id="eventChips"></span>
      </div>
    </div>
    <div class="header-right">
      <div class="spin-meta">
        Spins: <span id="spinCount">0</span> ¬∑ Dead streak: <span id="deadStreak">0</span>
      </div>
      <div class="spin-meta">
        Players: <span id="playerCount">0</span> / 99 ¬∑ Ticket cap: 300 ¬∑ Pity max: 7 tokens
      </div>
      <div class="theme-toggle">
        Theme:
        <div class="theme-chip" data-color="W">W</div>
        <div class="theme-chip" data-color="U">U</div>
        <div class="theme-chip" data-color="B">B</div>
        <div class="theme-chip" data-color="R">R</div>
        <div class="theme-chip" data-color="G">G</div>
      </div>
    </div>
  </header>

  <main>
    <section class="slot-panel">
      <div class="slot-header">
        <div class="slot-title">Five-Reel Viewer Slot</div>
        <div class="spin-meta" id="statusText">Add players, then spin.</div>
      </div>

      <div class="reels-box">
        <div class="reel-labels">
          <span>C</span><span>A</span><span>R</span><span>L</span><span>O</span>
        </div>
        <div class="reels" id="reels">
          <div class="reel"><div class="reel-inner"><div class="reel-symbol letter">C</div></div></div>
          <div class="reel"><div class="reel-inner"><div class="reel-symbol letter">A</div></div></div>
          <div class="reel"><div class="reel-inner"><div class="reel-symbol letter">R</div></div></div>
          <div class="reel"><div class="reel-inner"><div class="reel-symbol letter">L</div></div></div>
          <div class="reel"><div class="reel-inner"><div class="reel-symbol letter">O</div></div></div>
        </div>
      </div>

      <div class="slot-controls">
        <div class="lever-area">
          <div class="lever" id="lever"><div class="lever-knob"></div></div>
          <button id="spinButton" class="spin-button">Spin</button>
        </div>
        <div class="status-text" id="smallStatus"></div>
      </div>
    </section>

    <section class="leaderboard-panel">
      <div class="leaderboard-header">
        <span>Live Queue & Odds</span>
        <span style="font-size:11px;color:var(--muted);">Click +/‚àí on each reel to tweak tickets.</span>
      </div>

      <form class="add-player-form" id="addPlayerForm">
        <input type="text" id="playerNameInput" placeholder="Add viewer name‚Ä¶" autocomplete="off" />
        <button type="submit">Add</button>
      </form>

      <div class="leaderboard-wrapper">
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>Player</th>
              <th>Total Tickets</th>
              <th>Pity</th>
              <th>Slot Wins</th>
              <th>W/L</th>
              <th>Reel Tickets</th>
            </tr>
          </thead>
          <tbody id="leaderboardBody"></tbody>
        </table>
      </div>

      <div class="log" id="log"></div>
    </section>
  </main>

  <!-- Winner Overlay -->
  <div class="overlay" id="winnerOverlay">
    <div class="winner-card">
      <div class="winner-heading" id="winnerHeading">WINNER</div>
      <div class="winner-name" id="winnerName"></div>
      <div class="winner-meta" id="winnerMeta"></div>
      <div class="winner-actions">
        <button id="winnerPlayBtn">Play Deck</button>
        <button id="winnerSkipBtn">Skip / Remove</button>
      </div>
      <div class="winner-luna-sticker" id="winnerLunaSticker" style="display:none;">
        <img src="https://i.ibb.co/23vVSmXN/LunaGG.png" alt="Luna" />
      </div>
    </div>
  </div>

  <!-- Finish Run Overlay -->
  <div class="overlay" id="finishOverlay">
    <div class="finish-card">
      <div class="finish-title">Report Deck Run</div>
      <div class="finish-sub" id="finishPlayerLabel"></div>

      <div class="finish-field">
        <div class="finish-label">Games this run</div>
        <div class="finish-input-row">
          <label>Wins
            <input type="number" id="runWins" min="0" value="0" />
          </label>
          <label>Losses
            <input type="number" id="runLosses" min="0" value="1" />
          </label>
        </div>
      </div>

      <div class="finish-field">
        <div class="finish-label">Deck Color Identity</div>
        <div class="color-chips" id="colorChips">
          <div class="color-chip" data-color="W">W</div>
          <div class="color-chip" data-color="U">U</div>
          <div class="color-chip" data-color="B">B</div>
          <div class="color-chip" data-color="R">R</div>
          <div class="color-chip" data-color="G">G</div>
          <div class="color-chip" data-color="C">C</div>
        </div>
      </div>

      <div class="finish-field">
        <div class="finish-label">Re-add player to queue?</div>
        <div class="queue-choice" id="queueChoice">
          <div class="queue-chip active" data-choice="yes">Yes</div>
          <div class="queue-chip" data-choice="no">No</div>
        </div>
      </div>

      <div class="finish-actions">
        <button id="finishCancelBtn">Cancel</button>
        <button class="primary" id="finishSaveBtn">Save & Continue</button>
      </div>
    </div>
  </div>

  <!-- Player Card Overlay -->
  <div class="overlay" id="playerCardOverlay">
    <div class="finish-card">
      <div class="finish-title" id="pcName"></div>
      <div class="finish-sub" id="pcStatus"></div>
      <div id="pcDeckList" style="max-height:180px;overflow:auto;margin-bottom:8px;"></div>
      <div class="finish-actions">
        <button class="primary" id="pcCloseBtn">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const TICKET_CAP = 300;
  const MAX_PLAYERS = 99;
  const MAX_EVENTS = 7;
  const MAX_PITY_TOKENS = 7;
  const PITY_POINTS_PER_TOKEN = 300;
  const LUNA_SPIN_CHANCE = 1/35;
  const CARLO_LETTERS = ['C','A','R','L','O'];

  const state = {
    currentEventIndex: 1,
    events: {}
  };

  const reelsEl = document.getElementById('reels');
  const spinBtn = document.getElementById('spinButton');
  const leverEl = document.getElementById('lever');
  const statusText = document.getElementById('statusText');
  const smallStatus = document.getElementById('smallStatus');
  const spinCountEl = document.getElementById('spinCount');
  const deadStreakEl = document.getElementById('deadStreak');
  const playerCountEl = document.getElementById('playerCount');
  const leaderboardBody = document.getElementById('leaderboardBody');
  const logEl = document.getElementById('log');
  const eventChipsEl = document.getElementById('eventChips');

  const winnerOverlay = document.getElementById('winnerOverlay');
  const winnerHeading = document.getElementById('winnerHeading');
  const winnerNameEl = document.getElementById('winnerName');
  const winnerMetaEl = document.getElementById('winnerMeta');
  const winnerPlayBtn = document.getElementById('winnerPlayBtn');
  const winnerSkipBtn = document.getElementById('winnerSkipBtn');
  const winnerLunaSticker = document.getElementById('winnerLunaSticker');

  const finishOverlay = document.getElementById('finishOverlay');
  const finishPlayerLabel = document.getElementById('finishPlayerLabel');
  const runWinsInput = document.getElementById('runWins');
  const runLossesInput = document.getElementById('runLosses');
  const colorChips = document.getElementById('colorChips');
  const queueChoice = document.getElementById('queueChoice');
  const finishCancelBtn = document.getElementById('finishCancelBtn');
  const finishSaveBtn = document.getElementById('finishSaveBtn');

  const playerCardOverlay = document.getElementById('playerCardOverlay');
  const pcName = document.getElementById('pcName');
  const pcStatus = document.getElementById('pcStatus');
  const pcDeckList = document.getElementById('pcDeckList');
  const pcCloseBtn = document.getElementById('pcCloseBtn');

  const themeChips = document.querySelectorAll('.theme-chip');

  let selectedColorSet = new Set();
  let readdChoice = 'yes';
  let pendingWinner = null;
  let pendingWinnerReason = null;

  function log(msg){
    const time = new Date().toLocaleTimeString();
    const div = document.createElement('div');
    div.textContent = `[${time}] ${msg}`;
    logEl.prepend(div);
  }

  function currentEvent(){
    if(!state.events[state.currentEventIndex]){
      state.events[state.currentEventIndex] = {
        players: [],
        spinCount: 0,
        deadSpinStreak: 0,
        currentRun: null
      };
    }
    return state.events[state.currentEventIndex];
  }

  function clampPlayer(player){
    let changed = false;
    for(let i=0;i<5;i++){
      if(player.tickets[i] < 1){ player.tickets[i] = 1; changed = true; }
      if(player.tickets[i] > TICKET_CAP){ player.tickets[i] = TICKET_CAP; changed = true; }
    }
    if(player.pityTokens < 0){ player.pityTokens = 0; changed = true; }
    if(player.pityTokens > MAX_PITY_TOKENS){ player.pityTokens = MAX_PITY_TOKENS; changed = true; }
    if(player.pityPoints < 0){ player.pityPoints = 0; changed = true; }
    if(player.pityPoints >= PITY_POINTS_PER_TOKEN){
      while(player.pityPoints >= PITY_POINTS_PER_TOKEN && player.pityTokens < MAX_PITY_TOKENS){
        player.pityPoints -= PITY_POINTS_PER_TOKEN;
        player.pityTokens++;
        changed = true;
      }
      if(player.pityPoints < 0){ player.pityPoints = 0; changed = true; }
    }
    if(changed){
      log(`DIAGNOSTIC: corrected state for ${player.name}.`);
    }
  }

  function totalTickets(player){
    return player.tickets.reduce((a,b)=>a+b,0);
  }

  function renderEvents(){
    eventChipsEl.innerHTML = '';
    for(let i=1;i<=MAX_EVENTS;i++){
      const span = document.createElement('span');
      span.className = 'event-chip' + (state.currentEventIndex === i ? ' active' : '');
      span.textContent = i;
      span.dataset.index = i;
      eventChipsEl.appendChild(span);
    }
  }

  function renderLeaderboard(){
    const evt = currentEvent();
    const players = evt.players;

    leaderboardBody.innerHTML = '';
    const sorted = players.slice().sort((a,b)=>totalTickets(b)-totalTickets(a));

    for(const p of sorted){
      clampPlayer(p);
      const tr = document.createElement('tr');
      tr.className = 'player-row';

      const tdName = document.createElement('td');
      tdName.innerHTML = p.name + (p.status !== 'active'
        ? " <span style='color:var(--red);font-size:10px;'>(AFK)</span>"
        : "");

      const tdTotal = document.createElement('td');
      tdTotal.textContent = totalTickets(p);

      const tdPity = document.createElement('td');
      const pityIcon = p.pityTokens > 0 ? 'ü•£' : '';
      const pityText = p.pityTokens > 0 ? p.pityTokens : '';
      tdPity.innerHTML = `${pityIcon} <span class="pity-count">${pityText}</span>`;

      const tdWins = document.createElement('td');
      tdWins.textContent = p.slotWins;

      const tdWL = document.createElement('td');
      tdWL.textContent = `${p.overallWins}/${p.overallLosses}`;

      const tdReels = document.createElement('td');
      tdReels.className = 'reel-tickets-cell';

      p.tickets.forEach((val, idx)=>{
        const box = document.createElement('div');
        box.className = 'reel-ticket';
        const label = document.createElement('label');
        label.textContent = ['C','A','R','L','O'][idx];

        const up = document.createElement('button');
        up.textContent = '+';
        up.addEventListener('click',(e)=>{
          e.stopPropagation();
          adjustTicket(p.id, idx, +1);
        });

        const down = document.createElement('button');
        down.textContent = '-';
        down.addEventListener('click',(e)=>{
          e.stopPropagation();
          adjustTicket(p.id, idx, -1);
        });

        const span = document.createElement('span');
        span.textContent = val;

        box.appendChild(up);
        box.appendChild(span);
        box.appendChild(down);
        box.appendChild(label);
        tdReels.appendChild(box);
      });

      tr.appendChild(tdName);
      tr.appendChild(tdTotal);
      tr.appendChild(tdPity);
      tr.appendChild(tdWins);
      tr.appendChild(tdWL);
      tr.appendChild(tdReels);

      leaderboardBody.appendChild(tr);
    }

    spinCountEl.textContent = evt.spinCount;
    deadStreakEl.textContent = evt.deadSpinStreak;
    playerCountEl.textContent = evt.players.length;
  }

  function saveAll(){
    try{
      const data = JSON.stringify(state);
      localStorage.setItem('carlo_slot_events', data);
    }catch(e){
      console.warn("Save failed", e);
    }
  }

  function loadAll(){
    try{
      const raw = localStorage.getItem('carlo_slot_events');
      if(!raw) return;
      const parsed = JSON.parse(raw);
      if(!parsed || typeof parsed !== 'object') return;
      if(parsed.events) state.events = parsed.events;
      if(parsed.currentEventIndex) state.currentEventIndex = parsed.currentEventIndex;

      Object.values(state.events).forEach(evt=>{
        if(Array.isArray(evt.players)){
          evt.players.forEach(p=>clampPlayer(p));
        }
      });

      log("Loaded saved events.");
    }catch(e){
      console.warn("Load failed", e);
    }
  }

  function ensureEvent(){
    currentEvent();
    renderEvents();
    renderLeaderboard();
    saveAll();
  }

  function addPlayer(name){
    const evt = currentEvent();
    name = name.trim();
    if(!name) return;
    if(evt.players.length >= MAX_PLAYERS){
      alert("Player limit reached (99). Remove someone or switch event.");
      return;
    }
    if(evt.players.find(p=>p.name.toLowerCase() === name.toLowerCase())){
      alert("Player already in queue.");
      return;
    }
    const now = Date.now();
    const p = {
      id:'p_'+state.currentEventIndex+'_'+now+'_'+Math.random().toString(16).slice(2),
      name,
      tickets:[1,1,1,1,1],
      pityTokens:0,
      pityPoints:0,
      slotWins:0,
      overallWins:0,
      overallLosses:0,
      decks:[],
      status:'active',
      createdAt:now,
      lastUpdated:now
    };
    evt.players.push(p);
    log(`Added player ${name} to event ${state.currentEventIndex}.`);
    renderLeaderboard();
    saveAll();
  }

  function randomWeightedPlayer(reelIndex){
    const evt = currentEvent();
    const candidates = evt.players.filter(p=>p.status==='active');
    if(candidates.length === 0) return null;
    let total = 0;
    for(const p of candidates){
      total += p.tickets[reelIndex];
    }
    if(total <= 0) return null;
    let r = Math.random()*total;
    for(const p of candidates){
      r -= p.tickets[reelIndex];
      if(r <= 0) return p;
    }
    return candidates[candidates.length-1];
  }

  function setReels(display){
    const reelEls = reelsEl.querySelectorAll('.reel');
    reelEls.forEach((reelEl, idx)=>{
      reelEl.classList.remove('glow-win','glow-luna');
      const inner = reelEl.querySelector('.reel-inner');
      inner.innerHTML = '';
      const sym = display[idx];
      const div = document.createElement('div');
      if(sym.type === 'player'){
        div.className = 'reel-symbol player';
        div.textContent = sym.name;
      }else if(sym.type === 'letter'){
        div.className = 'reel-symbol letter';
        div.textContent = sym.letter;
      }else if(sym.type === 'luna'){
        div.className = 'reel-symbol luna';
        const img = document.createElement('img');
        img.src = "https://i.ibb.co/8g6ZQM5C/IMG-2604.png";
        img.alt = "Luna";
        div.appendChild(img);
      }else{
        div.className = 'reel-symbol letter';
        div.textContent = '?';
      }
      inner.appendChild(div);
    });
  }

  function spinAnimationStart(){
    const reelEls = reelsEl.querySelectorAll('.reel');
    reelEls.forEach(reelEl=>reelEl.classList.add('spinning'));
  }
  function spinAnimationStop(){
    const reelEls = reelsEl.querySelectorAll('.reel');
    reelEls.forEach(reelEl=>reelEl.classList.remove('spinning'));
  }

  function findPityAutoPick(){
    const evt = currentEvent();
    const candidates = evt.players.filter(p=>p.status==='active' && p.pityTokens >= MAX_PITY_TOKENS);
    if(candidates.length === 0) return null;
    candidates.sort((a,b)=>{
      const diff = totalTickets(b)-totalTickets(a);
      if(diff !== 0) return diff;
      return a.createdAt - b.createdAt;
    });
    return candidates[0];
  }

  function applyPityOverflow(player, overflow){
    if(overflow <= 0) return;
    player.pityTokens = Math.min(MAX_PITY_TOKENS, player.pityTokens + 1);
    player.pityPoints += overflow;
    while(player.pityPoints >= PITY_POINTS_PER_TOKEN && player.pityTokens < MAX_PITY_TOKENS){
      player.pityPoints -= PITY_POINTS_PER_TOKEN;
      player.pityTokens++;
    }
    if(player.pityPoints < 0) player.pityPoints = 0;
  }

  function doubleTicketsAllReels(player){
    for(let i=0;i<5;i++){
      const raw = player.tickets[i]*2;
      if(raw <= TICKET_CAP){
        player.tickets[i] = raw;
      }else{
        const overflow = raw - TICKET_CAP;
        player.tickets[i] = TICKET_CAP;
        applyPityOverflow(player, overflow);
      }
    }
    clampPlayer(player);
  }

  function halfTicketOnReel(player, reelIndex){
    let val = player.tickets[reelIndex];
    val = Math.floor(val/2);
    if(val < 1) val = 1;
    player.tickets[reelIndex] = val;
    clampPlayer(player);
  }

  function handleDeadSpin(reelResults){
    const evt = currentEvent();
    evt.deadSpinStreak++;
    smallStatus.textContent = `Dead spin. Streak: ${evt.deadSpinStreak}`;
    log(`Dead spin (streak ${evt.deadSpinStreak}).`);

    const counts = new Map();
    const appearReels = new Map();
    for(let i=0;i<reelResults.length;i++){
      const sym = reelResults[i];
      if(sym.type === 'player' && sym.playerId){
        const prev = counts.get(sym.playerId) || 0;
        counts.set(sym.playerId, prev+1);
        const arr = appearReels.get(sym.playerId) || [];
        arr.push(i);
        appearReels.set(sym.playerId, arr);
      }
    }

    for(const p of evt.players){
      if(p.status !== 'active') continue;
      const c = counts.get(p.id) || 0;
      if(c === 0){
        doubleTicketsAllReels(p);
      }else if(c === 1){
        const arr = appearReels.get(p.id) || [];
        if(arr.length === 1){
          halfTicketOnReel(p, arr[0]);
        }
      }
    }
  }

  function handleWinner(player, opts){
    const evt = currentEvent();
    const { reason, hits } = opts || {};
    evt.deadSpinStreak = 0;

    if(reason === 'pity'){
      smallStatus.textContent = `${player.name} wins with 7 Pity Tokens!`;
      log(`${player.name} wins with 7 Pity Tokens (auto-pick).`);
    }else if(reason === 'carlo'){
      smallStatus.textContent = `CARLO jackpot! Streamer plays their own deck.`;
      log(`CARLO jackpot.`);
      renderLeaderboard();
      saveAll();
      return;
    }else if(reason === 'luna'){
      smallStatus.textContent = `${player.name} wins with Luna Luck!`;
      log(`${player.name} wins with Luna Luck!`);
    }else if(reason === 'forced'){
      smallStatus.textContent = `${player.name} wins (forced pick to keep queue moving).`;
      log(`${player.name} chosen as forced winner after long dead streak.`);
    }else{
      smallStatus.textContent = `${player.name} wins the spin.`;
      log(`Spin winner: ${player.name} (${hits} hits).`);
    }

    player.slotWins++;
    player.status = 'afk';
    player.pityTokens = 0;
    player.pityPoints = 0;

    pendingWinner = player;
    pendingWinnerReason = reason || 'normal';

    winnerNameEl.textContent = player.name;
    winnerLunaSticker.style.display = (reason === 'luna') ? 'block' : 'none';

    if(reason === 'luna'){
      winnerHeading.textContent = 'LUNA LUCK!';
      winnerMetaEl.textContent = `${player.name} wins with Luna Luck!`;
    }else if(reason === 'pity'){
      winnerHeading.textContent = 'FATE PICK';
      winnerMetaEl.textContent = `${player.name} reached 7 pity tokens and is chosen automatically.`;
    }else if(reason === 'forced'){
      winnerHeading.textContent = 'FORCED PICK';
      winnerMetaEl.textContent = `${player.name} was chosen to avoid too many dead spins.`;
    }else{
      winnerHeading.textContent = 'WINNER';
      if(hits >= 5){
        winnerMetaEl.textContent = `${player.name} hit 5 symbols ‚Äì streamer can give TWO extra lives on this run.`;
      }else if(hits === 4){
        winnerMetaEl.textContent = `${player.name} hit 4 symbols ‚Äì streamer can give ONE extra life on this run.`;
      }else{
        winnerMetaEl.textContent = `${player.name}'s deck is up next.`;
      }
    }

    winnerOverlay.classList.add('show');
  }

  function finishRunPrompt(player){
    const evt = currentEvent();
    evt.currentRun = { playerId: player.id, colorCode:null, wins:0, losses:0 };
    runWinsInput.value = "0";
    runLossesInput.value = "1";
    selectedColorSet = new Set();
    Array.from(colorChips.children).forEach(ch=>ch.classList.remove('active'));
    readdChoice = 'yes';
    Array.from(queueChoice.children).forEach(ch=>{
      ch.classList.toggle('active', ch.dataset.choice === 'yes');
    });
    finishPlayerLabel.textContent = `Reporting run for ${player.name}`;
    finishOverlay.classList.add('show');
  }

  function colorCodeFromSet(){
    const arr = Array.from(selectedColorSet);
    arr.sort();
    return arr.join('') || null;
  }

  function applyRunSave(){
    const evt = currentEvent();
    if(!evt.currentRun){
      finishOverlay.classList.remove('show');
      return;
    }
    const player = evt.players.find(p=>p.id === evt.currentRun.playerId);
    if(!player){
      evt.currentRun = null;
      finishOverlay.classList.remove('show');
      return;
    }
    const wins = parseInt(runWinsInput.value,10) || 0;
    const losses = parseInt(runLossesInput.value,10) || 0;
    let colorCode = colorCodeFromSet();
    if(!colorCode) colorCode = 'C';

    let deck = player.decks.find(d=>d.colorCode === colorCode);
    if(!deck){
      if(player.decks.length >= 10){
        alert("Deck cap reached (10). Reuse a color identity or clear one first.");
      }else{
        deck = { colorCode, wins:0, losses:0, totalRuns:0 };
        player.decks.push(deck);
      }
    }
    if(deck){
      deck.wins += wins;
      deck.losses += losses;
      deck.totalRuns += 1;
    }
    player.overallWins += wins;
    player.overallLosses += losses;

    if(readdChoice === 'yes'){
      player.tickets = [1,1,1,1,1];
      player.pityTokens = 0;
      player.pityPoints = 0;
      player.status = 'active';
      log(`Re-added ${player.name} to queue as ${colorCode} deck.`);
    }else{
      player.status = 'afk';
      log(`${player.name} left AFK with stats saved.`);
    }

    evt.currentRun = null;
    finishOverlay.classList.remove('show');
    renderLeaderboard();
    saveAll();
  }

  function adjustTicket(playerId, reelIndex, delta){
    const evt = currentEvent();
    const p = evt.players.find(pp=>pp.id===playerId);
    if(!p) return;
    let v = p.tickets[reelIndex] + delta;
    if(v < 1) v = 1;
    if(v > TICKET_CAP) v = TICKET_CAP;
    p.tickets[reelIndex] = v;
    p.lastUpdated = Date.now();
    clampPlayer(p);
    renderLeaderboard();
    saveAll();
  }

  /* Pick forced winner after long dead streak.
     Mix of uniform + ticket-weighted so it's not always the top dog. */
  function pickForcedWinner(){
    const evt = currentEvent();
    const active = evt.players.filter(p=>p.status === 'active');
    if(active.length === 0) return null;
    const roll = Math.random();
    if(roll < 0.5){
      // Uniform random
      return active[Math.floor(Math.random()*active.length)];
    }else{
      // Weighted by total tickets
      let sum = 0;
      const weights = active.map(p=>{
        const w = Math.max(1,totalTickets(p));
        sum += w;
        return w;
      });
      if(sum <= 0) return active[Math.floor(Math.random()*active.length)];
      let r = Math.random()*sum;
      for(let i=0;i<active.length;i++){
        r -= weights[i];
        if(r <= 0) return active[i];
      }
      return active[active.length-1];
    }
  }

  function performSpin(){
    const evt = currentEvent();

    if(evt.currentRun){
      smallStatus.textContent = "Finish current run before spinning again.";
      finishOverlay.classList.add('show');
      return;
    }

    // Pity auto-pick BEFORE spinning
    const pityPick = findPityAutoPick();
    if(pityPick){
      evt.spinCount++;
      handleWinner(pityPick, {reason:'pity', hits:3});
      renderLeaderboard();
      saveAll();
      return;
    }

    const activePlayers = evt.players.filter(p=>p.status==='active');
    if(activePlayers.length === 0){
      smallStatus.textContent = "No active players. Add someone first.";
      return;
    }

    spinBtn.disabled = true;
    leverEl.classList.add('pull');
    spinAnimationStart();
    smallStatus.textContent = "Spinning‚Ä¶";

    setTimeout(()=>{
      leverEl.classList.remove('pull');
      spinAnimationStop();

      const reelResults = [];
      let lunaReelIndex = null;
      if(Math.random() < LUNA_SPIN_CHANCE){
        lunaReelIndex = Math.floor(Math.random()*5);
      }

      for(let r=0;r<5;r++){
        if(lunaReelIndex === r){
          reelResults.push({ type:'luna' });
          continue;
        }
        const letterChance = 0.08;
        if(Math.random() < letterChance){
          reelResults.push({ type:'letter', letter: CARLO_LETTERS[r] });
          continue;
        }
        const p = randomWeightedPlayer(r);
        if(p){
          reelResults.push({ type:'player', playerId:p.id, name:p.name });
        }else{
          reelResults.push({ type:'letter', letter:CARLO_LETTERS[r] });
        }
      }

      setReels(reelResults);

      let winner = null;
      let reason = null;
      let winnerHits = 0;

      // CARLO jackpot: all 5 letters in correct positions
      let carloHit = true;
      for(let i=0;i<5;i++){
        const sym = reelResults[i];
        if(!(sym.type === 'letter' && sym.letter === CARLO_LETTERS[i])){
          carloHit = false;
          break;
        }
      }
      if(carloHit){
        handleWinner({name:'CARLO'}, {reason:'carlo', hits:5});
        evt.spinCount++;
        evt.deadSpinStreak = 0;
        renderLeaderboard();
        saveAll();
        spinBtn.disabled = false;
        return;
      }

      // counts & Luna position
      const counts = new Map();
      const appearReels = new Map();
      let lunaIndex = -1;
      for (let i = 0; i < reelResults.length; i++) {
        const sym = reelResults[i];
        if (sym.type === 'player' && sym.playerId) {
          const prev = counts.get(sym.playerId) || 0;
          counts.set(sym.playerId, prev + 1);
          const arr = appearReels.get(sym.playerId) || [];
          arr.push(i);
          appearReels.set(sym.playerId, arr);
        } else if (sym.type === 'luna') {
          lunaIndex = i;
        }
      }

      // Luna Luck: 3-reel window (two of same player + Luna)
      let lunaWinner = null;
      let lunaWinnerHits = 0;

      if (lunaIndex >= 0) {
        const windows = [
          [0, 1, 2],
          [1, 2, 3],
          [2, 3, 4]
        ];
        const candidates = [];

        for (const [a, b, c] of windows) {
          const triple = [reelResults[a], reelResults[b], reelResults[c]];

          const lunas = triple.filter(s => s.type === 'luna').length;
          if (lunas !== 1) continue;

          const playersInTriple = triple.filter(
            s => s.type === 'player' && s.playerId
          );
          if (playersInTriple.length !== 2) continue;

          const id1 = playersInTriple[0].playerId;
          const id2 = playersInTriple[1].playerId;
          if (id1 !== id2) continue;

          const p = evt.players.find(
            pp => pp.id === id1 && pp.status === 'active'
          );
          if (!p) continue;

          candidates.push(p);
        }

        if (candidates.length > 0) {
          const uniq = new Map();
          candidates.forEach(p => uniq.set(p.id, p));
          const arr = Array.from(uniq.values());
          arr.sort((a, b) => totalTickets(b) - totalTickets(a));
          lunaWinner = arr[0];
          lunaWinnerHits = 3;
        }
      }

      if (lunaWinner) {
        winner = lunaWinner;
        reason = 'luna';
        winnerHits = lunaWinnerHits;
        const reelEls = reelsEl.querySelectorAll('.reel');
        if (lunaIndex >= 0 && reelEls[lunaIndex]) {
          reelEls[lunaIndex].classList.add('glow-luna');
        }
      } else {
        const eligible = [];
        counts.forEach((cnt, pid) => {
          if (cnt >= 3) {
            const p = evt.players.find(
              pp => pp.id === pid && pp.status === 'active'
            );
            if (p) eligible.push({ player: p, hits: cnt });
          }
        });
        if (eligible.length > 0) {
          eligible.sort((a, b) => {
            const diffTickets =
              totalTickets(b.player) - totalTickets(a.player);
            if (diffTickets !== 0) return diffTickets;
            return b.hits - a.hits;
          });
          winner = eligible[0].player;
          winnerHits = eligible[0].hits;
          reason = 'normal';
        }
      }

      // If still no winner: decide between real dead spin vs forced winner
      if(!winner){
        const prevDead = evt.deadSpinStreak; // before this spin

        let force = false;
        if(prevDead <= 1){
          force = false;          // allow 0‚Äì1 dead spins normally
        }else if(prevDead === 2){
          if(Math.random() < 0.5) force = true;  // ~3rd spin: 50%
        }else if(prevDead === 3){
          if(Math.random() < 0.75) force = true; // ~4th spin: 75%
        }else{
          force = true;           // 5+ ‚Üí always force
        }

        if(force){
          const forcedWinner = pickForcedWinner();
          if(forcedWinner){
            winner = forcedWinner;
            reason = 'forced';
            // effective hits for overlay only
            const roll = Math.random();
            if(roll < 0.1) winnerHits = 5;
            else if(roll < 0.3) winnerHits = 4;
            else winnerHits = 3;
          }
        }
      }

      if(winner){
        evt.deadSpinStreak = 0;

        // Ticket adjustments for others (zero-hit double / one-hit half)
        for(const p of evt.players){
          if(p.status !== 'active') continue;
          if(p.id === winner.id) continue;
          const c = counts.get(p.id) || 0;
          if(c === 0){
            doubleTicketsAllReels(p);
          }else if(c === 1){
            const arr = appearReels.get(p.id) || [];
            if(arr.length === 1){
              halfTicketOnReel(p, arr[0]);
            }
          }
        }

        handleWinner(winner, {reason, hits:winnerHits});
      }else{
        // True dead spin
        handleDeadSpin(reelResults);
      }

      evt.spinCount++;
      renderLeaderboard();
      saveAll();
      spinBtn.disabled = false;
    }, 550);
  }

  // Add-player form
  document.getElementById('addPlayerForm').addEventListener('submit', e=>{
    e.preventDefault();
    const inp = document.getElementById('playerNameInput');
    addPlayer(inp.value);
    inp.value = '';
  });

  // Spin controls
  spinBtn.addEventListener('click', ()=>performSpin());
  leverEl.addEventListener('click', ()=>{ if(!spinBtn.disabled) performSpin(); });

  // Event selector
  eventChipsEl.addEventListener('click', e=>{
    const chip = e.target.closest('.event-chip');
    if(!chip) return;
    const idx = parseInt(chip.dataset.index,10);
    if(!idx || idx === state.currentEventIndex) return;
    state.currentEventIndex = idx;
    log(`Switched to event ${idx}.`);
    renderEvents();
    renderLeaderboard();
    saveAll();
  });

  // Winner overlay buttons
  winnerPlayBtn.addEventListener('click', ()=>{
    if(!pendingWinner){
      winnerOverlay.classList.remove('show');
      return;
    }
    const p = pendingWinner;
    pendingWinner = null;
    winnerOverlay.classList.remove('show');
    finishRunPrompt(p);
  });

  winnerSkipBtn.addEventListener('click', ()=>{
    const evt = currentEvent();
    if(pendingWinner){
      log(`Winner ${pendingWinner.name} skipped / removed from queue.`);
      const idx = evt.players.findIndex(x=>x.id===pendingWinner.id);
      if(idx >= 0) evt.players.splice(idx,1);
    }
    pendingWinner = null;
    winnerOverlay.classList.remove('show');
    renderLeaderboard();
    saveAll();
  });

  // Finish run overlay
  colorChips.addEventListener('click', e=>{
    const chip = e.target.closest('.color-chip');
    if(!chip) return;
    const c = chip.dataset.color;
    if(selectedColorSet.has(c)){
      selectedColorSet.delete(c);
      chip.classList.remove('active');
    }else{
      selectedColorSet.add(c);
      chip.classList.add('active');
    }
  });

  queueChoice.addEventListener('click', e=>{
    const chip = e.target.closest('.queue-chip');
    if(!chip) return;
    readdChoice = chip.dataset.choice;
    Array.from(queueChoice.children).forEach(ch=>{
      ch.classList.toggle('active', ch === chip);
    });
  });

  finishCancelBtn.addEventListener('click', ()=>{
    finishOverlay.classList.remove('show');
  });

  finishSaveBtn.addEventListener('click', ()=>{
    applyRunSave();
  });

  // Player card overlay: click row
  leaderboardBody.addEventListener('click', e=>{
    const row = e.target.closest('tr');
    if(!row) return;
    const nameCell = row.querySelector('td');
    if(!nameCell) return;
    const rawName = nameCell.textContent;
    const name = rawName.replace('(AFK)','').trim();
    const evt = currentEvent();
    const p = evt.players.find(pp => pp.name === name);
    if(!p) return;

    pcName.textContent = p.name;
    pcStatus.textContent = (p.status === 'active')
      ? "Active in queue"
      : "AFK (deck already played)";

    pcDeckList.innerHTML = '';
    if(p.decks.length === 0){
      pcDeckList.innerHTML = "<div style='color:var(--muted);font-size:12px;'>No tracked decks yet.</div>";
    }else{
      p.decks.forEach(d=>{
        const div = document.createElement('div');
        div.style = "border:1px solid var(--border);padding:6px 8px;margin-bottom:4px;border-radius:8px;";
        div.innerHTML = `
          <strong>Color:</strong> ${d.colorCode}<br>
          <strong>Runs:</strong> ${d.totalRuns}<br>
          <strong>Wins/Losses:</strong> ${d.wins}/${d.losses}
        `;
        pcDeckList.appendChild(div);
      });
    }

    playerCardOverlay.classList.add('show');
  });

  pcCloseBtn.addEventListener('click', ()=>{
    playerCardOverlay.classList.remove('show');
  });

  // Theme switcher
  function applyTheme(letter){
    const map = {
      'W':'white',
      'U':'blue',
      'B':'black',
      'R':'red',
      'G':'green'
    };
    const cls = map[letter] || 'blue';
    document.body.className = `theme-${cls}`;
    themeChips.forEach(c => c.classList.toggle('active', c.dataset.color === letter));
    localStorage.setItem('carlo_theme', letter);
  }

  themeChips.forEach(chip=>{
    chip.addEventListener('click', ()=>applyTheme(chip.dataset.color));
  });

  function loadTheme(){
    const saved = localStorage.getItem('carlo_theme') || 'U';
    applyTheme(saved);
  }

  // Init
  loadAll();
  ensureEvent();
  loadTheme();
})();
</script>
</body>
</html>