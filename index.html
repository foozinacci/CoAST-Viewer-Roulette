<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CARLO Viewer Slot Machine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#15100c;
      --panel:#0b0a09;
      --border:#3f2f19;
      --accent:#f9fafb;
      --blue:#38bdf8;
      --red:#fb4b4b;
      --green:#22c55e;
      --gold:#facc15;
      --text:#fef9c3;
      --muted:#d1bfa1;
      --danger:#f97373;
      --ok:#4ade80;
    }
    body.theme-white{
      --bg:#1f2937;
      --panel:#111827;
      --accent:#fefce8;
      --gold:#facc15;
      --blue:#60a5fa;
      --red:#f97373;
      --green:#4ade80;
      --text:#f9fafb;
      --muted:#e5e7eb;
    }
    body.theme-blue{
      --bg:#020617;
      --panel:#021a2b;
      --accent:#e0f2fe;
      --blue:#38bdf8;
      --red:#fb4b4b;
      --green:#22c55e;
      --gold:#facc15;
      --text:#e5e7eb;
      --muted:#9ca3af;
    }
    body.theme-black{
      --bg:#0a0e1c;
      --panel:#0d1524;
      --accent:#f9fafb;
      --gold:#eab308;
      --blue:#6366f1;
      --red:#fb4b4b;
      --green:#22c55e;
      --text:#f9fafb;
      --muted:#9ca3af;
    }
    body.theme-red{
      --bg:#3f0f12;
      --panel:#1f0507;
      --accent:#fee2e2;
      --gold:#fb923c;
      --blue:#22d3ee;
      --red:#ef4444;
      --green:#22c55e;
      --text:#fee2e2;
      --muted:#fecaca;
    }
    body.theme-green{
      --bg:#022c22;
      --panel:#051b15;
      --accent:#dcfce7;
      --gold:#facc15;
      --blue:#38bdf8;
      --red:#fb4b4b;
      --green:#22c55e;
      --text:#ecfdf5;
      --muted:#a7f3d0;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#3b1f0f 0,var(--bg) 45%,#000 100%);
      color:var(--text);
      display:flex;
      justify-content:center;
      min-height:100vh;
    }
    #app{
      width:100%;
      max-width:1200px;
      margin:8px;
      border-radius:18px;
      border:1px solid var(--border);
      background:linear-gradient(145deg,var(--bg) 0,var(--bg) 40%,#050816 100%);
      box-shadow:0 0 40px rgba(0,0,0,.8);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }
    header{
      padding:10px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .header-left{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .logo{
      width:40px;
      height:40px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--gold);
      box-shadow:0 0 12px rgba(250,204,21,.6);
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:contain;
    }
    .title-block{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .title{
      font-size:18px;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--gold);
      text-shadow:0 0 10px rgba(250,204,21,.55);
    }
    .subtitle{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      font-size:11px;
    }
    .spin-meta{
      font-size:11px;
      color:var(--muted);
    }
    .event-row{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .event-label{
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .event-chip{
      border-radius:999px;
      border:1px solid var(--border);
      padding:3px 8px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.08em;
      opacity:.6;
      background:var(--panel);
      color:var(--muted);
    }
    .event-chip.active{
      opacity:1;
      border-color:var(--blue);
      box-shadow:0 0 10px rgba(56,189,248,.7);
      color:var(--blue);
    }
    .theme-toggle{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .theme-chip{
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px solid var(--border);
      cursor:pointer;
      opacity:.7;
      display:flex;
      align-items:center;
      justify-content:center;
      background-color:transparent;
      background-repeat:no-repeat;
      background-position:center;
      background-size:contain;
      color:transparent;
      text-indent:-9999px;
    }
    .theme-chip.active{
      opacity:1;
      box-shadow:0 0 10px rgba(148,163,184,.9);
    }
    .theme-chip[data-color="W"]{background-image:url('https://i.ibb.co/sJpHH9VZ/W.png');}
    .theme-chip[data-color="U"]{background-image:url('https://i.ibb.co/0bPLHLk/U.png');}
    .theme-chip[data-color="B"]{background-image:url('https://i.ibb.co/nM1ZZz3z/B.png');}
    .theme-chip[data-color="R"]{background-image:url('https://i.ibb.co/NnjxnmZv/R.png');}
    .theme-chip[data-color="G"]{background-image:url('https://i.ibb.co/tM5Mb1Q0/G.png');}

    main{
      flex:1;
      display:flex;
      flex-direction:column;
      overflow:auto;
    }
    .slot-layout{
      display:grid;
      grid-template-columns:2.3fr 1.3fr;
      gap:10px;
      padding:10px;
    }
    @media(max-width:900px){
      .slot-layout{grid-template-columns:1fr;}
    }
    .slot-panel,.side-panel{
      background:radial-gradient(circle at top,var(--panel) 0,var(--bg) 50%,#000 100%);
      border-radius:16px;
      border:1px solid var(--border);
      padding:10px;
      position:relative;
      overflow:hidden;
    }
    .slot-panel::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at top,rgba(250,250,250,.04) 0,transparent 55%),radial-gradient(circle at center,rgba(56,189,248,.05) 0,transparent 55%),radial-gradient(circle at bottom,rgba(236,72,153,.07) 0,transparent 60%);
      opacity:.5;
      pointer-events:none;
    }
    .slot-header{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-bottom:6px;
      position:relative;
      z-index:1;
    }
    .slot-title{
      font-size:13px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    #statusText{
      font-size:11px;
      color:var(--muted);
    }
    .reels-shell{
      position:relative;
      padding:18px 18px 26px;
    }
    .bulb-row{
      position:absolute;
      left:20px;
      right:20px;
      height:8px;
      display:flex;
      justify-content:space-between;
      pointer-events:none;
    }
    .bulb-row.top{top:4px;}
    .bulb-row.bottom{bottom:4px;}
    .bulb-col{
      position:absolute;
      top:18px;
      bottom:22px;
      width:8px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      pointer-events:none;
    }
    .bulb-col.left{left:4px;}
    .bulb-col.right{right:4px;}
    .bulb{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#4b5563;
      box-shadow:0 0 4px rgba(0,0,0,.8);
    }
    .bulb.active{
      box-shadow:0 0 10px currentColor;
    }
    .reels-box{
      position:relative;
      border-radius:16px;
      border:2px solid rgba(148,116,72,.9);
      background:linear-gradient(180deg,#020617 0,#020617 40%,#000 100%);
      padding:10px 8px 14px;
      box-shadow:inset 0 0 18px rgba(15,23,42,.9),0 0 26px rgba(0,0,0,.9);
      overflow:hidden;
    }
    .reel-labels{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
      font-size:10px;
      color:var(--muted);
      letter-spacing:.18em;
      text-transform:uppercase;
    }
    .reels{display:flex;gap:6px;justify-content:space-between;}
    .reel{
      flex:1;
      background:radial-gradient(circle at top,#020617 0,#000 70%);
      border-radius:12px;
      border:1px solid rgba(148,116,72,.7);
      padding:16px 4px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      box-shadow:inset 0 0 18px rgba(15,23,42,.9),0 0 18px rgba(0,0,0,.9);
    }
    .reel-inner{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      transform:translateY(0);
      transition:transform .18s ease-out;
    }
    .reel-symbol{
      font-size:14px;
      font-weight:800;
      text-transform:uppercase;
      padding:4px 6px;
      border-radius:8px;
      min-width:64px;
      max-width:100%;
      text-align:center;
      box-shadow:0 0 10px rgba(15,23,42,.9);
      white-space:normal;
      line-height:1.1;
      word-break:break-word;
    }
    .reel-symbol.player{
      background:rgba(15,23,42,.95);
      border:1px solid rgba(248,250,252,.25);
      color:var(--accent);
      text-shadow:0 0 8px rgba(248,250,252,.7);
    }
    .reel-symbol.letter{
      background:rgba(15,23,42,.95);
      border:1px solid var(--gold);
      color:var(--gold);
      text-shadow:0 0 12px rgba(250,204,21,.9);
    }
    .reel-symbol.luna{
      background:rgba(15,23,42,.95);
      border:1px solid #f973fa;
      box-shadow:0 0 16px rgba(244,114,182,.9);
      color:#f9a8d4;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .reel-symbol.luna img{
      max-width:40px;
      max-height:40px;
      border-radius:999px;
      display:block;
    }
    .reel:nth-child(1) .reel-symbol.player{
      border-color:#fef9c3;
      box-shadow:0 0 12px rgba(250,250,209,.9);
      color:#fefce8;
    }
    .reel:nth-child(2) .reel-symbol.player{
      border-color:#38bdf8;
      box-shadow:0 0 12px rgba(56,189,248,.9);
      color:#e0f2fe;
    }
    .reel:nth-child(3) .reel-symbol.player{
      border-color:#4b5563;
      box-shadow:0 0 12px rgba(15,23,42,.95);
      color:#f9fafb;
    }
    .reel:nth-child(4) .reel-symbol.player{
      border-color:#fb4b4b;
      box-shadow:0 0 12px rgba(248,113,113,.9);
      color:#fee2e2;
    }
    .reel:nth-child(5) .reel-symbol.player{
      border-color:#22c55e;
      box-shadow:0 0 12px rgba(34,197,94,.9);
      color:#dcfce7;
    }
    .reel.glow-win{
      box-shadow:0 0 28px rgba(250,204,21,.8),inset 0 0 20px rgba(250,250,250,.1);
      border-color:var(--gold);
    }
    .reel.glow-carlo{
      box-shadow:0 0 26px rgba(56,189,248,.9),inset 0 0 20px rgba(15,23,42,.95);
      border-color:var(--blue);
    }
    .reel.glow-luna{
      box-shadow:0 0 24px rgba(244,114,182,.95),inset 0 0 18px rgba(24,24,27,.9);
      border-color:#f973fa;
    }
    @keyframes reelSpin{
      0%{transform:translateY(0);}
      100%{transform:translateY(-40%);}
    }
    .reel.spinning .reel-inner{animation:reelSpin .25s linear infinite;}
    .slot-controls{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      position:relative;
      z-index:1;
    }
    .status-text{font-size:11px;color:var(--muted);}
    .lever-area{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
    }
    .lever{
      width:22px;height:90px;
      border-radius:999px;
      background:linear-gradient(180deg,#111827 0,#020617 100%);
      border:1px solid #4b5563;
      position:relative;
      box-shadow:inset 0 0 8px rgba(15,23,42,.9),0 0 16px rgba(0,0,0,.8);
      cursor:pointer;
    }
    .lever-knob{
      width:26px;height:26px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#fee2e2 0,#f97373 35%,#7f1d1d 100%);
      border:2px solid #fef2f2;
      position:absolute;
      left:50%;transform:translateX(-50%);
      top:-13px;
      box-shadow:0 0 16px rgba(248,113,113,.85);
      transition:top .12s ease-out;
    }
    .lever.pull .lever-knob{top:58px;}
    .spin-button{
      border-radius:999px;
      padding:10px 30px;
      border:none;
      font-size:14px;
      font-weight:800;
      letter-spacing:.18em;
      text-transform:uppercase;
      cursor:pointer;
      background:radial-gradient(circle at top,#facc15 0,#eab308 40%,#b45309 100%);
      color:#0b1120;
      text-shadow:0 0 4px rgba(255,255,255,.65);
      box-shadow:0 0 18px rgba(250,204,21,.7),inset 0 0 6px rgba(250,250,250,.4);
      transition:transform .1s ease-out,box-shadow .1s ease-out,opacity .1s ease-out;
      margin:0 auto;
    }
    .spin-button:disabled{
      opacity:.45;
      cursor:default;
      box-shadow:0 0 6px rgba(15,23,42,.9);
    }
    .spin-button:active:not(:disabled){
      transform:translateY(1px) scale(.99);
      box-shadow:0 0 10px rgba(250,204,21,.7),inset 0 0 4px rgba(15,23,42,.9);
    }
    .side-panel-header{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      align-items:center;
    }
    .side-panel-section-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-bottom:4px;
    }
    .add-player-form{
      display:flex;
      gap:6px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .add-player-form input{
      flex:1;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-size:11px;
      padding:6px 8px;
    }
    .add-player-form button{
      border-radius:999px;
      border:1px solid var(--blue);
      background:radial-gradient(circle at top,#38bdf8 0,#0ea5e9 40%,#0369a1 100%);
      font-size:11px;
      padding:6px 10px;
      color:#0b1120;
      text-transform:uppercase;
      letter-spacing:.12em;
      cursor:pointer;
      box-shadow:0 0 12px rgba(56,189,248,.7),inset 0 0 6px rgba(255,255,255,.4);
    }
    .summary-cards{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-bottom:8px;
      font-size:11px;
    }
    .summary-card{
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      padding:6px 8px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .summary-label{
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.14em;
      font-size:10px;
    }
    .summary-value{font-weight:600;font-size:12px;}
    .leaderboard-wrapper{
      max-height:260px;
      overflow:auto;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(15,12,10,.85);
      margin-top:6px;
    }
    .leaderboard-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .leaderboard-table thead{
      background:#111827;
      position:sticky;
      top:0;
      z-index:1;
    }
    .leaderboard-table th,
    .leaderboard-table td{
      border-bottom:1px solid var(--border);
      padding:4px 6px;
      text-align:left;
      vertical-align:top;
    }
    .leaderboard-table th{
      text-transform:uppercase;
      letter-spacing:.12em;
      font-size:10px;
      color:var(--muted);
    }
    .player-row{cursor:pointer;}
    .player-row:hover{background:rgba(17,24,39,.9);}
    .time-cell{
      font-size:10px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pity-count{font-size:10px;color:var(--muted);}
    .reel-tickets-cell{
      display:flex;
      gap:4px;
      flex-wrap:wrap;
    }
    .reel-ticket{
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:9px;
      background:var(--panel);
      border-radius:6px;
      padding:2px 3px;
      border:1px solid var(--border);
      min-width:52px;
    }
    .reel-ticket-label{
      font-size:9px;
      color:var(--muted);
    }
    .reel-ticket-value{
      font-weight:600;
      font-size:11px;
      display:flex;
      align-items:center;
      gap:2px;
    }
    .reel-ticket-value button{
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      padding:0 2px;
      font-size:11px;
    }
    .actions-cell{
      font-size:14px;
      text-align:center;
    }
    .actions-cell button{
      border:none;
      background:transparent;
      cursor:pointer;
      color:var(--muted);
    }
    .log{
      margin-top:8px;
      padding-top:6px;
      border-top:1px solid var(--border);
      font-size:11px;
      max-height:120px;
      overflow-y:auto;
      color:var(--muted);
    }
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.88);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .overlay.show{display:flex;}
    .winner-card{
      width:100%;
      max-width:420px;
      border-radius:18px;
      border:1px solid rgba(250,204,21,.6);
      background:radial-gradient(circle at top,#1e293b 0,#020617 50%,#000 100%);
      padding:14px 16px 18px;
      box-shadow:0 0 40px rgba(250,204,21,.8);
      text-align:center;
      position:relative;
    }
    .winner-heading{
      font-size:18px;
      font-weight:900;
      letter-spacing:.25em;
      text-transform:uppercase;
      color:var(--gold);
      text-shadow:0 0 14px rgba(250,204,21,1);
      margin-bottom:6px;
    }
    .winner-name{
      font-size:18px;
      font-weight:800;
      margin-bottom:4px;
    }
    .winner-meta{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .winner-actions{
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .winner-actions button{
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      font-size:11px;
      padding:6px 10px;
      cursor:pointer;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .winner-luna-sticker{
      position:absolute;
      right:-6px;
      bottom:-6px;
      width:96px;
      height:96px;
      opacity:.95;
    }
    .winner-luna-sticker img{
      width:100%;
      height:100%;
      object-fit:contain;
    }
    .finish-card{
      width:100%;
      max-width:460px;
      border-radius:18px;
      border:1px solid var(--border);
      background:var(--panel);
      padding:14px 16px 18px;
      box-shadow:0 0 30px rgba(0,0,0,.9);
      font-size:12px;
    }
    .finish-title{
      font-size:14px;
      font-weight:700;
      margin-bottom:4px;
    }
    .finish-sub{
      font-size:11px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .finish-field{margin-bottom:8px;}
    .finish-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-bottom:4px;
    }
    .finish-input-row{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .finish-input-row input[type="number"]{
      width:80px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      font-size:12px;
      padding:4px 8px;
    }
    .finish-input-row select{
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      font-size:12px;
      padding:4px 8px;
    }
    .color-chips{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .color-chip{
      border-radius:999px;
      border:1px solid var(--border);
      width:26px;
      height:26px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background-color:transparent;
      background-repeat:no-repeat;
      background-position:center;
      background-size:contain;
      color:transparent;
      text-indent:-9999px;
      opacity:.7;
    }
    .color-chip.active{
      opacity:1;
      border-color:var(--gold);
      box-shadow:0 0 10px rgba(250,204,21,.7);
    }
    .color-chip[data-color="W"]{background-image:url("https://i.ibb.co/sJpHH9VZ/W.png");}
    .color-chip[data-color="U"]{background-image:url("https://i.ibb.co/0bPLHLk/U.png");}
    .color-chip[data-color="B"]{background-image:url("https://i.ibb.co/nM1ZZz3z/B.png");}
    .color-chip[data-color="R"]{background-image:url("https://i.ibb.co/NnjxnmZv/R.png");}
    .color-chip[data-color="G"]{background-image:url("https://i.ibb.co/tM5Mb1Q0/G.png");}
    .color-chip[data-color="C"]{background-image:url("https://i.ibb.co/xt4Lpn0X/C.png");}
    .queue-choice{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .queue-chip{
      border-radius:999px;
      border:1px solid var(--border);
      padding:4px 10px;
      font-size:11px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.1em;
      opacity:.7;
    }
    .queue-chip.active{
      opacity:1;
      border-color:var(--blue);
      box-shadow:0 0 10px rgba(56,189,248,.8);
      color:var(--blue);
    }
    .finish-actions{
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-top:8px;
    }
    .finish-actions button{
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--muted);
      font-size:11px;
      padding:6px 10px;
      text-transform:uppercase;
      letter-spacing:.12em;
      cursor:pointer;
    }
    .finish-actions button.primary{
      border-color:var(--gold);
      color:var(--gold);
    }
    .player-card{
      width:100%;
      max-width:480px;
      border-radius:16px;
      border:1px solid var(--border);
      background:var(--panel);
      padding:12px 14px;
      box-shadow:0 0 30px rgba(0,0,0,.9);
      font-size:12px;
    }
    .player-card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .player-card-name{
      font-weight:700;
      font-size:14px;
    }
    .player-card-status{
      font-size:11px;
      color:var(--muted);
    }
    .player-card-actions{
      display:flex;
      gap:6px;
      margin:6px 0;
      flex-wrap:wrap;
    }
    .player-card-actions button{
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--muted);
      font-size:11px;
      padding:4px 8px;
      text-transform:uppercase;
      letter-spacing:.1em;
      cursor:pointer;
    }
    .deck-table{
      width:100%;
      border-collapse:collapse;
      margin-top:6px;
      font-size:11px;
    }
    .deck-table th,.deck-table td{
      border-bottom:1px solid var(--border);
      padding:3px 4px;
      text-align:left;
    }
    .deck-table th{
      text-transform:uppercase;
      letter-spacing:.1em;
      font-size:10px;
      color:var(--muted);
    }
    .footer-bar{
      position:sticky;
      bottom:0;
      left:0;
      right:0;
      padding:6px 10px;
      background:rgba(10,9,8,.95);
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:11px;
      color:var(--muted);
      gap:8px;
    }
    .footer-buttons{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .footer-buttons button{
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--muted);
      font-size:10px;
      padding:4px 8px;
      text-transform:uppercase;
      letter-spacing:.1em;
      cursor:pointer;
    }
    .help-card{
      width:100%;
      max-width:520px;
      border-radius:16px;
      border:1px solid var(--border);
      background:var(--panel);
      padding:12px 14px;
      box-shadow:0 0 30px rgba(0,0,0,.9);
      font-size:12px;
    }
    .help-title{
      font-size:14px;
      font-weight:700;
      margin-bottom:4px;
    }
    .help-section-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-top:8px;
      margin-bottom:2px;
    }
    .help-body{
      font-size:11px;
      color:var(--muted);
    }
    .diag-result{
      margin-top:6px;
      font-size:11px;
    }
    .diag-result span.pass{color:var(--ok);}
    .diag-result span.warn{color:var(--danger);}
  </style>
</head>
<body class="theme-blue">
<div id="app">
  <header>
    <div class="header-left">
      <div class="logo">
        <img src="https://i.ibb.co/PvbYChDZ/G0-Gsi-Gv-XIAEk-Rf1-removebg-preview.png" alt="CARLO"/>
      </div>
      <div class="title-block">
        <div class="title">CARLO SLOT</div>
        <div class="subtitle">Viewer Deck Roulette · 5-Reel · Luna Luck & Carlo Jackpots</div>
        <div class="event-row">
          <span class="event-label">Event:</span>
          <span id="eventChips"></span>
        </div>
      </div>
    </div>
    <div class="header-right">
      <div class="spin-meta">
        Spins: <span id="spinCount">0</span> · Dead streak: <span id="deadStreak">0</span>
      </div>
      <div class="spin-meta">
        Players: <span id="playerCount">0</span> / 50 · Ticket cap: 500 · Pity max: 7 tokens
      </div>
      <div class="theme-toggle">
        Theme:
        <div class="theme-chip" data-color="W">W</div>
        <div class="theme-chip" data-color="U">U</div>
        <div class="theme-chip" data-color="B">B</div>
        <div class="theme-chip" data-color="R">R</div>
        <div class="theme-chip" data-color="G">G</div>
      </div>
    </div>
  </header>

  <main>
    <div class="slot-layout">
      <!-- SLOT SIDE -->
      <section class="slot-panel">
        <div class="slot-header">
          <div class="slot-title">Five-Reel Viewer Slot</div>
          <div id="statusText">Add players, then spin.</div>
        </div>
        <div class="reels-shell">
          <div class="bulb-row top" id="bulbRowTop"></div>
          <div class="bulb-row bottom" id="bulbRowBottom"></div>
          <div class="bulb-col left" id="bulbColLeft"></div>
          <div class="bulb-col right" id="bulbColRight"></div>
          <div class="reels-box">
            <div class="reel-labels">
              <span>C</span><span>A</span><span>R</span><span>L</span><span>O</span>
            </div>
            <div class="reels" id="reels"></div>
          </div>
        </div>
        <div class="slot-controls">
          <div class="status-text" id="smallStatus">Ready.</div>
          <div class="lever-area">
            <button class="spin-button" id="spinBtn">SPIN</button>
            <div class="lever" id="lever">
              <div class="lever-knob"></div>
            </div>
          </div>
        </div>
      </section>
      <!-- SIDE PANEL -->
      <section class="side-panel">
        <div class="side-panel-header">
          <div class="side-panel-section-title">Leaderboard Odds</div>
        </div>
        <form class="add-player-form" id="addPlayerForm">
          <input id="playerNameInput" placeholder="Add viewer (name / handle)" />
          <button type="submit">Add</button>
        </form>
        <div class="summary-cards">
          <div class="summary-card">
            <div class="summary-label">Expected per 150 spins (diag target)</div>
            <div class="summary-value">≈50 games · ≈2× CARLO · ≈5× Luna Luck</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Rules Snapshot</div>
            <div class="summary-value">5 reels · 3+ hits = slot win · Luna = wild for 3-in-a-row only · CARLO = streamer pick.</div>
          </div>
        </div>
        <div class="leaderboard-wrapper">
          <table class="leaderboard-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Player</th>
                <th>Total</th>
                <th>Pity</th>
                <th>Slot W</th>
                <th>W/L%</th>
                <th>Reels</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="leaderboardBody"></tbody>
          </table>
        </div>
        <div class="log" id="log"></div>
      </section>
    </div>
  </main>
  <div class="footer-bar">
    <div>CARLO Slot · MTG Viewer Queue · Local save per event</div>
    <div class="footer-buttons">
      <button id="helpBtn">Help</button>
      <button id="diagBtn">Hypergeometric Diagnostic</button>
      <button id="exportBtn">Export Session</button>
      <button id="importBtn">Import Session</button>
      <button id="resetEventBtn">Factory Reset Event</button>
    </div>
  </div>
  <input type="file" id="importFileInput" accept=".json" style="display:none;"/>
  <!-- WINNER OVERLAY -->
  <div class="overlay" id="winnerOverlay">
    <div class="winner-card">
      <div class="winner-heading" id="winnerHeading">WINNER</div>
      <div class="winner-name" id="winnerName"></div>
      <div class="winner-meta" id="winnerMeta"></div>
      <div class="winner-actions">
        <button id="winnerPlayBtn">Play Deck</button>
        <button id="winnerSkipBtn">Skip / Remove</button>
      </div>
      <div class="winner-luna-sticker" id="winnerLunaSticker" style="display:none;">
        <img src="https://i.ibb.co/23vVSmXN/LunaGG.png" alt="Luna">
      </div>
    </div>
  </div>
  <!-- FINISH RUN OVERLAY -->
  <div class="overlay" id="finishOverlay">
    <div class="finish-card">
      <div class="finish-title">Report Deck Run Results</div>
      <div class="finish-sub">
        Enter how this deck performed before returning to the slot. Wins/losses here are the actual MTG games, not the slot.
      </div>
      <div class="finish-field">
        <div class="finish-label">Wins / Losses This Run</div>
        <div class="finish-input-row">
          <label>Wins
            <input type="number" id="runWins" min="0" value="0"/>
          </label>
          <label>Losses
            <input type="number" id="runLosses" min="0" value="1"/>
          </label>
          <label>Match type
            <select id="matchType">
              <option value="BO1">Bo1</option>
              <option value="BO3">Bo3</option>
            </select>
          </label>
        </div>
      </div>
      <div class="finish-field">
        <div class="finish-label">Deck Color Identity</div>
        <div class="color-chips" id="colorChips">
          <div class="color-chip" data-color="W">W</div>
          <div class="color-chip" data-color="U">U</div>
          <div class="color-chip" data-color="B">B</div>
          <div class="color-chip" data-color="R">R</div>
          <div class="color-chip" data-color="G">G</div>
          <div class="color-chip" data-color="C">C</div>
        </div>
      </div>
      <div class="finish-field" id="bonusChoiceField" style="display:none;">
        <div class="finish-label">Bonus Reward (4/5-of-a-kind)</div>
        <div class="finish-sub" style="margin-top:4px;">Choose your reward for hitting 4 or 5 symbols:</div>
        <div class="queue-choice" id="bonusChoice">
          <div class="queue-chip active" data-choice="tickets">Bonus Tickets</div>
          <div class="queue-chip" data-choice="games">Extra Games</div>
        </div>
      </div>
      <div class="finish-field">
        <div class="finish-label">Re-add player to queue?</div>
        <div class="queue-choice" id="queueChoice">
          <div class="queue-chip active" data-choice="yes">Yes</div>
          <div class="queue-chip" data-choice="no">No</div>
        </div>
      </div>
      <div class="finish-actions">
        <button id="finishCancelBtn">Cancel</button>
        <button class="primary" id="finishSaveBtn">Save & Re-Queue</button>
      </div>
    </div>
  </div>
  <!-- PLAYER DETAIL OVERLAY -->
  <div class="overlay" id="playerOverlay">
    <div class="player-card">
      <div class="player-card-header">
        <div class="player-card-name" id="playerCardName"></div>
        <div class="player-card-status" id="playerCardStatus"></div>
      </div>
      <div class="player-card-actions">
        <button id="toggleAfkBtn">Toggle AFK</button>
        <button id="removePlayerBtn">Remove Player</button>
        <button id="closePlayerCardBtn">Close</button>
      </div>
      <div class="help-section-title">Decks (by color identity)</div>
      <table class="deck-table">
        <thead>
          <tr>
            <th>Colors</th>
            <th>Matches</th>
            <th>W/L</th>
            <th>Win%</th>
            <th>Last</th>
          </tr>
        </thead>
        <tbody id="deckTableBody"></tbody>
      </table>
    </div>
  </div>
  <!-- HELP OVERLAY -->
  <div class="overlay" id="helpOverlay">
    <div class="help-card">
      <div class="help-title">How CARLO Slot Works</div>
      <div class="help-body">
        <div class="help-section-title">Basic Flow</div>
        <p>
          Viewers enter the queue with 1 ticket on each of 5 reels. Each spin shows 5 results:
          player names, CARLO letters, or Luna. When a player's name appears 3 or more times on
          the reels, that player wins the slot and their deck is played until it loses.
        </p>
        <div class="help-section-title">Tickets & Pity</div>
        <p>
          On a winning spin, the winner is selected. Players who appeared but did not win spend 1
          ticket on the reels they showed up on. Everyone else doubles their tickets on all reels,
          up to a cap of 500 per reel. Any overflow above 500 converts into pity tokens. Overflow
          always grants at least one pity token, and each additional full 500 overflow awards
          another token (up to 7 tokens). At 7 pity tokens, that player will be auto-picked
          before the next normal spin.
        </p>
        <div class="help-section-title">Dead Spins</div>
        <p>
          On a dead spin (no winner), players whose names appear spend 1 ticket on the reels they
          appeared on (down to 1). Players who did not appear have their tickets on every reel
          halved (rounded up) and then gain +1 ticket, always staying at 1 or more, up to 500.
        </p>
        <div class="help-section-title">Luna Luck</div>
        <p>
          Luna is a wild symbol that can help complete exactly 3-in-a-row for a player. Only one
          Luna can appear per spin. She never makes 4- or 5-of-a-kind count bigger; she only
          creates a special Luna Luck 3-hit. When Luna Luck wins, the banner says "– wins with
          Luna Luck!" and uses the Luna emotes.
        </p>
        <div class="help-section-title">CARLO</div>
        <p>
          Each reel has a rare chance to show the letters C, A, R, L, O in order. When all 5
          letters appear at once, CARLO triggers and the streamer plays their own deck instead of
          a viewer. Individual letters without the full CARLO just count like normal letters and
          do not change probabilities.
        </p>
        <div class="help-section-title">Hypergeometric Diagnostic</div>
        <p>
          The hypergeometric diagnostic approximates slot odds by running 150 simulated spins with your
          current player weights. It estimates how many slot wins, CARLO hits, and Luna Luck wins you’d
          get in a typical batch, and flags when counts are outside the expected range.
        </p>
      </div>
      <div class="finish-actions">
        <button id="closeHelpBtn">Close</button>
      </div>
    </div>
  </div>
  <!-- DIAGNOSTIC OVERLAY -->
  <div class="overlay" id="diagOverlay">
    <div class="help-card">
      <div class="help-title">Hypergeometric Diagnostic</div>
      <div class="help-body">
        <p>Simulates 150 spins with the current player list & weights (no changes to the live event).</p>
        <div class="finish-actions">
          <button id="runDiagNowBtn">Run Simulation</button>
          <button id="closeDiagBtn">Close</button>
        </div>
        <div class="diag-result" id="diagResult"></div>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  "use strict";
  const MAX_EVENTS = 7;
  const MAX_PLAYERS = 50;
  const TICKET_CAP = 500;
  const MAX_PITY_TOKENS = 7;
  const LUNA_BASE_ODDS = 1/30;
  const CARLO_LETTER_ODDS = 1/75;

  const reelsEl = document.getElementById('reels');
  const spinBtn = document.getElementById('spinBtn');
  const leverEl = document.getElementById('lever');
  const smallStatus = document.getElementById('smallStatus');
  const statusText = document.getElementById('statusText');
  const spinCountEl = document.getElementById('spinCount');
  const deadStreakEl = document.getElementById('deadStreak');
  const playerCountEl = document.getElementById('playerCount');
  const leaderboardBody = document.getElementById('leaderboardBody');
  const logEl = document.getElementById('log');
  const eventChipsEl = document.getElementById('eventChips');
  const bulbRowTop = document.getElementById('bulbRowTop');
  const bulbRowBottom = document.getElementById('bulbRowBottom');
  const bulbColLeft = document.getElementById('bulbColLeft');
  const bulbColRight = document.getElementById('bulbColRight');
  const addPlayerForm = document.getElementById('addPlayerForm');
  const playerNameInput = document.getElementById('playerNameInput');
  const winnerOverlay = document.getElementById('winnerOverlay');
  const winnerHeading = document.getElementById('winnerHeading');
  const winnerNameEl = document.getElementById('winnerName');
  const winnerMetaEl = document.getElementById('winnerMeta');
  const winnerPlayBtn = document.getElementById('winnerPlayBtn');
  const winnerSkipBtn = document.getElementById('winnerSkipBtn');
  const winnerLunaSticker = document.getElementById('winnerLunaSticker');
  const finishOverlay = document.getElementById('finishOverlay');
  const runWinsInput = document.getElementById('runWins');
  const runLossesInput = document.getElementById('runLosses');
  const matchTypeSelect = document.getElementById('matchType');
  const colorChips = document.getElementById('colorChips');
  const queueChoice = document.getElementById('queueChoice');
  const bonusChoice = document.getElementById('bonusChoice');
  const bonusChoiceField = document.getElementById('bonusChoiceField');
  const finishCancelBtn = document.getElementById('finishCancelBtn');
  const finishSaveBtn = document.getElementById('finishSaveBtn');
  const playerOverlay = document.getElementById('playerOverlay');
  const playerCardName = document.getElementById('playerCardName');
  const playerCardStatus = document.getElementById('playerCardStatus');
  const toggleAfkBtn = document.getElementById('toggleAfkBtn');
  const removePlayerBtn = document.getElementById('removePlayerBtn');
  const closePlayerCardBtn = document.getElementById('closePlayerCardBtn');
  const deckTableBody = document.getElementById('deckTableBody');
  const helpOverlay = document.getElementById('helpOverlay');
  const diagOverlay = document.getElementById('diagOverlay');
  const helpBtn = document.getElementById('helpBtn');
  const diagBtn = document.getElementById('diagBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFileInput = document.getElementById('importFileInput');
  const resetEventBtn = document.getElementById('resetEventBtn');
  const closeHelpBtn = document.getElementById('closeHelpBtn');
  const closeDiagBtn = document.getElementById('closeDiagBtn');
  const runDiagNowBtn = document.getElementById('runDiagNowBtn');
  const diagResult = document.getElementById('diagResult');
  const themeChips = document.querySelectorAll('.theme-chip');

  const state = {currentEventIndex: 1,events: []};
  let selectedColorSet = new Set();
  let queueReaddChoice = 'yes';
  let bonusRewardChoice = 'tickets';
  let pendingWinner = null;
  let currentWinnerMeta = null;
  let bulbsTimer = null;
  let timeTimer = null;
  let currentPlayerCardId = null;

  function currentEvent(){
    if(!state.events[state.currentEventIndex]){
      state.events[state.currentEventIndex] = {
        players: [],
        spinCount: 0,
        deadSpinStreak: 0,
        currentRun: null,
        carloHits: 0,
        lunaHits: 0
      };
    }
    return state.events[state.currentEventIndex];
  }

  function log(msg){
    const time = new Date().toLocaleTimeString();
    const div = document.createElement('div');
    div.textContent = `[${time}] ${msg}`;
    logEl.prepend(div);
  }
  function saveAll(){
    try{
      localStorage.setItem('carlo_slot_events', JSON.stringify(state));
    }catch(e){
      console.warn("Save failed", e);
    }
  }
  function loadAll(){
    try{
      const raw = localStorage.getItem('carlo_slot_events');
      if(!raw) return;
      const parsed = JSON.parse(raw);
      if(!parsed || typeof parsed !== 'object') return;
      if(parsed.events) state.events = parsed.events;
      if(parsed.currentEventIndex) state.currentEventIndex = parsed.currentEventIndex;
      for(const evt of state.events){
        if(!evt) continue;
        evt.players = evt.players || [];
        evt.spinCount = evt.spinCount || 0;
        evt.deadSpinStreak = evt.deadSpinStreak || 0;
        evt.currentRun = evt.currentRun || null;
        evt.carloHits = evt.carloHits || 0;
        evt.lunaHits = evt.lunaHits || 0;
        for(const p of evt.players){
          p.tickets = p.tickets || [1,1,1,1,1];
          p.pityTokens = p.pityTokens || 0;
          if(p.pityPoints && p.pityPoints > 0){
            p.pityTokens = Math.min(MAX_PITY_TOKENS, p.pityTokens + 1);
          }
          p.pityPoints = 0;
          p.slotWins = p.slotWins || 0;
          p.slotGames = p.slotGames || 0;
          p.overallWins = p.overallWins || 0;
          p.overallLosses = p.overallLosses || 0;
          p.createdAt = p.createdAt || Date.now();
          p.status = p.status || 'active';
          p.decks = p.decks || [];
        }
      }
    }catch(e){
      console.warn("Load failed", e);
    }
  }

  function clampPlayer(p){
    for(let i=0;i<5;i++){
      if(p.tickets[i] < 1) p.tickets[i] = 1;  // Never allow 0 tickets
      if(p.tickets[i] > TICKET_CAP) p.tickets[i] = TICKET_CAP;
    }
    if(p.pityTokens < 0) p.pityTokens = 0;
    if(p.pityTokens > MAX_PITY_TOKENS) p.pityTokens = MAX_PITY_TOKENS;
  }

  function totalTickets(p){
    return p.tickets.reduce((a,b)=>a+b,0);
  }
  function overallWinRate(p){
    const total = p.overallWins + p.overallLosses;
    if(total === 0) return 0;
    return (p.overallWins / total) * 100;
  }
  function formatTimeInQueue(ms){
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const h = Math.floor(m/60);
    if(h>0) return `${h}h ${m%60}m`;
    if(m>0) return `${m}m ${s%60}s`;
    return `${s}s`;
  }

  function renderEvents(){
    eventChipsEl.innerHTML = '';
    for(let i=1;i<=MAX_EVENTS;i++){
      const span = document.createElement('span');
      span.className = 'event-chip' + (state.currentEventIndex === i ? ' active' : '');
      span.textContent = i;
      span.dataset.index = i;
      eventChipsEl.appendChild(span);
    }
  }

  function initBulbs(){
    function createRow(rowEl, count){
      rowEl.innerHTML = '';
      for(let i=0;i<count;i++){
        const b = document.createElement('div');
        b.className = 'bulb';
        rowEl.appendChild(b);
      }
    }
    function createCol(colEl, count){
      colEl.innerHTML = '';
      for(let i=0;i<count;i++){
        const b = document.createElement('div');
        b.className = 'bulb';
        colEl.appendChild(b);
      }
    }
    createRow(bulbRowTop, 10);
    createRow(bulbRowBottom, 10);
    createCol(bulbColLeft, 4);
    createCol(bulbColRight, 4);
  }

  const BULB_COLORS = ['#fefce8','#38bdf8','#020617','#ef4444','#22c55e'];
  const BULB_LUNA_COLORS = ['#fdf2ff','#fb7185','#a855f7','#f973fa'];
  function startBulbsAnimation(isLuna){
    stopBulbsAnimation();
    const top = bulbRowTop.querySelectorAll('.bulb');
    const bottom = bulbRowBottom.querySelectorAll('.bulb');
    const left = bulbColLeft.querySelectorAll('.bulb');
    const right = bulbColRight.querySelectorAll('.bulb');
    const all = [...top,...bottom,...left,...right];
    let t = 0;
    bulbsTimer = setInterval(()=>{
      const colors = isLuna ? BULB_LUNA_COLORS : BULB_COLORS;
      all.forEach((b,idx)=>{
        const c = colors[(idx + t) % colors.length];
        b.style.color = c;
        b.style.background = c;
        b.classList.add('active');
      });
      t++;
    },120);
  }
  function stopBulbsAnimation(){
    if(bulbsTimer) clearInterval(bulbsTimer);
    bulbsTimer = null;
    const all = document.querySelectorAll('.bulb');
    all.forEach(b=>{
      b.classList.remove('active');
      b.style.background='#4b5563';
    });
  }

  function setupReelsPlaceholder(){
    reelsEl.innerHTML = '';
    for(let i=0;i<5;i++){
      const reel = document.createElement('div');
      reel.className = 'reel';
      const inner = document.createElement('div');
      inner.className = 'reel-inner';
      const sym = document.createElement('div');
      sym.className = 'reel-symbol letter';
      sym.textContent = "CARLO"[i];
      inner.appendChild(sym);
      reel.appendChild(inner);
      reelsEl.appendChild(reel);
    }
  }

  function spinAnimationStart(){
    const reelEls = reelsEl.querySelectorAll('.reel');
    reelEls.forEach(r=>{
      r.classList.add('spinning');
      r.classList.remove('glow-win','glow-carlo','glow-luna');
    });
    startBulbsAnimation(false);
  }
  function spinAnimationStop(){
    const reelEls = reelsEl.querySelectorAll('.reel');
    reelEls.forEach(r=>r.classList.remove('spinning'));
    stopBulbsAnimation();
  }

  function addPlayer(name){
    const evt = currentEvent();
    if(evt.players.length >= MAX_PLAYERS){
      smallStatus.textContent = "Player cap reached for this event.";
      return;
    }
    name = name.trim();
    if(!name) return;
    const existing = evt.players.find(p => p.name.toLowerCase() === name.toLowerCase());
    if(existing){
      smallStatus.textContent = "Player already in queue.";
      return;
    }
    const p = {
      id: Date.now() + Math.random().toString(16).slice(2),
      name,
      tickets:[1,1,1,1,1],
      pityTokens:0,
      slotWins:0,
      slotGames:0,
      overallWins:0,
      overallLosses:0,
      createdAt:Date.now(),
      status:'active',
      decks:[]
    };
    evt.players.push(p);
    log(`Added player ${name} to event ${state.currentEventIndex}.`);
    renderLeaderboard();
    const lbWrap = document.querySelector('.leaderboard-wrapper');
    if(lbWrap) lbWrap.scrollTop = lbWrap.scrollHeight;
    saveAll();
  }

  function randomWeightedPlayer(evt, reelIndex){
    const candidates = evt.players.filter(p=>p.status==='active');
    if(candidates.length === 0) return null;
    let total = 0;
    for(const p of candidates){
      total += p.tickets[reelIndex];
    }
    if(total <= 0) return null;
    let r = Math.random() * total;
    for(const p of candidates){
      r -= p.tickets[reelIndex];
      if(r <= 0) return p;
    }
    return candidates[candidates.length-1];
  }

  function applyOverflowToPity(player, overflow){
    if(overflow <= 0) return;
    let tokens;
    if(overflow < TICKET_CAP){
      tokens = 1;
    } else {
      tokens = Math.floor(overflow / TICKET_CAP);
    }
    player.pityTokens = Math.min(MAX_PITY_TOKENS, (player.pityTokens || 0) + tokens);
  }

  function doubleTicketsAllReels(player){
    const oldTotal = totalTickets(player);
    const oldPity = player.pityTokens || 0;
    for(let i=0;i<5;i++){
      const raw = player.tickets[i] * 2;
      if(raw <= TICKET_CAP){
        // No overflow, just set to doubled amount
        player.tickets[i] = raw;
      } else {
        // Overflow: raw exceeds 500 cap
        const overflow = raw - TICKET_CAP;

        // Calculate pity tokens from overflow
        const pityTokens = overflow < TICKET_CAP ? 1 : Math.floor(overflow / TICKET_CAP);
        player.pityTokens = Math.min(MAX_PITY_TOKENS, (player.pityTokens || 0) + pityTokens);

        // Calculate remaining tickets after overflow
        let newTickets = overflow % TICKET_CAP;
        if(newTickets === 0){
          // If exactly divisible, keep minimum viable tickets
          newTickets = 1;
        }
        player.tickets[i] = newTickets;
      }
    }
    clampPlayer(player);
    const newTotal = totalTickets(player);
    const newPity = player.pityTokens;
    if(newPity > oldPity){
      log(`${player.name}: tickets ${oldTotal}→${newTotal}, pity ${oldPity}→${newPity} (+${newPity-oldPity})`);
    }
  }

  function handleDeadSpinTickets(evt, symbols, reelPlayers){
    const drawnIds = new Set(reelPlayers.map(r=>r.playerId));
    for(const p of evt.players){
      if(p.status !== 'active') continue;
      if(drawnIds.has(p.id)){
        // Player appeared: lose -1 on that specific reel(s)
        for(const rp of reelPlayers){
          if(rp.playerId === p.id){
            const i = rp.index;
            p.tickets[i] = Math.max(1, p.tickets[i]-1);
          }
        }
      }else{
        // Player didn't appear: double all tickets
        doubleTicketsAllReels(p);
      }
      clampPlayer(p);
    }
  }

  function handleWinTickets(evt, winner, symbols, reelPlayers){
    const winnerId = winner.id;
    const drawnIds = new Set(reelPlayers.map(r=>r.playerId));
    for(const p of evt.players){
      if(p.status !== 'active') continue;
      if(p.id === winnerId){
        continue;
      }
      if(drawnIds.has(p.id)){
        for(const rp of reelPlayers){
          if(rp.playerId === p.id){
            const i = rp.index;
            p.tickets[i] = Math.max(1, p.tickets[i]-1);
          }
        }
      }else{
        doubleTicketsAllReels(p);
      }
      clampPlayer(p);
    }
  }

  function findPityAutoPick(evt){
    const candidates = evt.players.filter(p => p.status === 'active' && p.pityTokens >= MAX_PITY_TOKENS);
    if(candidates.length === 0) return null;
    candidates.sort((a,b) => {
      if(a.createdAt !== b.createdAt) return a.createdAt - b.createdAt;
      if(b.pityTokens !== a.pityTokens) return b.pityTokens - a.pityTokens;
      const totDiff = totalTickets(b) - totalTickets(a);
      if(totDiff !== 0) return totDiff;
      return a.name.localeCompare(b.name);
    });
    return candidates[0];
  }

  function buildSpinResult(evt){
    const symbols = [];
    const letters = ['C','A','R','L','O'];
    const luna = Math.random() < LUNA_BASE_ODDS;
    const lunaIndex = luna ? Math.floor(Math.random()*5) : -1;
    for(let i=0;i<5;i++){
      if(i === lunaIndex){
        symbols.push({type:'luna'});
        continue;
      }
      const roll = Math.random();
      if(roll < CARLO_LETTER_ODDS){
        symbols.push({type:'letter', letter:letters[i]});
      }else{
        const p = randomWeightedPlayer(evt, i);
        if(p){
          symbols.push({type:'player', playerId:p.id, name:p.name});
        }else{
          symbols.push({type:'letter', letter:letters[i]});
        }
      }
    }
    return symbols;
  }

  function renderSpinResult(symbols){
    reelsEl.innerHTML = '';
    symbols.forEach(sym=>{
      const reel = document.createElement('div');
      reel.className = 'reel';
      const inner = document.createElement('div');
      inner.className = 'reel-inner';
      const div = document.createElement('div');
      if(sym.type === 'player'){
        div.className = 'reel-symbol player';
        div.textContent = sym.name;
      }else if(sym.type === 'letter'){
        div.className = 'reel-symbol letter';
        div.textContent = sym.letter;
      }else if(sym.type === 'luna'){
        div.className = 'reel-symbol luna';
        const img = document.createElement('img');
        img.src = "https://i.ibb.co/8g6ZQM5C/IMG-2604.png";
        img.alt = "Luna";
        div.appendChild(img);
      }else{
        div.className = 'reel-symbol letter';
        div.textContent = '?';
      }
      inner.appendChild(div);
      reel.appendChild(inner);
      reelsEl.appendChild(reel);
    });
  }

  function detectCarlo(symbols){
    return (
      symbols[0].type==='letter' && symbols[0].letter==='C' &&
      symbols[1].type==='letter' && symbols[1].letter==='A' &&
      symbols[2].type==='letter' && symbols[2].letter==='R' &&
      symbols[3].type==='letter' && symbols[3].letter==='L' &&
      symbols[4].type==='letter' && symbols[4].letter==='O'
    );
  }

  function detectLunaWinner(evt, symbols){
    const playersById = new Map();
    evt.players.forEach(p=>playersById.set(p.id,p));
    let lunaIndex = -1;
    symbols.forEach((s,idx)=>{
      if(s.type==='luna') lunaIndex = idx;
    });
    if(lunaIndex<0) return null;
    const triples = [
      [lunaIndex-2,lunaIndex-1,lunaIndex],
      [lunaIndex-1,lunaIndex,lunaIndex+1],
      [lunaIndex,lunaIndex+1,lunaIndex+2]
    ];
    for(const triple of triples){
      const valid = triple.filter(i=>i>=0 && i<symbols.length);
      if(valid.length!==3) continue;
      const syms = valid.map(i=>symbols[i]);
      const players = syms.filter(s=>s.type==='player');
      if(players.length===0) continue;
      const countById = {};
      players.forEach(ps=>countById[ps.playerId]=(countById[ps.playerId]||0)+1);
      const idWith2 = Object.keys(countById).find(id=>countById[id]>=2);
      if(idWith2){
        const p = playersById.get(idWith2);
        if(p && p.status==='active'){
          return {player:p, hits:3, lunaIndex};
        }
      }else if(players.length===1){
        const p = playersById.get(players[0].playerId);
        if(p && p.status==='active'){
          return {player:p, hits:3, lunaIndex};
        }
      }
    }
    return null;
  }

  function detectHitWinner(evt, symbols){
    const counts = new Map();
    const playersById = new Map();
    evt.players.forEach(p=>playersById.set(p.id,p));
    symbols.forEach(s=>{
      if(s.type==='player'){
        counts.set(s.playerId,(counts.get(s.playerId)||0)+1);
      }
    });
    const candidates = [];
    counts.forEach((cnt,id)=>{
      if(cnt>=3){
        const p = playersById.get(id);
        if(p && p.status==='active'){
          candidates.push({player:p,hits:cnt});
        }
      }
    });
    if(candidates.length===0) return null;
    candidates.sort((a,b)=>{
      if(b.hits!==a.hits) return b.hits-a.hits;
      const tDiff = totalTickets(b.player)-totalTickets(a.player);
      if(tDiff!==0) return tDiff;
      return a.player.createdAt - b.player.createdAt;
    });
    return candidates[0];
  }

  function renderLeaderboard(){
    const evt = currentEvent();
    const players = evt.players;
    leaderboardBody.innerHTML = '';
    const sorted = players.slice().sort((a,b)=>{
      const tDiff = totalTickets(b)-totalTickets(a);
      if(tDiff!==0) return tDiff;
      return a.createdAt - b.createdAt;
    });
    const now = Date.now();
    for(const p of sorted){
      clampPlayer(p);
      const tr = document.createElement('tr');
      tr.className = 'player-row';
      const tdTime = document.createElement('td');
      tdTime.className = 'time-cell';
      tdTime.textContent = formatTimeInQueue(now - p.createdAt);
      const tdName = document.createElement('td');
      tdName.innerHTML = p.name + (p.status!=='active'
        ? " <span style='color:var(--red);font-size:10px;'>(AFK)</span>"
        : "");
      const tdTotal = document.createElement('td');
      tdTotal.textContent = totalTickets(p);
      const tdPity = document.createElement('td');
      const pityIcon = p.pityTokens > 0 ? '🥣' : '';
      const pityText = p.pityTokens > 0 ? `${p.pityTokens} / ${MAX_PITY_TOKENS}` : '';
      tdPity.innerHTML = `${pityIcon} <span class="pity-count">${pityText}</span>`;
      const tdSlotWins = document.createElement('td');
      tdSlotWins.textContent = `${p.slotWins}`;
      const tdWL = document.createElement('td');
      tdWL.textContent = `${p.overallWins}/${p.overallLosses} (${overallWinRate(p).toFixed(1)}%)`;
      const tdReels = document.createElement('td');
      tdReels.className = 'reel-tickets-cell';
      for(let i=0;i<5;i++){
        const sub = document.createElement('div');
        sub.className='reel-ticket';
        const lbl = document.createElement('div');
        lbl.className='reel-ticket-label';
        lbl.textContent=`R${i+1}`;
        const valRow = document.createElement('div');
        valRow.className='reel-ticket-value';
        const minus = document.createElement('button');
        minus.textContent='-';
        const span = document.createElement('span');
        span.textContent=p.tickets[i];
        const plus = document.createElement('button');
        plus.textContent='+';
        minus.addEventListener('click',e=>{
          e.stopPropagation();
          if(p.tickets[i]>1) p.tickets[i]--;
          clampPlayer(p);
          renderLeaderboard();
          saveAll();
        });
        plus.addEventListener('click',e=>{
          e.stopPropagation();
          if(p.tickets[i]<TICKET_CAP) p.tickets[i]++;
          clampPlayer(p);
          renderLeaderboard();
          saveAll();
        });
        valRow.appendChild(minus);
        valRow.appendChild(span);
        valRow.appendChild(plus);
        sub.appendChild(lbl);
        sub.appendChild(valRow);
        tdReels.appendChild(sub);
      }
      const tdActions = document.createElement('td');
      tdActions.className='actions-cell';
      const cog = document.createElement('button');
      cog.textContent='⚙';
      cog.title='View player card';
      cog.addEventListener('click',e=>{
        e.stopPropagation();
        openPlayerCard(p.id);
      });
      tdActions.appendChild(cog);
      tr.appendChild(tdTime);
      tr.appendChild(tdName);
      tr.appendChild(tdTotal);
      tr.appendChild(tdPity);
      tr.appendChild(tdSlotWins);
      tr.appendChild(tdWL);
      tr.appendChild(tdReels);
      tr.appendChild(tdActions);
      leaderboardBody.appendChild(tr);
    }
    spinCountEl.textContent = evt.spinCount;
    deadStreakEl.textContent = evt.deadSpinStreak;
    playerCountEl.textContent = evt.players.length;
  }

  function openPlayerCard(playerId){
    const evt = currentEvent();
    const p = evt.players.find(x=>x.id===playerId);
    if(!p) return;
    currentPlayerCardId = playerId;
    playerCardName.textContent = p.name;
    playerCardStatus.textContent = p.status === 'active' ? 'Active' : 'AFK';
    deckTableBody.innerHTML = '';
    const rows = [];
    p.decks.forEach(d=>{
      const total = d.wins + d.losses;
      const winRate = total>0 ? (d.wins/total)*100 : 0;
      const tr = document.createElement('tr');
      const tdColor = document.createElement('td');
      tdColor.textContent = d.color;
      const tdMatches = document.createElement('td');
      tdMatches.textContent = total;
      const tdWL = document.createElement('td');
      tdWL.textContent = `${d.wins}/${d.losses}`;
      const tdWinRate = document.createElement('td');
      tdWinRate.textContent = `${winRate.toFixed(1)}%`;
      const tdLast = document.createElement('td');
      tdLast.textContent = d.lastBestOf || '-';
      tr.appendChild(tdColor);
      tr.appendChild(tdMatches);
      tr.appendChild(tdWL);
      tr.appendChild(tdWinRate);
      tr.appendChild(tdLast);
      rows.push({winRate, tr});
    });
    rows.sort((a,b)=>b.winRate-a.winRate);
    rows.forEach(r=>deckTableBody.appendChild(r.tr));
    playerOverlay.classList.add('show');
  }

  toggleAfkBtn.addEventListener('click',()=>{
    if(currentPlayerCardId===null) return;
    const evt = currentEvent();
    const p = evt.players.find(x=>x.id===currentPlayerCardId);
    if(!p) return;
    p.status = (p.status==='active' ? 'afk' : 'active');
    log(`${p.name} is now ${p.status.toUpperCase()}.`);
    playerOverlay.classList.remove('show');
    renderLeaderboard();
    saveAll();
  });
  removePlayerBtn.addEventListener('click',()=>{
    if(currentPlayerCardId===null) return;
    const evt = currentEvent();
    const idx = evt.players.findIndex(x=>x.id===currentPlayerCardId);
    if(idx>=0){
      const removed = evt.players.splice(idx,1)[0];
      log(`Removed ${removed.name} from event ${state.currentEventIndex}.`);
    }
    playerOverlay.classList.remove('show');
    currentPlayerCardId = null;
    renderLeaderboard();
    saveAll();
  });
  closePlayerCardBtn.addEventListener('click',()=>{
    playerOverlay.classList.remove('show');
    currentPlayerCardId=null;
  });

  function handleWinnerBanner(player, reason, hits, isLuna){
    const evt = currentEvent();
    evt.deadSpinStreak = 0;
    evt.spinCount++;
    player.slotGames = (player.slotGames||0) + 1;
    player.slotWins = (player.slotWins||0) + 1;
    clampPlayer(player);
    pendingWinner = player;
    currentWinnerMeta = {reason,hits};
    winnerLunaSticker.style.display = isLuna ? 'block' : 'none';
    winnerNameEl.textContent = player.name;
    if(reason==='luna'){
      winnerHeading.textContent = 'LUNA LUCK!';
      winnerMetaEl.textContent = `${player.name} wins with Luna Luck!`;
    }else if(reason==='pity'){
      winnerHeading.textContent = 'FATE PICK';
      winnerMetaEl.textContent = `${player.name} reached max pity and is chosen automatically.`;
    }else if(reason==='carlo'){
      winnerHeading.textContent = 'CARLO PICK';
      winnerMetaEl.textContent = `CARLO hit – streamer plays their own deck this round.`;
    }else{
      winnerHeading.textContent = 'WINNER';
      if(hits>=5){
        winnerMetaEl.textContent = `${player.name} hit 5 symbols – high-odds pick!`;
      }else if(hits===4){
        winnerMetaEl.textContent = `${player.name} hit 4 symbols – strong roll.`;
      }else{
        winnerMetaEl.textContent = `${player.name}'s deck is up next.`;
      }
    }
    winnerOverlay.classList.add('show');
  }

  function finishRunPrompt(player){
    const evt = currentEvent();
    const hits = (currentWinnerMeta && currentWinnerMeta.hits) || 3;
    const showBonusChoice = hits === 4 || hits === 5;
    evt.currentRun = {
      playerId: player.id,
      bonusPerReel: 0
    };
    runWinsInput.value = "0";
    runLossesInput.value = "1";
    matchTypeSelect.value = "BO1";
    selectedColorSet = new Set();
    Array.from(colorChips.children).forEach(ch=>ch.classList.remove('active'));
    queueReaddChoice = 'yes';
    Array.from(queueChoice.children).forEach(ch=>{
      ch.classList.toggle('active', ch.dataset.choice === 'yes');
    });
    bonusRewardChoice = 'tickets';
    Array.from(bonusChoice.children).forEach(ch=>{
      ch.classList.toggle('active', ch.dataset.choice === 'tickets');
    });
    bonusChoiceField.style.display = showBonusChoice ? 'block' : 'none';
    finishOverlay.classList.add('show');
  }

  winnerPlayBtn.addEventListener('click',()=>{
    if(!pendingWinner) return;
    const p=pendingWinner;
    pendingWinner=null;
    winnerOverlay.classList.remove('show');
    finishRunPrompt(p);
  });

  winnerSkipBtn.addEventListener('click',()=>{
    const evt = currentEvent();
    if(pendingWinner){
      log(`Winner ${pendingWinner.name} skipped / removed from queue.`);
      const idx = evt.players.findIndex(x=>x.id===pendingWinner.id);
      if(idx>=0) evt.players.splice(idx,1);
    }
    pendingWinner=null;
    winnerOverlay.classList.remove('show');
    renderLeaderboard();
    saveAll();
  });

  colorChips.addEventListener('click',e=>{
    const chip = e.target.closest('.color-chip');
    if(!chip) return;
    const c = chip.dataset.color;
    if(selectedColorSet.has(c)){
      selectedColorSet.delete(c);
      chip.classList.remove('active');
    }else{
      selectedColorSet.add(c);
      chip.classList.add('active');
    }
  });

  queueChoice.addEventListener('click',e=>{
    const chip = e.target.closest('.queue-chip');
    if(!chip) return;
    queueReaddChoice = chip.dataset.choice;
    Array.from(queueChoice.children).forEach(ch=>{
      ch.classList.toggle('active', ch===chip);
    });
  });

  bonusChoice.addEventListener('click',e=>{
    const chip = e.target.closest('.queue-chip');
    if(!chip) return;
    bonusRewardChoice = chip.dataset.choice;
    Array.from(bonusChoice.children).forEach(ch=>{
      ch.classList.toggle('active', ch===chip);
    });
  });

  finishCancelBtn.addEventListener('click',()=>{
    finishOverlay.classList.remove('show');
  });

  finishSaveBtn.addEventListener('click',()=>{
    const evt = currentEvent();
    if(!evt.currentRun) return;
    const run = evt.currentRun;
    const player = evt.players.find(p=>p.id===run.playerId);
    if(!player){
      evt.currentRun=null;
      finishOverlay.classList.remove('show');
      return;
    }
    const wins = Math.max(0,parseInt(runWinsInput.value,10)||0);
    const losses = Math.max(0,parseInt(runLossesInput.value,10)||0);
    const colors = Array.from(selectedColorSet).sort().join('');
    const matchType = matchTypeSelect.value;
    player.overallWins += wins;
    player.overallLosses += losses;
    if(colors){
      let deck = player.decks.find(d=>d.color===colors);
      if(!deck){
        // Check 15 deck limit
        if(player.decks.length >= 15){
          // Remove deck with lowest win percentage
          const sorted = player.decks.slice().sort((a,b)=>{
            const winRateA = (a.wins+a.losses)>0 ? a.wins/(a.wins+a.losses) : 0;
            const winRateB = (b.wins+b.losses)>0 ? b.wins/(b.wins+b.losses) : 0;
            if(winRateA !== winRateB) return winRateA - winRateB;
            return (a.wins+a.losses) - (b.wins+b.losses);
          });
          const toRemove = sorted[0];
          const idx = player.decks.indexOf(toRemove);
          if(idx >= 0){
            player.decks.splice(idx, 1);
            log(`${player.name} reached 15 deck limit. Removed deck ${toRemove.color} (lowest win rate).`);
          }
        }
        deck = {color:colors,wins:0,losses:0,lastBestOf:null};
        player.decks.push(deck);
      }
      deck.wins += wins;
      deck.losses += losses;
      deck.lastBestOf = matchType;
    }
    const hits = (currentWinnerMeta && currentWinnerMeta.hits) || 3;
    const bonus = hits>=5 ? 2 : hits===4 ? 1 : 0;

    // Check if this was a 4/5-of-a-kind and they chose extra games
    if(bonus > 0 && bonusRewardChoice === 'games' && !player.extraGamesRemaining){
      player.extraGamesRemaining = bonus;
      log(`${player.name} chose extra games bonus: ${bonus} additional game(s) remaining`);
    }

    // Check if player has extra games remaining
    if(player.extraGamesRemaining && player.extraGamesRemaining > 0){
      player.extraGamesRemaining--;
      if(player.extraGamesRemaining > 0){
        log(`${player.name} finished game. ${player.extraGamesRemaining} extra game(s) remaining.`);
        evt.currentRun=null;
        finishOverlay.classList.remove('show');
        // Show them in the finish prompt again for next game
        setTimeout(()=> finishRunPrompt(player), 100);
        renderLeaderboard();
        saveAll();
        return;
      }else{
        log(`${player.name} finished all extra games. Re-entering queue.`);
        delete player.extraGamesRemaining;
      }
    }

    if(queueReaddChoice==='yes'){
      const bonusTickets = (bonus > 0 && bonusRewardChoice === 'tickets') ? bonus : 0;
      const baseTickets = 1 + bonusTickets;
      for(let i=0;i<5;i++){
        let newTickets = baseTickets;
        if(newTickets > TICKET_CAP){
          const overflow = newTickets - TICKET_CAP;
          newTickets = TICKET_CAP;
          applyOverflowToPity(player, overflow);
        }
        player.tickets[i] = newTickets;
      }
      player.pityTokens = 0;
      player.createdAt = Date.now();
      clampPlayer(player);
      log(`${player.name} re-added to queue with ${baseTickets} ticket(s) per reel.`);

      // When winner re-enters, double all other active players' tickets (patience reward)
      for(const other of evt.players){
        if(other.id === player.id) continue;
        if(other.status !== 'active') continue;
        doubleTicketsAllReels(other);
      }
      log(`All other players' tickets doubled (patience reward for ${player.name} re-entry).`);
    }else{
      player.status='afk';
      log(`${player.name} marked as AFK.`);
    }
    log(`Reported run for ${player.name}: ${wins}W/${losses}L, colors=${colors||'none'}, type=${matchType}`);
    evt.currentRun=null;
    finishOverlay.classList.remove('show');
    renderLeaderboard();
    saveAll();
  });

  function performSpin(){
    const evt = currentEvent();
    if(evt.currentRun){
      smallStatus.textContent = "Finish current run before next spin.";
      finishOverlay.classList.add('show');
      return;
    }
    const pityPick = findPityAutoPick(evt);
    if(pityPick){
      log(`Auto-pick from pity: ${pityPick.name}`);
      handleWinnerBanner(pityPick,'pity',3,false);
      renderLeaderboard();
      saveAll();
      return;
    }
    const activePlayers = evt.players.filter(p=>p.status==='active');
    if(activePlayers.length===0){
      smallStatus.textContent="No active players. Add someone first.";
      return;
    }
    spinBtn.disabled=true;
    leverEl.classList.add('pull');
    spinAnimationStart();
    smallStatus.textContent="Spinning…";
    setTimeout(()=>{
      spinAnimationStop();
      leverEl.classList.remove('pull');
      const symbols = buildSpinResult(evt);
      renderSpinResult(symbols);
      const reelPlayers=[];
      symbols.forEach((s,idx)=>{
        if(s.type==='player') reelPlayers.push({index:idx,playerId:s.playerId});
      });
      const isCarlo = detectCarlo(symbols);
      let winner=null;
      let reason='normal';
      let hits=3;
      let isLunaWin=false;
      if(isCarlo){
        evt.carloHits++;
        winnerOverlay.classList.add('show');
        winnerHeading.textContent='CARLO!';
        winnerNameEl.textContent='CARLO';
        winnerMetaEl.textContent='Streamer plays their own deck this round.';
        winnerLunaSticker.style.display='none';
        pendingWinner=null;
        currentWinnerMeta={reason:'carlo',hits:0};
        evt.spinCount++;
        evt.deadSpinStreak=0;
        renderLeaderboard();
        saveAll();
        spinBtn.disabled=false;
        smallStatus.textContent="Ready.";
        return;
      }
      const lunaPick = detectLunaWinner(evt,symbols);
      if(lunaPick){
        winner = lunaPick.player;
        reason='luna';
        hits = lunaPick.hits;
        isLunaWin=true;
        evt.lunaHits++;
      }else{
        const hit = detectHitWinner(evt,symbols);
        if(hit){
          winner = hit.player;
          reason='normal';
          hits = hit.hits;
        }
      }
      if(winner){
        handleWinTickets(evt,winner,symbols,reelPlayers);
        log(`${winner.name} wins the slot (${reason}, hits=${hits}).`);
        handleWinnerBanner(winner,reason,hits,isLunaWin);
      }else{
        evt.deadSpinStreak++;
        log(`Dead spin (#${evt.deadSpinStreak}).`);
        handleDeadSpinTickets(evt,symbols,reelPlayers);
      }
      evt.spinCount++;
      renderLeaderboard();
      saveAll();
      spinBtn.disabled=false;
      smallStatus.textContent="Ready.";
    },800);
  }

  spinBtn.addEventListener('click',performSpin);
  leverEl.addEventListener('click',performSpin);

  addPlayerForm.addEventListener('submit',e=>{
    e.preventDefault();
    addPlayer(playerNameInput.value||'');
    playerNameInput.value='';
  });
  eventChipsEl.addEventListener('click',e=>{
    const chip = e.target.closest('.event-chip');
    if(!chip) return;
    const idx = parseInt(chip.dataset.index,10);
    state.currentEventIndex = idx;
    log(`Switched to event #${idx}.`);
    renderEvents();
    renderLeaderboard();
    saveAll();
  });

  helpBtn.addEventListener('click',()=>helpOverlay.classList.add('show'));
  closeHelpBtn.addEventListener('click',()=>helpOverlay.classList.remove('show'));
  diagBtn.addEventListener('click',()=>diagOverlay.classList.add('show'));
  closeDiagBtn.addEventListener('click',()=>diagOverlay.classList.remove('show'));
  exportBtn.addEventListener('click',()=>{
    const exportData = {
      version: '1.0',
      exportDate: new Date().toISOString(),
      state: state,
      theme: document.body.className
    };
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `carlo-slot-session-${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    log('Session exported successfully.');
  });

  importBtn.addEventListener('click',()=>{
    importFileInput.click();
  });

  importFileInput.addEventListener('change',e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = evt=>{
      try{
        const imported = JSON.parse(evt.target.result);
        if(!imported.state){
          alert('Invalid import file: missing state data.');
          return;
        }
        if(!confirm('Import will replace ALL current data. Continue?')) return;
        state.events = imported.state.events || [];
        state.currentEventIndex = imported.state.currentEventIndex || 1;
        if(imported.theme){
          const themeMatch = imported.theme.match(/theme-(white|blue|black|red|green)/);
          if(themeMatch){
            const colorMap = {white:'W',blue:'U',black:'B',red:'R',green:'G'};
            applyTheme(colorMap[themeMatch[1]]);
          }
        }
        log('Session imported successfully.');
        renderEvents();
        renderLeaderboard();
        saveAll();
      }catch(err){
        alert('Import failed: ' + err.message);
      }
    };
    reader.readAsText(file);
    importFileInput.value = '';
  });

  resetEventBtn.addEventListener('click',()=>{
    if(!confirm("Factory reset this event? All players and stats for this event will be lost."))return;
    state.events[state.currentEventIndex]={
      players:[],
      spinCount:0,
      deadSpinStreak:0,
      currentRun:null,
      carloHits:0,
      lunaHits:0
    };
    log(`Event #${state.currentEventIndex} reset.`);
    renderLeaderboard();
    saveAll();
  });

  runDiagNowBtn.addEventListener('click',()=>{
    const evt = currentEvent();
    const players = evt.players.filter(p=>p.status==='active');
    if(players.length===0){
      diagResult.innerHTML='<span class="warn">No active players. Add some before running diagnostics.</span>';
      return;
    }
    const sim = runDiagnosticsSimulation(evt,150);
    const passWins = sim.wins>=50;
    const passCarlo = sim.carlo>=2;
    const passLuna = sim.luna>=5;
    const passFourKind = sim.fourKind>=1;
    const passFiveKind = sim.fiveKind>=1;
    const allPass = passWins && passCarlo && passLuna && passFourKind && passFiveKind;
    diagResult.innerHTML = `
      <div><strong>Simulated 150 spins:</strong></div>
      <div>Total wins: ${sim.wins} ${passWins?'<span class="pass">(≥50 ✓)</span>':'<span class="warn">(Need ≥50)</span>'}</div>
      <div>CARLO jackpots: ${sim.carlo} ${passCarlo?'<span class="pass">(≥2 ✓)</span>':'<span class="warn">(Need ≥2)</span>'}</div>
      <div>Luna Luck wins: ${sim.luna} ${passLuna?'<span class="pass">(≥5 ✓)</span>':'<span class="warn">(Need ≥5)</span>'}</div>
      <div>4-of-a-kind: ${sim.fourKind} ${passFourKind?'<span class="pass">(≥1 ✓)</span>':'<span class="warn">(Need ≥1)</span>'}</div>
      <div>5-of-a-kind: ${sim.fiveKind} ${passFiveKind?'<span class="pass">(≥1 ✓)</span>':'<span class="warn">(Need ≥1)</span>'}</div>
      <div style="margin-top:8px;font-weight:700;">${allPass?'<span class="pass">All checks PASSED ✓</span>':'<span class="warn">Some checks FAILED</span>'}</div>
    `;
  });

  function runDiagnosticsSimulation(evt, spins){
    const players = evt.players.filter(p=>p.status==='active').map(p=>{
      return {
        name:p.name,
        tickets:p.tickets.slice(),
        pityTokens:p.pityTokens,
        createdAt:p.createdAt
      };
    });
    function randomPlayer(idx, arr){
      let tot=0;
      arr.forEach(p=>tot+=p.tickets[idx]);
      const r=Math.random()*tot;
      let x=r;
      for(const p of arr){
        if(x < p.tickets[idx]) return p;
        x -= p.tickets[idx];
      }
      return arr[arr.length-1];
    }
    function normTickets(){
      players.forEach(p=>{
        const tot=totalTickets(p);
        if(tot===0) p.tickets=[1,1,1,1,1];
      });
    }
    normTickets();
    let wins=0, carlo=0, luna=0, fourKind=0, fiveKind=0;
    for(let spin=0;spin<spins;spin++){
      const candPity = players.filter(p=>p.pityTokens>=MAX_PITY_TOKENS);
      if(candPity.length>0){
        candPity.sort((a,b)=>{
          if(a.createdAt !== b.createdAt) return a.createdAt - b.createdAt;
          if(b.pityTokens !== a.pityTokens) return b.pityTokens - a.pityTokens;
          const td = totalTickets(b) - totalTickets(a);
          return td !== 0 ? td : a.name.localeCompare(b.name);
        });
        const p = candPity[0];
        wins++;p.pityTokens=0;
        continue;
      }
      const active = players.slice();
      const symbols=[];
      let lunaIndex=-1;
      if(Math.random() < LUNA_BASE_ODDS){
        lunaIndex=Math.floor(Math.random()*5);
      }
      const letters=['C','A','R','L','O'];
      for(let i=0;i<5;i++){
        if(i===lunaIndex){symbols.push({type:'luna'});continue;}
        if(Math.random() < CARLO_LETTER_ODDS){
          symbols.push({type:'letter',letter:letters[i]});
        }else{
          const p = randomPlayer(i,active);
          symbols.push({type:'player',name:p.name});
        }
      }
      if(symbols.every((s,i)=>s.type==='letter' && s.letter===letters[i])){carlo++;continue;}
      let lunaWinner=null;
      if(lunaIndex!==-1){
        for(let i=-2;i<=0;i++){
          const idx=lunaIndex+i;
          if(idx<0||idx+2>=5) continue;
          const triple=symbols.slice(idx,idx+3);
          const ps=triple.filter(x=>x.type==='player');
          if(ps.length===0) continue;
          const cts={};ps.forEach(x=>cts[x.name]=(cts[x.name]||0)+1);
          const candidate=Object.keys(cts).find(n=>cts[n]>=2);
          if(candidate){
            lunaWinner=candidate;break;
          }else if(ps.length===1){
            lunaWinner=ps[0].name;break;
          }
        }
      }
      if(lunaWinner){luna++;wins++;continue;}
      const hits={};
      let hitPlayer=null;let hitCount=0;
      symbols.forEach(s=>{
        if(s.type==='player'){
          hits[s.name]=(hits[s.name]||0)+1;
          if(hits[s.name]>hitCount){
            hitPlayer=s.name;
            hitCount=hits[s.name];
          }
        }
      });
      if(hitCount>=3){
        wins++;
        if(hitCount===4) fourKind++;
        if(hitCount===5) fiveKind++;
      }
    }
    return {wins, carlo, luna, fourKind, fiveKind};
  }

  function applyTheme(code){
    const classes = ['theme-white','theme-blue','theme-black','theme-red','theme-green'];
    document.body.classList.remove(...classes);
    let cls='';
    if(code==='W') cls='theme-white';
    else if(code==='U') cls='theme-blue';
    else if(code==='B') cls='theme-black';
    else if(code==='R') cls='theme-red';
    else if(code==='G') cls='theme-green';
    document.body.classList.add(cls);
    themeChips.forEach(ch=>{
      ch.classList.toggle('active', ch.dataset.color===code);
    });
    localStorage.setItem('carlo_theme', code);
  }

  themeChips.forEach(ch=>{
    ch.addEventListener('click',()=>applyTheme(ch.dataset.color));
  });

  function loadTheme(){
    const saved = localStorage.getItem('carlo_theme') || 'U';
    applyTheme(saved);
  }

  function init(){
    loadAll();
    initBulbs();
    setupReelsPlaceholder();
    renderEvents();
    renderLeaderboard();
    loadTheme();
    timeTimer = setInterval(renderLeaderboard, 30000);
  }
  init();
})();
</script>
</body>
</html>
