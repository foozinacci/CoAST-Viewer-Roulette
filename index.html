<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CARLO Viewer Slot Machine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;800&display=swap');

    :root{
      --bg:#15100c;
      --panel:#0b0a09;
      --border:#3f2f19;
      --accent:#f9fafb;
      --blue:#38bdf8;
      --red:#fb4b4b;
      --green:#22c55e;
      --gold:#facc15;
      --text:#fef9c3;
      --muted:#d1bfa1;
      --danger:#f97373;
      --ok:#4ade80;
      --theme-color:#ffffff;
      --theme-glow:rgba(255,255,255,0.4);
      --gradient-border:linear-gradient(90deg, #ffffff, #e5e7eb, #d1d5db, #ffffff);
      --gradient-border-size:200%;
      --logo-ring-gradient:conic-gradient(from 0deg, #ffffff 0deg 60deg, transparent 60deg 120deg, #ffffff 120deg 180deg, transparent 180deg 240deg, #ffffff 240deg 300deg, transparent 300deg 360deg);
    }
    body.theme-white{
      --bg:#1f2937;
      --panel:#111827;
      --accent:#fefce8;
      --gold:#facc15;
      --blue:#60a5fa;
      --red:#f97373;
      --green:#4ade80;
      --text:#f9fafb;
      --muted:#e5e7eb;
      --theme-color:#fefce8;
      --theme-glow:rgba(254,252,232,0.6);
      --border:#fefce8;
    }
    body.theme-blue{
      --bg:#020617;
      --panel:#0f172a;
      --accent:#dbeafe;
      --blue:#93c5fd;
      --red:#fb4b4b;
      --green:#22c55e;
      --gold:#facc15;
      --text:#dbeafe;
      --muted:#cbd5e1;
      --theme-color:#93c5fd;
      --theme-glow:rgba(147,197,253,0.7);
      --border:#93c5fd;
    }
    body.theme-black{
      --bg:#1e1b29;
      --panel:#2d2838;
      --accent:#e9d5ff;
      --gold:#eab308;
      --blue:#c084fc;
      --red:#fb4b4b;
      --green:#22c55e;
      --text:#e9d5ff;
      --muted:#d8b4fe;
      --theme-color:#c084fc;
      --theme-glow:rgba(192,132,252,0.7);
      --border:#c084fc;
    }
    body.theme-red{
      --bg:#3f0f12;
      --panel:#1f0507;
      --accent:#fee2e2;
      --gold:#fb923c;
      --blue:#22d3ee;
      --red:#ef4444;
      --green:#22c55e;
      --text:#fee2e2;
      --muted:#fecaca;
      --theme-color:#ef4444;
      --theme-glow:rgba(239,68,68,0.6);
      --border:#ef4444;
    }
    body.theme-green{
      --bg:#022c22;
      --panel:#051b15;
      --accent:#dcfce7;
      --gold:#facc15;
      --blue:#38bdf8;
      --red:#fb4b4b;
      --green:#22c55e;
      --text:#ecfdf5;
      --muted:#a7f3d0;
      --theme-color:#22c55e;
      --theme-glow:rgba(34,197,94,0.6);
      --border:#22c55e;
    }
    body.theme-gold{
      --bg:#1e1814;
      --panel:#2d2410;
      --accent:#fef9c3;
      --gold:#fcd34d;
      --blue:#60a5fa;
      --red:#fb4b4b;
      --green:#22c55e;
      --text:#fef9c3;
      --muted:#fde68a;
      --theme-color:#fcd34d;
      --theme-glow:rgba(252,211,77,0.8);
      --border:#fcd34d;
    }

    @keyframes gradientShift{
      0%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
      100%{background-position:0% 50%;}
    }

    @keyframes rotate{
      0%{transform:rotate(0deg);}
      100%{transform:rotate(360deg);}
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      overflow-x:hidden;
      width:100%;
    }
    body{
      font-family:'Cinzel',serif;
      background:
        /* Weathered texture overlay */
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(143,82,57,0.03) 2px, rgba(143,82,57,0.03) 4px),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(143,82,57,0.03) 2px, rgba(143,82,57,0.03) 4px),
        /* Subtle noise/grain */
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(0,0,0,0.15) 0%, transparent 50%),
        /* Base gradient with #8f5239 */
        radial-gradient(circle at top, #8f5239 0%, rgba(143,82,57,0.7) 30%, var(--bg) 60%, #000 100%);
      color:var(--text);
      display:flex;
      justify-content:center;
      min-height:100vh;
    }
    #app{
      width:100%;
      max-width:1200px;
      margin:8px;
      border-radius:18px;
      border:2px solid var(--border);
      background:linear-gradient(145deg,var(--bg) 0,var(--bg) 40%,#050816 100%);
      box-shadow:0 0 40px rgba(0,0,0,.8),0 0 30px var(--theme-glow),inset 0 0 20px var(--theme-glow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }
    header{
      padding:12px 16px;
      border-bottom:2px solid var(--border);
      box-shadow:0 2px 12px var(--theme-glow);
    }
    .header-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      width:100%;
    }
    .header-spin-controls{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      flex-shrink:0;
    }
    .logo{
      width:110px;
      height:110px;
      overflow:visible;
      background:radial-gradient(circle, rgba(250,204,21,0.15) 0%, rgba(250,204,21,0.05) 70%, transparent 100%);
      background-clip:padding-box;
      border:3px solid transparent;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 20px rgba(250,204,21,0.2), inset 0 0 20px rgba(250,204,21,0.1);
      position:relative;
    }
    .logo::after{
      content:'';
      position:absolute;
      inset:-3px;
      border-radius:50%;
      padding:3px;
      background:var(--logo-ring-gradient, conic-gradient(from 0deg,
        var(--theme-color) 0deg 60deg,
        transparent 60deg 120deg,
        var(--theme-color) 120deg 180deg,
        transparent 180deg 240deg,
        var(--theme-color) 240deg 300deg,
        transparent 300deg 360deg));
      -webkit-mask:radial-gradient(farthest-side, transparent calc(100% - 3px), #fff calc(100% - 3px));
      mask:radial-gradient(farthest-side, transparent calc(100% - 3px), #fff calc(100% - 3px));
      pointer-events:none;
      animation:rotate 2s linear infinite;
      z-index:1;
    }
    .logo::before{
      content:'';
      position:absolute;
      inset:0;
      border-radius:50%;
      background:var(--bg);
      z-index:-1;
    }
    .logo img{
      width:80%;
      height:80%;
      object-fit:contain;
      filter:none;
      position:relative;
      z-index:2;
    }
    .title-block{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      flex:1;
    }
    .title{
      font-size:22px;
      font-weight:700;
      letter-spacing:.08em;
      color:var(--gold);
      text-shadow:0 0 8px rgba(250,204,21,.4);
    }
    .subtitle{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.06em;
      opacity:0.8;
    }
    .theme-toggle{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      margin-top:4px;
    }
    .theme-chip{
      width:30px;
      height:30px;
      border-radius:999px;
      border:1px solid var(--border);
      cursor:pointer;
      opacity:.7;
      display:flex;
      align-items:center;
      justify-content:center;
      background-color:transparent;
      background-repeat:no-repeat;
      background-position:center;
      background-size:contain;
      color:transparent;
      text-indent:-9999px;
    }
    .theme-chip.active{
      opacity:1;
      box-shadow:0 0 10px rgba(148,163,184,.9);
    }
    .theme-chip[data-color="W"]{background-image:url('https://i.ibb.co/sJpHH9VZ/W.png');}
    .theme-chip[data-color="U"]{background-image:url('https://i.ibb.co/0bPLHLk/U.png');}
    .theme-chip[data-color="B"]{background-image:url('https://i.ibb.co/nM1ZZz3z/B.png');}
    .theme-chip[data-color="R"]{background-image:url('https://i.ibb.co/NnjxnmZv/R.png');}
    .theme-chip[data-color="G"]{background-image:url('https://i.ibb.co/tM5Mb1Q0/G.png');}

    main{
      flex:1;
      display:flex;
      flex-direction:column;
      overflow:auto;
    }
    .slot-layout{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:10px;
    }
    @media(max-width:640px){
      #app{
        margin:0;
        border-radius:0;
        min-height:100vh;
      }
      header{
        padding:8px 12px;
        gap:6px;
      }
      .logo{
        width:90px;
        height:90px;
      }
      .logo img{
        width:75%;
        height:75%;
      }
      .title{
        font-size:18px;
      }
      .subtitle{
        font-size:10px;
      }
      .theme-toggle{
        gap:4px;
      }
      .theme-chip{
        width:26px;
        height:26px;
      }
      .header-top{
        flex-direction:column;
        align-items:center;
      }
      .header-spin-controls{
        width:100%;
        justify-content:center;
      }
      .spin-button{
        font-size:16px;
        padding:10px 32px;
      }
      .slot-layout{
        padding:6px;
        gap:6px;
      }
      .bottom-panels-container{
        flex-direction:column;
      }
      .history-panel,.leaderboard-panel{
        flex:1 1 auto;
        min-height:200px;
        max-width:100%;
        width:100%;
      }
      .slot-panel,.leaderboard-panel{
        padding:8px;
      }
      .lever{
        display:none;
      }
      .lever-knob{
        display:none;
      }
      .lever.pull .lever-knob{display:none;}
      .reels-shell{
        padding:12px;
      }
      .reel-charts-wrapper{
        margin:8px 0;
      }
      .reel-charts{
        gap:8px;
      }
      .pie-chart{
        width:48px;
        height:48px;
        flex-shrink:0;
      }
      .pie-chart-inner{
        width:34px;
        height:34px;
        font-size:9px;
      }
      .reel-chart-label{
        font-size:9px;
      }
      .ticket-btn{
        width:20px;
        height:20px;
        font-size:12px;
      }
      .ticket-count{
        font-size:10px;
        min-width:24px;
      }
      .player-card{
        padding:10px;
        max-width:100%;
        overflow:hidden;
        word-wrap:break-word;
      }
      .winner-card,.help-card{
        max-width:calc(100vw - 20px);
        margin:0 10px;
        max-height:90vh;
        overflow-y:auto;
        overflow-x:hidden;
      }
      .help-body{
        max-height:60vh;
        overflow-y:auto;
        overflow-x:hidden;
      }
      .deck-table-wrapper{
        max-width:100%;
        overflow-x:auto;
      }
      .diag-result{
        word-wrap:break-word;
        overflow-wrap:break-word;
      }
    }
    .bottom-panels-container{
      display:flex;
      gap:12px;
      width:100%;
      max-width:100%;
      box-sizing:border-box;
    }
    .history-panel{
      flex:0 0 calc(40% - 4px);
      max-width:calc(40% - 4px);
      background:radial-gradient(circle at top,var(--panel) 0,var(--bg) 50%,#000 100%);
      border-radius:16px;
      border:3px solid transparent;
      background-clip:padding-box;
      padding:10px;
      box-shadow:none;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .history-panel::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:16px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .history-header{
      text-align:center;
      font-size:14px;
      font-weight:700;
      color:var(--gold);
      text-shadow:0 0 12px rgba(250,204,21,.6);
      margin-bottom:8px;
      text-transform:uppercase;
      letter-spacing:.15em;
    }
    .slot-panel,.leaderboard-panel{
      background:radial-gradient(circle at top,var(--panel) 0,var(--bg) 50%,#000 100%);
      border-radius:16px;
      border:3px solid transparent;
      background-clip:padding-box;
      padding:10px;
      box-shadow:none;
      position:relative;
      overflow:hidden;
    }
    .leaderboard-panel{
      flex:0 0 calc(60% - 8px);
      display:flex;
      flex-direction:column;
      order:-1;
      max-width:calc(60% - 8px);
    }
    .slot-panel::after,.leaderboard-panel::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:16px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .slot-panel::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at top,rgba(250,250,250,.04) 0,transparent 55%),radial-gradient(circle at center,rgba(56,189,248,.05) 0,transparent 55%),radial-gradient(circle at bottom,rgba(236,72,153,.07) 0,transparent 60%);
      opacity:.5;
      pointer-events:none;
    }
    .slot-header{
      display:none;
    }
    .slot-title{
      display:none;
    }
    #statusText{
      display:none;
    }
    .status-text{
      display:none;
    }
    .reels-shell{
      position:relative;
      padding:18px 18px 18px 18px;
    }
    .bulb-row{
      position:absolute;
      left:20px;
      right:20px;
      height:8px;
      display:flex;
      justify-content:space-between;
      pointer-events:none;
    }
    .bulb-row.top{top:4px;}
    .bulb-row.bottom{bottom:4px;}
    .bulb-col{
      position:absolute;
      top:18px;
      bottom:18px;
      width:8px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      pointer-events:none;
    }
    .bulb-col.left{left:4px;}
    .bulb-col.right{right:4px;}
    .bulb{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#4b5563;
      box-shadow:0 0 4px rgba(0,0,0,.8);
    }
    .bulb.active{
      box-shadow:0 0 10px currentColor;
    }
    .reels-box{
      position:relative;
      border-radius:16px;
      border:3px solid transparent;
      background:linear-gradient(180deg,#020617 0,#020617 40%,#000 100%);
      background-clip:padding-box;
      padding:10px 8px 14px;
      box-shadow:0 0 26px var(--theme-glow);
      overflow:hidden;
    }
    .reels-box::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:16px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .reel-labels{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
      font-size:10px;
      color:var(--muted);
      letter-spacing:.10em;
    }
    .reels{display:flex;gap:6px;justify-content:space-between;}
    .reel{
      flex:1;
      background:radial-gradient(circle at top,#020617 0,#000 70%);
      border-radius:12px;
      border:1px solid rgba(148,116,72,.7);
      padding:16px 4px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      box-shadow:inset 0 0 18px rgba(15,23,42,.9),0 0 18px rgba(0,0,0,.9);
    }
    .reel-inner{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      transform:translateY(0);
      transition:transform .18s ease-out;
    }
    .reel-symbol{
      font-size:13px;
      font-weight:700;
      padding:4px 8px;
      border-radius:8px;
      width:100px;
      min-height:48px;
      text-align:center;
      box-shadow:0 0 10px rgba(15,23,42,.9);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1.2;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .reel-symbol.player{
      background:rgba(15,23,42,.95);
      border:1px solid rgba(248,250,252,.25);
      color:var(--accent);
      text-shadow:0 0 8px rgba(248,250,252,.7);
    }
    .reel-symbol.letter{
      background:rgba(15,23,42,.95);
      border:1px solid var(--gold);
      color:var(--gold);
      text-shadow:0 0 12px rgba(250,204,21,.9);
    }
    .reel-symbol.luna{
      background:rgba(15,23,42,.95);
      border:1px solid #f973fa;
      box-shadow:0 0 16px rgba(244,114,182,.9);
      color:#f9a8d4;
    }
    .reel-symbol.luna img{
      max-width:40px;
      max-height:40px;
      border-radius:999px;
      display:block;
    }
    .reel:nth-child(1) .reel-symbol.player{
      border-color:#fef9c3;
      box-shadow:0 0 12px rgba(250,250,209,.9);
      color:#fefce8;
    }
    .reel:nth-child(2) .reel-symbol.player{
      border-color:#38bdf8;
      box-shadow:0 0 12px rgba(56,189,248,.9);
      color:#e0f2fe;
    }
    .reel:nth-child(3) .reel-symbol.player{
      border-color:#4b5563;
      box-shadow:0 0 12px rgba(15,23,42,.95);
      color:#f9fafb;
    }
    .reel:nth-child(4) .reel-symbol.player{
      border-color:#fb4b4b;
      box-shadow:0 0 12px rgba(248,113,113,.9);
      color:#fee2e2;
    }
    .reel:nth-child(5) .reel-symbol.player{
      border-color:#22c55e;
      box-shadow:0 0 12px rgba(34,197,94,.9);
      color:#dcfce7;
    }
    .reel.glow-win{
      box-shadow:0 0 28px rgba(250,204,21,.8),inset 0 0 20px rgba(250,250,250,.1);
      border-color:var(--gold);
    }
    .reel.glow-carlo{
      box-shadow:0 0 26px rgba(56,189,248,.9),inset 0 0 20px rgba(15,23,42,.95);
      border-color:var(--blue);
    }
    .reel.glow-luna{
      box-shadow:0 0 24px rgba(244,114,182,.95),inset 0 0 18px rgba(24,24,27,.9);
      border-color:#f973fa;
    }
    @keyframes reelCycle{
      0%, 100%{opacity:1;}
      50%{opacity:0.3;}
    }
    .reel.spinning .reel-symbol{
      animation:reelCycle 0.15s linear infinite;
    }
    .reel.spinning .reel-inner{
      display:flex;
      flex-direction:column;
    }
    .slot-controls{
      margin-top:12px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      position:relative;
      z-index:1;
    }
    .status-text{font-size:11px;color:var(--muted);}
    /* Lever removed - spin button is sufficient */
    .lever{
      display:none;
    }
    .lever-knob{
      display:none;
    }
    .lever.pull .lever-knob{display:none;}
    .spin-button{
      border-radius:999px;
      padding:14px 42px;
      border:3px solid transparent;
      font-size:20px;
      font-weight:900;
      letter-spacing:.12em;
      cursor:pointer;
      background:radial-gradient(circle at top,#fef3c7 0,#fde68a 50%,#fcd34d 100%);
      background-clip:padding-box;
      color:#78350f;
      text-shadow:none;
      box-shadow:none;
      transition:transform .1s ease-out,box-shadow .1s ease-out,opacity .1s ease-out;
      position:relative;
      overflow:hidden;
    }
    .spin-button::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:999px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .spin-button:disabled{
      opacity:.45;
      cursor:default;
      box-shadow:0 0 6px rgba(0,0,0,.4);
    }
    .spin-button:active:not(:disabled){
      transform:translateY(1px) scale(.99);
      box-shadow:0 0 16px var(--theme-glow),inset 0 0 6px rgba(0,0,0,.4);
    }
    .side-panel-header{
      display:flex;
      justify-content:center;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      align-items:center;
    }
    .side-panel-section-title{
      font-size:14px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--gold);
      text-shadow:0 0 8px rgba(250,204,21,.4);
      margin-bottom:10px;
      text-align:center;
    }
    .add-player-form{
      display:flex;
      gap:6px;
      margin-bottom:8px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }
    .add-player-form input{
      flex:1;
      min-width:150px;
      max-width:100%;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-size:11px;
      padding:6px 8px;
    }
    .add-player-form button{
      border-radius:999px;
      border:3px solid transparent;
      background:radial-gradient(circle at top,#fef3c7 0,#fde68a 50%,#fcd34d 100%);
      background-clip:padding-box;
      font-size:12px;
      padding:6px 12px;
      color:#78350f;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.12em;
      cursor:pointer;
      text-shadow:none;
      box-shadow:none;
      position:relative;
      overflow:hidden;
    }
    /* Gold mode styling removed - all buttons now use pale gold */
    .add-player-form button::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:999px;
      padding:2px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .summary-cards{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-bottom:8px;
      font-size:11px;
    }
    .summary-card{
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      padding:6px 8px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .summary-label{
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.14em;
      font-size:10px;
    }
    .summary-value{font-weight:600;font-size:12px;}
    .leaderboard-wrapper{
      overflow:auto;
      border-radius:10px;
      border:2px solid rgba(148,116,72,.9);
      background:linear-gradient(145deg, rgba(30,30,30,0.95) 0%, rgba(0,0,0,0.9) 100%);
      margin-top:6px;
      box-shadow:0 0 16px rgba(0,0,0,0.5),inset 0 0 20px rgba(0,0,0,0.6);
      flex:1;
      min-height:0;
    }
    .leaderboard-wrapper::-webkit-scrollbar{
      width:8px;
      height:8px;
    }
    .leaderboard-wrapper::-webkit-scrollbar-track{
      background:rgba(0,0,0,0.3);
      border-radius:4px;
    }
    .leaderboard-wrapper::-webkit-scrollbar-thumb{
      background:var(--gradient-border);
      border-radius:4px;
      border:1px solid var(--border);
    }
    .leaderboard-wrapper::-webkit-scrollbar-thumb:hover{
      background:var(--theme-color);
      box-shadow:0 0 8px var(--theme-glow);
    }
    .leaderboard-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .leaderboard-table thead{
      background:rgba(0,0,0,0.95);
      position:sticky;
      top:0;
      z-index:1;
      box-shadow:0 2px 8px rgba(0,0,0,0.6);
    }
    .leaderboard-table th{
      font-weight:700;
      letter-spacing:0.05em;
      color:#d1bfa1;
      text-shadow:none;
    }
    .leaderboard-table th,
    .leaderboard-table td{
      border-bottom:1px solid rgba(148,116,72,.3);
      padding:4px 6px;
      text-align:center;
      vertical-align:top;
    }
    .leaderboard-table th{
      letter-spacing:.12em;
      font-size:10px;
      color:#d1bfa1;
    }
    .player-row{cursor:pointer;}
    .player-row:hover{background:rgba(17,24,39,.9);}
    .time-cell{
      font-size:10px;
      color:#10b981;
      text-shadow:0 0 8px rgba(16,185,129,.6), 0 0 4px rgba(16,185,129,.8);
      white-space:nowrap;
      font-weight:600;
    }
    .sparks-count{font-size:10px;color:var(--muted);}
    .win-rate-good{color:var(--text);font-weight:600;}
    .win-rate-medium{color:var(--text);font-weight:600;}
    .win-rate-poor{color:#ef4444;font-weight:600;}
    .actions-cell{
      font-size:14px;
      text-align:center;
    }
    .actions-cell button{
      border:none;
      background:transparent;
      cursor:pointer;
      color:var(--muted);
    }
    .log{
      font-size:11px;
      overflow-y:auto;
      color:var(--muted);
      text-align:left;
      padding:8px;
      flex:1;
      min-height:0;
    }
    .log::-webkit-scrollbar{
      width:8px;
    }
    .log::-webkit-scrollbar-track{
      background:rgba(0,0,0,0.3);
      border-radius:4px;
    }
    .log::-webkit-scrollbar-thumb{
      background:var(--gradient-border);
      border-radius:4px;
      border:1px solid var(--border);
    }
    .log::-webkit-scrollbar-thumb:hover{
      background:var(--theme-color);
      box-shadow:0 0 8px var(--theme-glow);
    }
    .help-body::-webkit-scrollbar,
    .help-card::-webkit-scrollbar,
    .deck-table-wrapper::-webkit-scrollbar,
    .reel-charts-wrapper::-webkit-scrollbar{
      width:8px;
      height:8px;
    }
    .help-body::-webkit-scrollbar-track,
    .help-card::-webkit-scrollbar-track,
    .deck-table-wrapper::-webkit-scrollbar-track,
    .reel-charts-wrapper::-webkit-scrollbar-track{
      background:rgba(0,0,0,0.3);
      border-radius:4px;
    }
    .help-body::-webkit-scrollbar-thumb,
    .help-card::-webkit-scrollbar-thumb,
    .deck-table-wrapper::-webkit-scrollbar-thumb,
    .reel-charts-wrapper::-webkit-scrollbar-thumb{
      background:var(--gradient-border);
      border-radius:4px;
      border:1px solid var(--border);
    }
    .help-body::-webkit-scrollbar-thumb:hover,
    .help-card::-webkit-scrollbar-thumb:hover,
    .deck-table-wrapper::-webkit-scrollbar-thumb:hover,
    .reel-charts-wrapper::-webkit-scrollbar-thumb:hover{
      background:var(--theme-color);
      box-shadow:0 0 8px var(--theme-glow);
    }
    .log-timestamp{
      color:var(--gold);
      font-weight:600;
      text-shadow:0 0 6px rgba(250,204,21,.4);
    }
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.88);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .overlay.show{display:flex;}
    .winner-card{
      width:calc(100% - 20px);
      max-width:420px;
      margin:0 auto;
      border-radius:18px;
      border:3px solid transparent;
      background:radial-gradient(circle at top,#1e293b 0,#020617 50%,#000 100%);
      background-clip:padding-box;
      padding:14px 16px 18px;
      box-shadow:0 0 40px rgba(250,204,21,.8);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .winner-card::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:18px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .winner-heading{
      font-size:20px;
      font-weight:900;
      letter-spacing:.12em;
      color:var(--gold);
      text-shadow:0 0 14px rgba(250,204,21,1);
      margin-bottom:6px;
    }
    .winner-name{
      font-size:18px;
      font-weight:800;
      margin-bottom:4px;
    }
    .winner-meta{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .winner-actions{
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .winner-actions button{
      border-radius:999px;
      border:3px solid transparent;
      background:radial-gradient(circle at top,#fef3c7 0,#fde68a 50%,#fcd34d 100%);
      background-clip:padding-box;
      color:#78350f;
      font-size:11px;
      font-weight:700;
      padding:6px 10px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.12em;
      text-shadow:none;
      box-shadow:none;
      transition:transform .1s ease-out,box-shadow .1s ease-out,opacity .1s ease-out;
      position:relative;
      overflow:hidden;
    }
    /* Gold mode styling removed - all buttons now use pale gold */
    .winner-actions button::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:999px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .winner-actions button:hover{
      transform:scale(1.03);
      box-shadow:0 0 24px var(--theme-glow),inset 0 0 16px var(--theme-glow);
    }
    .winner-luna-sticker{
      position:absolute;
      right:-6px;
      bottom:-6px;
      width:96px;
      height:96px;
      opacity:.95;
    }
    .winner-luna-sticker img{
      width:100%;
      height:100%;
      object-fit:contain;
    }
    .finish-card{
      width:calc(100% - 20px);
      max-width:460px;
      margin:0 auto;
      border-radius:18px;
      border:3px solid transparent;
      background:var(--panel);
      background-clip:padding-box;
      padding:14px 16px 18px;
      box-shadow:0 0 30px rgba(0,0,0,.9);
      font-size:12px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .finish-card::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:18px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .finish-title{
      font-size:14px;
      font-weight:700;
      margin-bottom:4px;
      position:relative;
      z-index:10;
    }
    .finish-sub{
      font-size:11px;
      color:var(--muted);
      margin-bottom:10px;
      position:relative;
      z-index:10;
    }
    .finish-field{
      margin-bottom:8px;
      position:relative;
      z-index:10;
    }
    .finish-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-bottom:4px;
    }
    .finish-input-row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      position:relative;
      z-index:10;
      justify-content:center;
      max-width:100%;
    }
    .adjust-btn{
      border-radius:999px;
      border:3px solid transparent;
      background:radial-gradient(circle at top,#fef3c7 0,#fde68a 50%,#fcd34d 100%);
      background-clip:padding-box;
      color:#78350f;
      font-size:13px;
      font-weight:700;
      padding:8px 16px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.08em;
      text-shadow:none;
      box-shadow:none;
      transition:transform .1s ease-out,box-shadow .1s ease-out,opacity .1s ease-out;
      position:relative;
      z-index:10;
      overflow:hidden;
    }
    /* Gold mode styling removed - all buttons now use pale gold */
    .adjust-btn::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:999px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .adjust-btn:hover{
      transform:scale(1.03);
      box-shadow:0 0 24px var(--theme-glow),inset 0 0 16px var(--theme-glow);
    }
    .finish-input-row input[type="number"]{
      width:80px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      font-size:12px;
      padding:4px 8px;
    }
    .finish-input-row select{
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      font-size:12px;
      padding:4px 8px;
    }
    .color-chips{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      justify-content:center;
      position:relative;
      z-index:10;
    }
    .color-chip{
      border-radius:999px;
      border:1px solid var(--border);
      width:26px;
      height:26px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background-color:transparent;
      background-repeat:no-repeat;
      background-position:center;
      background-size:contain;
      color:transparent;
      text-indent:-9999px;
      opacity:.7;
      position:relative;
      z-index:10;
    }
    .color-chip.active{
      opacity:1;
      border-color:var(--gold);
      box-shadow:0 0 10px rgba(250,204,21,.7);
    }
    .color-chip[data-color="W"]{background-image:url("https://i.ibb.co/sJpHH9VZ/W.png");}
    .color-chip[data-color="U"]{background-image:url("https://i.ibb.co/0bPLHLk/U.png");}
    .color-chip[data-color="B"]{background-image:url("https://i.ibb.co/nM1ZZz3z/B.png");}
    .color-chip[data-color="R"]{background-image:url("https://i.ibb.co/NnjxnmZv/R.png");}
    .color-chip[data-color="G"]{background-image:url("https://i.ibb.co/tM5Mb1Q0/G.png");}
    .color-chip[data-color="C"]{background-image:url("https://i.ibb.co/xt4Lpn0X/C.png");}
    .queue-choice{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:center;
      position:relative;
      z-index:10;
    }
    .queue-chip{
      border-radius:999px;
      border:3px solid transparent;
      background:radial-gradient(circle at top,#fef3c7 0,#fde68a 50%,#fcd34d 100%);
      background-clip:padding-box;
      color:#78350f;
      padding:4px 10px;
      font-size:11px;
      font-weight:700;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.1em;
      text-shadow:none;
      box-shadow:none;
      opacity:.6;
      transition:transform .1s ease-out,box-shadow .1s ease-out,opacity .1s ease-out;
      position:relative;
      z-index:10;
      overflow:hidden;
    }
    .queue-chip::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:999px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .queue-chip.active{
      opacity:1;
      transform:scale(1.05);
      box-shadow:0 0 24px var(--theme-glow),inset 0 0 16px var(--theme-glow);
    }
    /* Gold mode styling removed - all buttons now use pale gold */
    .finish-actions{
      display:flex;
      justify-content:center;
      gap:6px;
      margin-top:8px;
      position:relative;
      z-index:10;
      flex-wrap:wrap;
      max-width:100%;
    }
    .finish-actions button{
      border-radius:999px;
      border:3px solid transparent;
      background:radial-gradient(circle at top,#fef3c7 0,#fde68a 50%,#fcd34d 100%);
      background-clip:padding-box;
      color:#78350f;
      font-size:11px;
      font-weight:700;
      padding:6px 10px;
      text-transform:uppercase;
      letter-spacing:.12em;
      cursor:pointer;
      text-shadow:none;
      box-shadow:none;
      transition:transform .1s ease-out,box-shadow .1s ease-out,opacity .1s ease-out;
      position:relative;
      z-index:10;
      overflow:hidden;
    }
    /* Gold mode styling removed - all buttons now use pale gold */
    .finish-actions button::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:999px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .finish-actions button:hover{
      transform:scale(1.03);
      box-shadow:0 0 24px var(--theme-glow),inset 0 0 16px var(--theme-glow);
    }
    .finish-actions button.primary{
      font-weight:900;
    }
    .player-card{
      width:calc(100% - 20px);
      max-width:640px;
      margin:0 auto;
      border-radius:16px;
      border:3px solid transparent;
      background:var(--panel);
      background-clip:padding-box;
      padding:12px 14px;
      box-shadow:0 0 30px rgba(0,0,0,.9);
      font-size:12px;
      position:relative;
      overflow:hidden;
    }
    .player-card::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:16px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .player-card-header{
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      margin-bottom:6px;
      gap:4px;
    }
    .player-card-name{
      font-weight:700;
      font-size:14px;
      text-align:center;
    }
    .player-card-status{
      font-size:11px;
      color:var(--muted);
    }
    .player-card-actions{
      display:flex;
      justify-content:center;
      gap:6px;
      margin:6px 0;
      flex-wrap:wrap;
    }
    .player-card-actions button{
      border-radius:999px;
      border:3px solid transparent;
      background:radial-gradient(circle at top,#fef3c7 0,#fde68a 50%,#fcd34d 100%);
      background-clip:padding-box;
      color:#78350f;
      font-size:11px;
      font-weight:700;
      padding:4px 8px;
      text-transform:uppercase;
      letter-spacing:.1em;
      cursor:pointer;
      text-shadow:none;
      box-shadow:none;
      transition:transform .1s ease-out,box-shadow .1s ease-out,opacity .1s ease-out;
      position:relative;
      overflow:hidden;
    }
    /* Gold mode styling removed - all buttons now use pale gold */
    .player-card-actions button::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:999px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .player-card-actions button:hover{
      transform:scale(1.03);
      box-shadow:0 0 24px var(--theme-glow),inset 0 0 16px var(--theme-glow);
    }
    .reel-charts-wrapper{
      width:100%;
      overflow-x:auto;
      overflow-y:hidden;
      margin:12px 0;
      padding:4px 0;
      -webkit-overflow-scrolling:touch;
    }
    .reel-charts{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      min-width:min-content;
    }
    .reel-chart{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }
    .reel-chart-label{
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.1em;
    }
    .pie-chart{
      width:60px;
      height:60px;
      border-radius:50%;
      position:relative;
      border:3px solid transparent;
      background:conic-gradient(var(--theme-color) 0% var(--percentage), rgba(0,0,0,.3) var(--percentage) 100%);
      background-clip:padding-box;
      box-shadow:0 0 20px var(--theme-glow),0 0 40px var(--theme-glow);
      display:flex;
      align-items:center;
      justify-content:center;
      filter:brightness(1.3);
      overflow:hidden;
      transition:all .15s ease-out;
    }
    .pie-chart::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:50%;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .pie-chart-inner{
      width:44px;
      height:44px;
      border-radius:50%;
      background:var(--bg);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:bold;
      color:var(--theme-color);
    }
    .reel-ticket-controls{
      display:flex;
      align-items:center;
      gap:6px;
      margin-top:4px;
    }
    .ticket-btn{
      width:24px;
      height:24px;
      border-radius:4px;
      border:2px solid transparent;
      background:rgba(0,0,0,0.3);
      background-clip:padding-box;
      color:var(--theme-color);
      font-size:14px;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .15s ease-out;
      box-shadow:0 0 6px var(--theme-glow);
      text-shadow:0 0 4px var(--theme-glow);
      position:relative;
      overflow:hidden;
    }
    .ticket-btn::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:4px;
      padding:2px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .ticket-btn:hover{
      background:var(--theme-color);
      color:var(--bg);
      box-shadow:0 0 12px var(--theme-glow);
      transform:scale(1.1);
    }
    .ticket-count{
      font-size:12px;
      font-weight:600;
      color:var(--text);
      opacity:0.7;
      min-width:32px;
      text-align:center;
    }
    .deck-table-wrapper{
      width:100%;
      overflow-x:auto;
      margin-top:6px;
      -webkit-overflow-scrolling:touch;
    }
    .deck-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      min-width:300px;
    }
    .deck-table th,.deck-table td{
      border-bottom:1px solid var(--border);
      padding:3px 4px;
      text-align:left;
      white-space:nowrap;
    }
    .deck-table th{
      text-transform:uppercase;
      letter-spacing:.1em;
      font-size:10px;
      color:var(--muted);
    }
    .footer-bar{
      position:sticky;
      bottom:0;
      left:0;
      right:0;
      padding:8px 10px;
      background:rgba(10,9,8,.95);
      border-top:1px solid var(--border);
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:11px;
      color:var(--muted);
    }
    .footer-buttons{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .footer-buttons button{
      border-radius:999px;
      border:3px solid transparent;
      background:radial-gradient(circle at top,#fef3c7 0,#fde68a 50%,#fcd34d 100%);
      background-clip:padding-box;
      color:#78350f;
      font-size:10px;
      font-weight:700;
      padding:4px 8px;
      text-transform:uppercase;
      letter-spacing:.1em;
      cursor:pointer;
      text-shadow:none;
      box-shadow:none;
      transition:transform .1s ease-out,box-shadow .1s ease-out,opacity .1s ease-out;
      position:relative;
      overflow:hidden;
    }
    /* Gold mode styling removed - all buttons now use pale gold */
    .footer-buttons button::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:999px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .footer-buttons button:hover{
      transform:scale(1.03);
      box-shadow:0 0 24px var(--theme-glow),inset 0 0 16px var(--theme-glow);
    }
    .help-card{
      width:calc(100% - 20px);
      max-width:520px;
      border-radius:16px;
      border:3px solid transparent;
      background:var(--panel);
      background-clip:padding-box;
      padding:12px 14px;
      box-shadow:0 0 30px rgba(0,0,0,.9);
      font-size:12px;
      position:relative;
      overflow-x:hidden;
      overflow-y:auto;
      max-height:90vh;
      margin:0 10px;
    }
    .help-card::after{
      content:'';
      position:absolute;
      inset:0;
      border-radius:16px;
      padding:3px;
      background:var(--gradient-border);
      background-size:var(--gradient-border-size) var(--gradient-border-size);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      animation:gradientShift 4s ease infinite;
      z-index:-1;
    }
    .help-title{
      font-size:14px;
      font-weight:700;
      margin-bottom:4px;
    }
    .help-section-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-top:8px;
      margin-bottom:2px;
    }
    .spark-progression{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      margin:12px 0;
      padding:12px;
      background:rgba(0,0,0,0.3);
      border-radius:8px;
      border:1px solid rgba(148,116,72,.3);
    }
    .spark-bulbs-row{
      display:flex;
      gap:10px;
      justify-content:center;
    }
    .spark-bulb{
      width:16px;
      height:16px;
      border-radius:50%;
      background:rgba(0,0,0,0.5);
      border:2px solid rgba(148,116,72,.5);
      transition:all .3s ease;
      position:relative;
    }
    .spark-bulb.lit{
      background:var(--theme-color);
      border-color:var(--theme-color);
      box-shadow:0 0 10px var(--theme-glow),0 0 20px var(--theme-glow),inset 0 0 8px var(--theme-glow);
      animation:sparkPulse 1.5s ease-in-out infinite;
    }
    @keyframes sparkPulse{
      0%, 100%{opacity:1;transform:scale(1);}
      50%{opacity:0.7;transform:scale(1.1);}
    }
    .spark-overflow-bulb{
      width:80px;
      height:24px;
      border-radius:12px;
      background:rgba(0,0,0,0.5);
      border:2px solid rgba(148,116,72,.5);
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .3s ease;
      position:relative;
    }
    .spark-overflow-bulb.ready.lit{
      background:#fcd34d;
      border-color:#fcd34d;
      box-shadow:0 0 12px rgba(252,211,77,0.6),0 0 24px rgba(252,211,77,0.4);
    }
    .spark-overflow-bulb.ignition.lit{
      background:linear-gradient(90deg, #fefce8, #38bdf8, #4b5563, #fb4b4b, #22c55e, #fefce8);
      background-size:200% 100%;
      border:2px solid transparent;
      background-clip:padding-box;
      box-shadow:0 0 12px rgba(252,211,77,0.6),0 0 24px rgba(56,189,248,0.4),0 0 12px rgba(239,68,68,0.4);
      animation:ignitionPulse 1s ease-in-out infinite, rainbowShift 3s linear infinite;
      position:relative;
    }
    .spark-overflow-bulb.ignition.lit::before{
      content:'';
      position:absolute;
      inset:-2px;
      border-radius:12px;
      background:linear-gradient(90deg, #fefce8, #38bdf8, #4b5563, #fb4b4b, #22c55e, #fefce8);
      background-size:200% 100%;
      z-index:-1;
      animation:rainbowShift 3s linear infinite;
    }
    @keyframes rainbowShift{
      0%{background-position:0% 50%;}
      100%{background-position:200% 50%;}
    }
    @keyframes ignitionPulse{
      0%, 100%{box-shadow:0 0 12px rgba(252,211,77,0.6),0 0 24px rgba(56,189,248,0.4),0 0 12px rgba(239,68,68,0.4);}
      50%{box-shadow:0 0 20px rgba(252,211,77,0.8),0 0 40px rgba(56,189,248,0.6),0 0 20px rgba(239,68,68,0.6);}
    }
    .spark-overflow-label{
      font-size:9px;
      font-weight:800;
      letter-spacing:.1em;
      color:rgba(255,255,255,0.4);
      text-transform:uppercase;
    }
    .spark-overflow-bulb.lit .spark-overflow-label{
      color:#000;
    }
    .help-body{
      font-size:11px;
      color:var(--muted);
    }
    .diag-result{
      margin-top:6px;
      font-size:11px;
      text-align:center;
    }
    .diag-result span.pass{color:var(--ok);}
    .diag-result span.warn{color:var(--danger);}
  </style>
</head>
<body class="theme-white">
<div id="app">
  <header>
    <div class="header-top">
      <div class="logo">
        <img src="https://i.ibb.co/PvbYChDZ/G0-Gsi-Gv-XIAEk-Rf1-removebg-preview.png" alt="CARLO"/>
      </div>
      <div class="title-block">
        <div class="title">Viewer Roulette</div>
        <div class="subtitle">Pick A Theme</div>
        <div class="theme-toggle">
          <div class="theme-chip" data-color="W">W</div>
          <div class="theme-chip" data-color="U">U</div>
          <div class="theme-chip" data-color="B">B</div>
          <div class="theme-chip" data-color="R">R</div>
          <div class="theme-chip" data-color="G">G</div>
        </div>
      </div>
      <div class="header-spin-controls">
        <button class="spin-button" id="spinBtn">SPIN</button>
      </div>
    </div>
  </header>

  <main>
    <div class="slot-layout">
      <!-- SLOT SIDE -->
      <section class="slot-panel">
        <div class="slot-header">
          <div class="slot-title">Five-Reel Viewer Slot</div>
          <div id="statusText">Add players, then spin.</div>
        </div>
        <div class="reels-shell">
          <div class="bulb-row top" id="bulbRowTop"></div>
          <div class="bulb-row bottom" id="bulbRowBottom"></div>
          <div class="bulb-col left" id="bulbColLeft"></div>
          <div class="bulb-col right" id="bulbColRight"></div>
          <div class="reels-box">
            <div class="reels" id="reels"></div>
          </div>
          <div class="lever" id="lever">
            <div class="lever-knob"></div>
          </div>
        </div>
        <div class="slot-controls">
          <div class="status-text" id="smallStatus">Ready.</div>
        </div>
      </section>
      <!-- BOTTOM PANELS (LEADERBOARD + HISTORY) -->
      <div class="bottom-panels-container">
        <!-- LEADERBOARD PANEL (LEFT - 60%) -->
        <section class="leaderboard-panel">
          <div class="side-panel-header">
            <div class="side-panel-section-title">Leaderboard Odds</div>
          </div>
          <form class="add-player-form" id="addPlayerForm" autocomplete="off">
            <input type="text" id="playerNameInput" name="player-name-input" placeholder="Add viewer (name / handle)" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            <button type="submit">Add</button>
          </form>
          <div class="leaderboard-wrapper">
            <table class="leaderboard-table">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Player</th>
                  <th>Total</th>
                  <th>Slot W</th>
                  <th>W/L%</th>
                  <th>Sparks</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="leaderboardBody"></tbody>
            </table>
          </div>
        </section>
        <!-- HISTORY LOG PANEL (RIGHT - 40%) -->
        <section class="history-panel">
          <div class="history-header">History Log</div>
          <div class="log" id="log"></div>
        </section>
      </div>
    </div>
  </main>
  <div class="footer-bar">
    <div class="footer-buttons">
      <button id="helpBtn">Help</button>
      <button id="diagBtn">Hypergeometric Diagnostic</button>
      <button id="exportBtn">Export Session</button>
      <button id="importBtn">Import Session</button>
      <button id="resetEventBtn">Factory Reset Session</button>
    </div>
  </div>
  <input type="file" id="importFileInput" accept=".json" style="display:none;"/>
  <!-- WINNER OVERLAY -->
  <div class="overlay" id="winnerOverlay">
    <div class="winner-card">
      <div class="winner-heading" id="winnerHeading">WINNER</div>
      <div class="winner-name" id="winnerName"></div>
      <div class="winner-meta" id="winnerMeta"></div>
      <div class="winner-actions">
        <button id="winnerPlayBtn">Play Deck</button>
        <button id="winnerSkipBtn">Skip / Remove</button>
      </div>
      <div class="winner-luna-sticker" id="winnerLunaSticker" style="display:none;">
        <img src="https://i.ibb.co/23vVSmXN/LunaGG.png" alt="Luna">
      </div>
    </div>
  </div>
  <!-- FINISH RUN OVERLAY -->
  <div class="overlay" id="finishOverlay">
    <div class="finish-card">
      <div class="finish-title">Report Deck Run Results</div>
      <div class="finish-sub">
        Enter how this deck performed before returning to the slot. Wins/losses here are the actual MTG games, not the slot.
      </div>
      <div class="finish-field">
        <div class="finish-label">Adjust Results (Base 0)</div>
        <div class="finish-input-row" style="justify-content:center;">
          <button type="button" class="adjust-btn" id="addWinBtn">+1 Win</button>
          <button type="button" class="adjust-btn" id="addLossBtn">-1 Loss</button>
        </div>
        <div style="margin-top:8px;font-size:11px;color:var(--muted);">
          Current: <span id="currentResults">0 wins, 0 losses</span>
        </div>
        <input type="hidden" id="runWins" value="0"/>
        <input type="hidden" id="runLosses" value="0"/>
      </div>
      <div class="finish-field">
        <div class="finish-label">Deck Color Identity</div>
        <div class="color-chips" id="colorChips">
          <div class="color-chip" data-color="W">W</div>
          <div class="color-chip" data-color="U">U</div>
          <div class="color-chip" data-color="B">B</div>
          <div class="color-chip" data-color="R">R</div>
          <div class="color-chip" data-color="G">G</div>
          <div class="color-chip" data-color="C">C</div>
        </div>
      </div>
      <div class="finish-field" id="bonusChoiceField" style="display:none;">
        <div class="finish-label">Bonus Reward (4/5-of-a-kind)</div>
        <div class="finish-sub" style="margin-top:4px;">Choose your reward for hitting 4 or 5 symbols:</div>
        <div class="queue-choice" id="bonusChoice">
          <div class="queue-chip active" data-choice="tickets">Bonus Tickets</div>
          <div class="queue-chip" data-choice="games">Extra Games</div>
        </div>
      </div>
      <div class="finish-field">
        <div class="finish-label">Re-add player to queue?</div>
        <div class="queue-choice" id="queueChoice">
          <div class="queue-chip active" data-choice="yes">Yes</div>
          <div class="queue-chip" data-choice="no">No</div>
        </div>
      </div>
      <div class="finish-actions">
        <button type="button" id="finishCancelBtn">Cancel</button>
        <button type="button" class="primary" id="finishSaveBtn" style="pointer-events:auto!important;z-index:9999;position:relative;">Save Results</button>
      </div>
    </div>
  </div>
  <!-- PLAYER DETAIL OVERLAY -->
  <div class="overlay" id="playerOverlay">
    <div class="player-card">
      <div class="player-card-header">
        <div class="player-card-name" id="playerCardName"></div>
        <div class="player-card-status" id="playerCardStatus"></div>
      </div>
      <div class="player-card-actions">
        <button id="toggleAfkBtn">Toggle AFK</button>
        <button id="removePlayerBtn">Remove Player</button>
        <button id="closePlayerCardBtn">Close</button>
      </div>
      <div class="help-section-title">Reel Probabilities</div>
      <div class="reel-charts-wrapper">
        <div class="reel-charts" id="reelCharts"></div>
      </div>
      <div class="help-section-title">Spark Progression (<span id="playerSparkCount">0</span>/12)</div>
      <div class="spark-progression">
        <div class="spark-bulbs-row">
          <div class="spark-bulb" data-spark="1"></div>
          <div class="spark-bulb" data-spark="2"></div>
          <div class="spark-bulb" data-spark="3"></div>
          <div class="spark-bulb" data-spark="4"></div>
          <div class="spark-bulb" data-spark="5"></div>
        </div>
        <div class="spark-overflow-bulb ready" data-spark="6">
          <div class="spark-overflow-label">READY</div>
        </div>
        <div class="spark-bulbs-row">
          <div class="spark-bulb" data-spark="7"></div>
          <div class="spark-bulb" data-spark="8"></div>
          <div class="spark-bulb" data-spark="9"></div>
          <div class="spark-bulb" data-spark="10"></div>
          <div class="spark-bulb" data-spark="11"></div>
        </div>
        <div class="spark-overflow-bulb ignition" data-spark="12">
          <div class="spark-overflow-label">IGNITED</div>
        </div>
      </div>
      <div class="help-section-title">Decks (by color identity)</div>
      <div class="deck-table-wrapper">
        <table class="deck-table">
          <thead>
            <tr>
              <th>Colors</th>
              <th>Matches</th>
              <th>W/L</th>
              <th>Win%</th>
              <th>Last</th>
            </tr>
          </thead>
          <tbody id="deckTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- HELP OVERLAY -->
  <div class="overlay" id="helpOverlay">
    <div class="help-card">
      <div class="help-title">How It Works</div>
      <div class="help-body">
        <div class="help-section-title">Basics</div>
        <p><strong>3+ matches = win.</strong> Each of 5 reels weighted by your tickets. Winner's deck plays until loss.</p>

        <div class="help-section-title">Tickets & Odds</div>
        <p><strong>Tickets = weight per reel.</strong> Start: 1/reel. Cap: 500/reel. <strong>Miss spin:</strong> tickets double (to cap). <strong>Appear, don't win:</strong> -1 ticket on reels shown. <strong>Dead spin:</strong> small groups penalized, large groups rewarded.</p>

        <div class="help-section-title">Sparks & Ignition</div>
        <p><strong>Overflow past 500  sparks.</strong> 500 overflow = 1 spark (max 12). <strong>12 sparks = Ignited:</strong> queued for guaranteed win. <strong>Cooldown:</strong> 1 ignition per 0-4 spins (scales with player count). Multiple players queue in FIFO order.</p>

        <div class="help-section-title">Luna & CARLO</div>
        <p><strong>Luna:</strong> rare wild (1/spin max), completes 3-in-a-row. <strong>CARLO:</strong> all 5 letters at once = jackpot, streamer plays their deck.</p>
      </div>
      <div class="finish-actions">
        <button id="closeHelpBtn">Close</button>
      </div>
    </div>
  </div>
  <!-- DIAGNOSTIC OVERLAY -->
  <div class="overlay" id="diagOverlay">
    <div class="help-card">
      <div class="help-title">Hypergeometric Diagnostic</div>
      <div class="help-body">
        <p>Simulates 300 spins with the current player list & weights (no changes to the live event). Checks for balanced win rates, CARLO/Luna frequency, 4oak/5oak occurrences, and Ignition rates.</p>
        <div class="finish-actions">
          <button id="runDiagNowBtn">Run Simulation</button>
          <button id="closeDiagBtn">Close</button>
        </div>
        <div class="diag-result" id="diagResult"></div>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  "use strict";
  const MAX_EVENTS = 7;
  const MAX_PLAYERS = 75;
  const TICKET_CAP = 500;
  const MAX_SPARKS = 12;
  const LUNA_BASE_ODDS = 1/30;
  const CARLO_LETTER_ODDS = 1/75;

  const reelsEl = document.getElementById('reels');
  const spinBtn = document.getElementById('spinBtn');
  const leverEl = document.getElementById('lever');
  const smallStatus = document.getElementById('smallStatus');
  const statusText = document.getElementById('statusText');
  const spinCountEl = document.getElementById('spinCount');
  const deadStreakEl = document.getElementById('deadStreak');
  const playerCountEl = document.getElementById('playerCount');
  const leaderboardBody = document.getElementById('leaderboardBody');
  const logEl = document.getElementById('log');
  const eventChipsEl = document.getElementById('eventChips');
  const bulbRowTop = document.getElementById('bulbRowTop');
  const bulbRowBottom = document.getElementById('bulbRowBottom');
  const bulbColLeft = document.getElementById('bulbColLeft');
  const bulbColRight = document.getElementById('bulbColRight');
  const addPlayerForm = document.getElementById('addPlayerForm');
  const playerNameInput = document.getElementById('playerNameInput');
  const winnerOverlay = document.getElementById('winnerOverlay');
  const winnerHeading = document.getElementById('winnerHeading');
  const winnerNameEl = document.getElementById('winnerName');
  const winnerMetaEl = document.getElementById('winnerMeta');
  const winnerPlayBtn = document.getElementById('winnerPlayBtn');
  const winnerSkipBtn = document.getElementById('winnerSkipBtn');
  const winnerLunaSticker = document.getElementById('winnerLunaSticker');
  const finishOverlay = document.getElementById('finishOverlay');
  const runWinsInput = document.getElementById('runWins');
  const runLossesInput = document.getElementById('runLosses');
  const matchTypeSelect = document.getElementById('matchType');
  const colorChips = document.getElementById('colorChips');
  const queueChoice = document.getElementById('queueChoice');
  const bonusChoice = document.getElementById('bonusChoice');
  const bonusChoiceField = document.getElementById('bonusChoiceField');
  const finishCancelBtn = document.getElementById('finishCancelBtn');
  const finishSaveBtn = document.getElementById('finishSaveBtn');
  const playerOverlay = document.getElementById('playerOverlay');
  const playerCardName = document.getElementById('playerCardName');
  const playerCardStatus = document.getElementById('playerCardStatus');
  const toggleAfkBtn = document.getElementById('toggleAfkBtn');
  const removePlayerBtn = document.getElementById('removePlayerBtn');
  const closePlayerCardBtn = document.getElementById('closePlayerCardBtn');
  const deckTableBody = document.getElementById('deckTableBody');
  const helpOverlay = document.getElementById('helpOverlay');
  const diagOverlay = document.getElementById('diagOverlay');
  const helpBtn = document.getElementById('helpBtn');
  const diagBtn = document.getElementById('diagBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFileInput = document.getElementById('importFileInput');
  const resetEventBtn = document.getElementById('resetEventBtn');
  const closeHelpBtn = document.getElementById('closeHelpBtn');
  const closeDiagBtn = document.getElementById('closeDiagBtn');
  const runDiagNowBtn = document.getElementById('runDiagNowBtn');
  const diagResult = document.getElementById('diagResult');
  const themeChips = document.querySelectorAll('.theme-chip');
  const addWinBtn = document.getElementById('addWinBtn');
  const addLossBtn = document.getElementById('addLossBtn');
  const currentResults = document.getElementById('currentResults');

  const state = {currentEventIndex: 1,events: []};
  let selectedColors = new Set(); // Multi-select theme colors (empty = white glow default)
  let selectedColorSet = new Set();
  let queueReaddChoice = 'yes';
  let bonusRewardChoice = 'tickets';
  let pendingWinner = null;
  let currentWinnerMeta = null;
  let bulbsTimer = null;
  let timeTimer = null;
  let currentPlayerCardId = null;

  // Ignition Queue System - FIFO with scaling cooldowns
  let ignitedQueue = []; // Array of player IDs ready for ignition
  let lastIgnitionSpin = -1; // Spin count when last ignition occurred

  // Ignition cooldown configuration (spins between ignitions)
  function getIgnitionCooldown(activePlayerCount){
    if(activePlayerCount <= 3) return 0; // No cooldown with few players
    if(activePlayerCount <= 5) return 1; // 1 spin cooldown
    if(activePlayerCount <= 10) return 2; // 2 spin cooldown
    if(activePlayerCount <= 20) return 3; // 3 spin cooldown
    return 4; // 4 spin cooldown for large queues
  }

  // Handle +1 Win and -1 Loss buttons
  function updateResultsDisplay(){
    const wins = parseInt(runWinsInput.value,10)||0;
    const losses = parseInt(runLossesInput.value,10)||0;
    currentResults.textContent = `${wins} wins, ${losses} losses`;
  }

  addWinBtn.addEventListener('click',()=>{
    const current = parseInt(runWinsInput.value,10)||0;
    runWinsInput.value = current + 1;
    updateResultsDisplay();
  });

  addLossBtn.addEventListener('click',()=>{
    const current = parseInt(runLossesInput.value,10)||0;
    runLossesInput.value = current + 1;
    updateResultsDisplay();
  });

  function currentEvent(){
    if(!state.events[state.currentEventIndex]){
      state.events[state.currentEventIndex] = {
        players: [],
        spinCount: 0,
        deadSpinStreak: 0,
        currentRun: null,
        carloHits: 0,
        lunaHits: 0
      };
    }
    return state.events[state.currentEventIndex];
  }

  function log(msg){
    const time = new Date().toLocaleTimeString();
    const div = document.createElement('div');
    div.innerHTML = `<span class="log-timestamp">[${time}]</span> ${msg}`;
    logEl.prepend(div);
  }
  function saveAll(){
    try{
      localStorage.setItem('carlo_slot_events', JSON.stringify(state));
    }catch(e){
      console.warn("Save failed", e);
    }
  }
  function loadAll(){
    try{
      const raw = localStorage.getItem('carlo_slot_events');
      if(!raw) return;
      const parsed = JSON.parse(raw);
      if(!parsed || typeof parsed !== 'object') return;
      if(parsed.events) state.events = parsed.events;
      if(parsed.currentEventIndex) state.currentEventIndex = parsed.currentEventIndex;
      for(const evt of state.events){
        if(!evt) continue;
        evt.players = evt.players || [];
        evt.spinCount = evt.spinCount || 0;
        evt.deadSpinStreak = evt.deadSpinStreak || 0;
        evt.currentRun = evt.currentRun || null;
        evt.carloHits = evt.carloHits || 0;
        evt.lunaHits = evt.lunaHits || 0;
        for(const p of evt.players){
          p.tickets = p.tickets || [1,1,1,1,1];
          p.sparks = p.sparks || 0;
          if(p.pityPoints && p.pityPoints > 0){
            p.sparks = Math.min(MAX_SPARKS, p.sparks + 1);
          }
          p.pityPoints = 0;
          p.slotWins = p.slotWins || 0;
          p.slotGames = p.slotGames || 0;
          p.overallWins = p.overallWins || 0;
          p.overallLosses = p.overallLosses || 0;
          p.createdAt = p.createdAt || Date.now();
          p.status = p.status || 'active';
          p.decks = p.decks || [];
        }
      }
    }catch(e){
      console.warn("Load failed", e);
    }
  }

  function clampPlayer(p){
    for(let i=0;i<5;i++){
      if(p.tickets[i] < 1) p.tickets[i] = 1;  // Never allow 0 tickets
      if(p.tickets[i] > TICKET_CAP) p.tickets[i] = TICKET_CAP;
    }
    if(p.sparks < 0) p.sparks = 0;
    if(p.sparks > MAX_SPARKS) p.sparks = MAX_SPARKS;
  }

  function totalTickets(p){
    return p.tickets.reduce((a,b)=>a+b,0);
  }
  function overallWinRate(p){
    const total = p.overallWins + p.overallLosses;
    if(total === 0) return 0;
    return (p.overallWins / total) * 100;
  }
  function formatTimeInQueue(ms){
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const h = Math.floor(m/60);
    if(h>0) return `${h}h ${m%60}m`;
    if(m>0) return `${m}m ${s%60}s`;
    return `${s}s`;
  }

  function renderEvents(){
  }

  function initBulbs(){
    function createRow(rowEl, count){
      rowEl.innerHTML = '';
      for(let i=0;i<count;i++){
        const b = document.createElement('div');
        b.className = 'bulb';
        rowEl.appendChild(b);
      }
    }
    function createCol(colEl, count){
      colEl.innerHTML = '';
      for(let i=0;i<count;i++){
        const b = document.createElement('div');
        b.className = 'bulb';
        colEl.appendChild(b);
      }
    }
    createRow(bulbRowTop, 10);
    createRow(bulbRowBottom, 10);
    createCol(bulbColLeft, 4);
    createCol(bulbColRight, 4);
  }

  const BULB_COLORS = ['#fefce8','#38bdf8','#020617','#ef4444','#22c55e'];
  const BULB_LUNA_COLORS = ['#fdf2ff','#fb7185','#a855f7','#f973fa'];
  function startBulbsAnimation(isLunaWin){
    stopBulbsAnimation();
    const top = bulbRowTop.querySelectorAll('.bulb');
    const bottom = bulbRowBottom.querySelectorAll('.bulb');
    const left = bulbColLeft.querySelectorAll('.bulb');
    const right = bulbColRight.querySelectorAll('.bulb');

    // Arrange bulbs in clockwise rotation order: top-left to top-right, then right-top to right-bottom, then bottom-right to bottom-left, then left-bottom to left-top
    const topArray = Array.from(top);
    const rightArray = Array.from(right);
    const bottomArray = Array.from(bottom).reverse();
    const leftArray = Array.from(left).reverse();
    const all = [...topArray, ...rightArray, ...bottomArray, ...leftArray];

    let t = 0;
    const trailLength = 8; // Number of bulbs to light up in the trail
    bulbsTimer = setInterval(()=>{
      // For Luna wins: use pink colors. For others: randomly cycle all non-pink colors
      const availableColors = isLunaWin ? BULB_LUNA_COLORS : BULB_COLORS;

      // Turn off all bulbs first
      all.forEach(b => {
        b.classList.remove('active');
        b.style.background = '#4b5563';
        b.style.color = '#4b5563';
      });

      // Light up trailing bulbs with random color cycling
      for(let i = 0; i < trailLength; i++){
        const idx = (t - i + all.length) % all.length;
        const bulb = all[idx];
        // Random color from available palette
        const c = availableColors[Math.floor(Math.random() * availableColors.length)];
        const opacity = 1 - (i / trailLength) * 0.7; // Fade trail
        bulb.style.color = c;
        bulb.style.background = c;
        bulb.style.opacity = opacity;
        bulb.classList.add('active');
      }
      t = (t + 1) % all.length;
    },80);
  }
  function stopBulbsAnimation(){
    if(bulbsTimer) clearInterval(bulbsTimer);
    bulbsTimer = null;
    const all = document.querySelectorAll('.bulb');
    all.forEach(b=>{
      b.classList.remove('active');
      b.style.background='#4b5563';
    });
  }

  function setupReelsPlaceholder(){
    reelsEl.innerHTML = '';
    for(let i=0;i<5;i++){
      const reel = document.createElement('div');
      reel.className = 'reel';
      const inner = document.createElement('div');
      inner.className = 'reel-inner';
      const sym = document.createElement('div');
      sym.className = 'reel-symbol letter';
      sym.textContent = "CARLO"[i];
      inner.appendChild(sym);
      reel.appendChild(inner);
      reelsEl.appendChild(reel);
    }
  }

  let reelCycleIntervals = [];

  function spinAnimationStart(){
    const evt = currentEvent();
    const reelEls = reelsEl.querySelectorAll('.reel');
    const letters = ['C','A','R','L','O'];
    const allPlayers = evt.players.filter(p => p.status === 'active');

    // Clear any existing intervals
    reelCycleIntervals.forEach(iv => clearInterval(iv));
    reelCycleIntervals = [];

    reelEls.forEach((r, idx)=>{
      r.classList.add('spinning');
      r.classList.remove('glow-win','glow-carlo','glow-luna');

      // Create single symbol that will cycle content
      const inner = r.querySelector('.reel-inner');
      if(inner){
        inner.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'reel-symbol player';
        div.textContent = letters[idx];
        inner.appendChild(div);

        // Cycle the symbol's content rapidly
        const interval = setInterval(() => {
          const rand = Math.random();
          if(rand < 0.4 && allPlayers.length > 0){
            // Random player
            const p = allPlayers[Math.floor(Math.random() * allPlayers.length)];
            div.className = 'reel-symbol player';
            div.textContent = p.name;
            div.innerHTML = p.name;
          }else if(rand < 0.5){
            // Luna (rare)
            div.className = 'reel-symbol luna';
            div.innerHTML = `<img src="https://i.ibb.co/8g6ZQM5C/IMG-2604.png" alt="Luna">`;
          }else{
            // Letter
            div.className = 'reel-symbol letter';
            div.textContent = letters[idx];
          }
        }, 100); // Change every 100ms

        reelCycleIntervals.push(interval);
      }
    });
    // Don't start bulbs here - will be started in performSpin for proper timing
  }
  function spinAnimationStop(){
    const reelEls = reelsEl.querySelectorAll('.reel');
    reelEls.forEach(r=>r.classList.remove('spinning'));
    // Clear all cycling intervals
    reelCycleIntervals.forEach(iv => clearInterval(iv));
    reelCycleIntervals = [];
    stopBulbsAnimation();
  }

  // Cascade reel stops over 660ms with random timing
  // Last reel stops ~1500-1700ms (longer, more dramatic spin)
  function spinAnimationStopCascade(callback){
    const reelEls = reelsEl.querySelectorAll('.reel');
    const TAPER_DURATION = 1000; // 1 second cascade
    const BASE_START = 600; // First reel starts stopping at ~600ms
    const RANDOM_VARIANCE = 60; // 60ms random variation per reel

    // Generate random delays for each reel
    const delays = [];
    for(let i = 0; i < 5; i++){
      const baseDelay = BASE_START + (i * (TAPER_DURATION / 4)); // Spread over 660ms
      const randomOffset = (Math.random() - 0.5) * 2 * RANDOM_VARIANCE; // -40 to +40ms
      delays.push(Math.max(0, baseDelay + randomOffset));
    }

    // Stop each reel at its calculated time
    let stoppedCount = 0;
    delays.forEach((delay, index) => {
      setTimeout(() => {
        reelEls[index].classList.remove('spinning');
        // Clear the interval for this specific reel
        if(reelCycleIntervals[index]){
          clearInterval(reelCycleIntervals[index]);
        }
        stoppedCount++;
        if(stoppedCount === 5 && callback){
          // All reels stopped, invoke callback
          reelCycleIntervals = [];
          callback();
        }
      }, delay);
    });
  }

  function addPlayer(name){
    const evt = currentEvent();
    if(evt.players.length >= MAX_PLAYERS){
      smallStatus.textContent = "Player cap reached for this session.";
      return;
    }
    name = name.trim();
    if(!name) return;
    const existing = evt.players.find(p => p.name.toLowerCase() === name.toLowerCase());
    if(existing){
      smallStatus.textContent = "Player already in queue.";
      return;
    }
    const p = {
      id: Date.now() + Math.random().toString(16).slice(2),
      name,
      tickets:[1,1,1,1,1],
      sparks:0,
      slotWins:0,
      slotGames:0,
      overallWins:0,
      overallLosses:0,
      createdAt:Date.now(),
      status:'active',
      decks:[]
    };
    evt.players.push(p);
    log(`Added player ${name} to the session.`);
    renderLeaderboard();
    const lbWrap = document.querySelector('.leaderboard-wrapper');
    if(lbWrap) lbWrap.scrollTop = lbWrap.scrollHeight;
    saveAll();
  }

  function randomWeightedPlayer(evt, reelIndex){
    const candidates = evt.players.filter(p=>p.status==='active');
    if(candidates.length === 0) return null;
    let total = 0;
    for(const p of candidates){
      total += p.tickets[reelIndex];
    }
    if(total <= 0) return null;
    let r = Math.random() * total;
    for(const p of candidates){
      r -= p.tickets[reelIndex];
      if(r <= 0) return p;
    }
    return candidates[candidates.length-1];
  }

  function applyOverflowToSparks(player, overflow){
    if(overflow <= 0) return;
    // Every 500 overflow = 1 spark
    const tokens = Math.floor(overflow / TICKET_CAP);
    if(tokens > 0){
      player.sparks = Math.min(MAX_SPARKS, (player.sparks || 0) + tokens);
    }
  }

  function doubleTicketsAllReels(player){
    const oldTotal = totalTickets(player);
    const oldSparks = player.sparks || 0;
    for(let i=0;i<5;i++){
      const raw = player.tickets[i] * 2;
      if(raw <= TICKET_CAP){
        // No overflow, just set to doubled amount
        player.tickets[i] = raw;
      } else {
        // Overflow: raw exceeds 500 cap
        const overflow = raw - TICKET_CAP;

        // Calculate sparks from overflow (every 500 overflow = 1 spark)
        const sparksFromOverflow = Math.floor(overflow / TICKET_CAP);
        if(sparksFromOverflow > 0){
          player.sparks = Math.min(MAX_SPARKS, (player.sparks || 0) + sparksFromOverflow);
        }

        // Calculate remaining tickets after overflow
        let newTickets = overflow % TICKET_CAP;
        if(newTickets === 0){
          // If exactly divisible, keep minimum viable tickets
          newTickets = 1;
        }
        player.tickets[i] = newTickets;
      }
    }
    clampPlayer(player);
    const newTotal = totalTickets(player);
    const newSparks = player.sparks;
    if(newSparks > oldSparks){
      log(`${player.name}: tickets ${oldTotal}${newTotal}, sparks ${oldSparks}${newSparks} (+${newSparks-oldSparks})`);
    }
  }

  function halveTicketsAllReels(player){
    // HALVE+1 logic: halve tickets (round up), then add +1, minimum 1
    for(let i=0;i<5;i++){
      const halved = Math.ceil(player.tickets[i] / 2);
      player.tickets[i] = Math.max(1, halved + 1);
    }
    clampPlayer(player);
  }

  function handleDeadSpinTickets(evt, symbols, reelPlayers){
    const drawnIds = new Set(reelPlayers.map(r=>r.playerId));
    const activePlayerCount = evt.players.filter(p => p.status === 'active').length;

    for(const p of evt.players){
      if(p.status !== 'active') continue;
      if(drawnIds.has(p.id)){
        // Player appeared: lose -1 on that specific reel(s)
        for(const rp of reelPlayers){
          if(rp.playerId === p.id){
            const i = rp.index;
            p.tickets[i] = Math.max(1, p.tickets[i]-1);
          }
        }
      }else{
        // Player didn't appear: apply scaled penalty based on player count
        // Small groups get penalty, large groups get small boost (fixes scaling issue)
        let multiplier;
        if (activePlayerCount <= 7) {
          multiplier = 0.55; // Moderate penalty for small groups
        } else if (activePlayerCount <= 15) {
          multiplier = 0.73; // Mild penalty for medium groups
        } else if (activePlayerCount <= 30) {
          multiplier = 1.005; // Minimal boost for medium-large groups
        } else if (activePlayerCount <= 50) {
          multiplier = 1.012; // Small boost for large groups
        } else {
          multiplier = 1.018; // Small boost for very large groups
        }

        for(let i=0; i<5; i++){
          p.tickets[i] = Math.max(1, Math.ceil(p.tickets[i] * multiplier));
        }
      }
      clampPlayer(p);
    }
  }

  function handleWinTickets(evt, winner, symbols, reelPlayers){
    const winnerId = winner.id;
    const drawnIds = new Set(reelPlayers.map(r=>r.playerId));
    for(const p of evt.players){
      if(p.status !== 'active') continue;
      if(p.id === winnerId){
        continue;
      }
      if(drawnIds.has(p.id)){
        for(const rp of reelPlayers){
          if(rp.playerId === p.id){
            const i = rp.index;
            p.tickets[i] = Math.max(1, p.tickets[i]-1);
          }
        }
      }else{
        doubleTicketsAllReels(p);
      }
      clampPlayer(p);
    }
  }

  function findIgnitedPlayer(evt){
    const candidates = evt.players.filter(p => p.status === 'active' && p.sparks >= MAX_SPARKS);
    if(candidates.length === 0) return null;
    candidates.sort((a,b) => {
      if(a.createdAt !== b.createdAt) return a.createdAt - b.createdAt;
      if(b.sparks !== a.sparks) return b.sparks - a.sparks;
      const totDiff = totalTickets(b) - totalTickets(a);
      if(totDiff !== 0) return totDiff;
      return a.name.localeCompare(b.name);
    });
    return candidates[0];
  }

  // Update ignition queue with all players at 12 sparks
  function updateIgnitionQueue(evt){
    const readyPlayers = evt.players.filter(p => p.status === 'active' && p.sparks >= MAX_SPARKS);

    // Add new ignited players to queue (FIFO order)
    for(const p of readyPlayers){
      if(!ignitedQueue.includes(p.id)){
        ignitedQueue.push(p.id);
        log(`<span style="color:#fcd34d;font-weight:600;">${p.name} has reached 12 sparks and is queued for ignition!</span>`);
      }
    }

    // Remove players who are no longer eligible (left queue, lost sparks, etc.)
    ignitedQueue = ignitedQueue.filter(id => {
      const p = evt.players.find(pl => pl.id === id);
      return p && p.status === 'active' && p.sparks >= MAX_SPARKS;
    });
  }

  // Check if ignition can trigger this spin (cooldown check)
  function canTriggerIgnition(evt){
    const activePlayerCount = evt.players.filter(p => p.status === 'active').length;
    const cooldown = getIgnitionCooldown(activePlayerCount);
    const spinsSinceLastIgnition = evt.spinCount - lastIgnitionSpin;

    return ignitedQueue.length > 0 && spinsSinceLastIgnition >= cooldown;
  }

  // Get next ignited player from queue
  function processIgnitionQueue(evt){
    if(ignitedQueue.length === 0) return null;

    const playerId = ignitedQueue[0]; // FIFO: take first in queue
    const player = evt.players.find(p => p.id === playerId);

    if(player && player.status === 'active' && player.sparks >= MAX_SPARKS){
      ignitedQueue.shift(); // Remove from queue
      lastIgnitionSpin = evt.spinCount; // Update last ignition spin
      return player;
    }

    // Player no longer valid, remove and try next
    ignitedQueue.shift();
    return processIgnitionQueue(evt);
  }

  function buildSpinResult(evt){
    const symbols = [];
    const letters = ['C','A','R','L','O'];
    const luna = Math.random() < LUNA_BASE_ODDS;
    const lunaIndex = luna ? Math.floor(Math.random()*5) : -1;
    for(let i=0;i<5;i++){
      if(i === lunaIndex){
        symbols.push({type:'luna'});
        continue;
      }
      const roll = Math.random();
      if(roll < CARLO_LETTER_ODDS){
        symbols.push({type:'letter', letter:letters[i]});
      }else{
        const p = randomWeightedPlayer(evt, i);
        if(p){
          symbols.push({type:'player', playerId:p.id, name:p.name});
        }else{
          symbols.push({type:'letter', letter:letters[i]});
        }
      }
    }
    return symbols;
  }

  function renderSpinResult(symbols){
    reelsEl.innerHTML = '';
    symbols.forEach(sym=>{
      const reel = document.createElement('div');
      reel.className = 'reel';
      const inner = document.createElement('div');
      inner.className = 'reel-inner';
      const div = document.createElement('div');
      if(sym.type === 'player'){
        div.className = 'reel-symbol player';
        div.textContent = sym.name;
      }else if(sym.type === 'letter'){
        div.className = 'reel-symbol letter';
        div.textContent = sym.letter;
      }else if(sym.type === 'luna'){
        div.className = 'reel-symbol luna';
        const img = document.createElement('img');
        img.src = "https://i.ibb.co/8g6ZQM5C/IMG-2604.png";
        img.alt = "Luna";
        div.appendChild(img);
      }else{
        div.className = 'reel-symbol letter';
        div.textContent = '?';
      }
      inner.appendChild(div);
      reel.appendChild(inner);
      reelsEl.appendChild(reel);
    });
  }

  function detectCarlo(symbols){
    return (
      symbols[0].type==='letter' && symbols[0].letter==='C' &&
      symbols[1].type==='letter' && symbols[1].letter==='A' &&
      symbols[2].type==='letter' && symbols[2].letter==='R' &&
      symbols[3].type==='letter' && symbols[3].letter==='L' &&
      symbols[4].type==='letter' && symbols[4].letter==='O'
    );
  }

  function detectLunaWinner(evt, symbols){
    const playersById = new Map();
    evt.players.forEach(p=>playersById.set(p.id,p));
    let lunaIndex = -1;
    symbols.forEach((s,idx)=>{
      if(s.type==='luna') lunaIndex = idx;
    });
    if(lunaIndex<0) return null;
    const triples = [
      [lunaIndex-2,lunaIndex-1,lunaIndex],
      [lunaIndex-1,lunaIndex,lunaIndex+1],
      [lunaIndex,lunaIndex+1,lunaIndex+2]
    ];
    for(const triple of triples){
      const valid = triple.filter(i=>i>=0 && i<symbols.length);
      if(valid.length!==3) continue;
      const syms = valid.map(i=>symbols[i]);
      const players = syms.filter(s=>s.type==='player');
      if(players.length===0) continue;
      const countById = {};
      players.forEach(ps=>countById[ps.playerId]=(countById[ps.playerId]||0)+1);
      const idWith2 = Object.keys(countById).find(id=>countById[id]>=2);
      if(idWith2){
        const p = playersById.get(idWith2);
        if(p && p.status==='active'){
          return {player:p, hits:3, lunaIndex};
        }
      }else if(players.length===1){
        const p = playersById.get(players[0].playerId);
        if(p && p.status==='active'){
          return {player:p, hits:3, lunaIndex};
        }
      }
    }
    return null;
  }

  function detectHitWinner(evt, symbols){
    const counts = new Map();
    const playersById = new Map();
    evt.players.forEach(p=>playersById.set(p.id,p));
    symbols.forEach(s=>{
      if(s.type==='player'){
        counts.set(s.playerId,(counts.get(s.playerId)||0)+1);
      }
    });
    const candidates = [];
    counts.forEach((cnt,id)=>{
      if(cnt>=3){
        const p = playersById.get(id);
        if(p && p.status==='active'){
          candidates.push({player:p,hits:cnt});
        }
      }
    });
    if(candidates.length===0) return null;
    candidates.sort((a,b)=>{
      if(b.hits!==a.hits) return b.hits-a.hits;
      const tDiff = totalTickets(b.player)-totalTickets(a.player);
      if(tDiff!==0) return tDiff;
      return a.player.createdAt - b.player.createdAt;
    });
    return candidates[0];
  }

  function renderLeaderboard(){
    const evt = currentEvent();
    const players = evt.players;
    leaderboardBody.innerHTML = '';
    const sorted = players.slice().sort((a,b)=>{
      const tDiff = totalTickets(b)-totalTickets(a);
      if(tDiff!==0) return tDiff;
      return a.createdAt - b.createdAt;
    });
    const now = Date.now();
    for(const p of sorted){
      clampPlayer(p);

      // Row 1: Player stats
      const tr1 = document.createElement('tr');
      tr1.className = 'player-row player-row-main';
      const tdTime = document.createElement('td');
      tdTime.className = 'time-cell';
      tdTime.textContent = formatTimeInQueue(now - p.createdAt);
      const tdName = document.createElement('td');
      tdName.innerHTML = p.name + (p.status!=='active'
        ? " <span style='color:var(--red);font-size:10px;'>(AFK)</span>"
        : "");
      tdName.style.cursor = 'pointer';
      tdName.addEventListener('click',()=>openPlayerCard(p.id));
      const tdTotal = document.createElement('td');
      tdTotal.textContent = totalTickets(p);
      const tdSparks = document.createElement('td');
      const sparksText = p.sparks > 0 ? `${p.sparks} / ${MAX_SPARKS}` : '';
      tdSparks.innerHTML = `<span class="sparks-count">${sparksText}</span>`;
      const tdSlotWins = document.createElement('td');
      tdSlotWins.textContent = `${p.slotWins}`;
      const tdWL = document.createElement('td');
      const winPct = overallWinRate(p);
      const winsDisplay = p.overallWins > 0 ? `+${p.overallWins}` : '0';
      const lossesDisplay = p.overallLosses > 0 ? `-${p.overallLosses}` : '0';
      tdWL.textContent = `${winsDisplay}/${lossesDisplay} (${winPct.toFixed(1)}%)`;
      if(winPct >= 60) tdWL.className = 'win-rate-good';
      else if(winPct >= 40) tdWL.className = 'win-rate-medium';
      else tdWL.className = 'win-rate-poor';
      const tdActions = document.createElement('td');
      tdActions.className='actions-cell';
      const cog = document.createElement('button');
      cog.textContent='';
      cog.title='View player card';
      cog.addEventListener('click',e=>{
        e.stopPropagation();
        openPlayerCard(p.id);
      });
      tdActions.appendChild(cog);

      tr1.appendChild(tdTime);
      tr1.appendChild(tdName);
      tr1.appendChild(tdTotal);
      tr1.appendChild(tdSlotWins);
      tr1.appendChild(tdWL);
      tr1.appendChild(tdSparks);
      tr1.appendChild(tdActions);

      leaderboardBody.appendChild(tr1);
    }
    spinCountEl.textContent = evt.spinCount;
    deadStreakEl.textContent = evt.deadSpinStreak;
    playerCountEl.textContent = evt.players.length;
  }

  function openPlayerCard(playerId){
    const evt = currentEvent();
    const p = evt.players.find(x=>x.id===playerId);
    if(!p) return;
    currentPlayerCardId = playerId;
    playerCardName.textContent = p.name;
    playerCardStatus.textContent = p.status === 'active' ? 'Active' : 'AFK';

    // Render reel probability pie charts
    const reelChartsEl = document.getElementById('reelCharts');
    reelChartsEl.innerHTML = '';
    for(let i=0; i<5; i++){
      const totalForReel = evt.players.filter(pl => pl.status === 'active').reduce((sum, pl) => sum + pl.tickets[i], 0);
      const playerTickets = p.tickets[i];
      const percentage = totalForReel > 0 ? ((playerTickets / totalForReel) * 100) : 0;

      const chartDiv = document.createElement('div');
      chartDiv.className = 'reel-chart';

      const label = document.createElement('div');
      label.className = 'reel-chart-label';
      label.textContent = `Reel ${i+1}`;

      const pieChart = document.createElement('div');
      pieChart.className = 'pie-chart';
      pieChart.style.setProperty('--percentage', `${percentage}%`);
      // Gradient effect: darker at low %, lighter at high %
      const brightness = 0.3 + (percentage / 100) * 0.7; // 0.3 to 1.0
      pieChart.style.setProperty('--chart-brightness', brightness);

      const inner = document.createElement('div');
      inner.className = 'pie-chart-inner';
      inner.textContent = `${percentage.toFixed(1)}%`;

      pieChart.appendChild(inner);

      // Ticket controls below pie chart
      const ticketControls = document.createElement('div');
      ticketControls.className = 'reel-ticket-controls';

      const minusBtn = document.createElement('button');
      minusBtn.textContent = '-';
      minusBtn.className = 'ticket-btn';

      const ticketDisplay = document.createElement('span');
      ticketDisplay.className = 'ticket-count';
      ticketDisplay.textContent = playerTickets;

      const plusBtn = document.createElement('button');
      plusBtn.textContent = '+';
      plusBtn.className = 'ticket-btn';

      minusBtn.addEventListener('click', () => {
        if(p.tickets[i] > 1) {
          p.tickets[i]--;
          clampPlayer(p);
          openPlayerCard(p.id); // Refresh the card
          renderLeaderboard();
          saveAll();
        }
      });

      plusBtn.addEventListener('click', () => {
        if(p.tickets[i] < TICKET_CAP) {
          p.tickets[i]++;
          clampPlayer(p);
          openPlayerCard(p.id); // Refresh the card
          renderLeaderboard();
          saveAll();
        }
      });

      ticketControls.appendChild(minusBtn);
      ticketControls.appendChild(ticketDisplay);
      ticketControls.appendChild(plusBtn);

      chartDiv.appendChild(label);
      chartDiv.appendChild(pieChart);
      chartDiv.appendChild(ticketControls);
      reelChartsEl.appendChild(chartDiv);
    }

    // Render spark progression bulbs
    const playerSparks = p.sparks || 0;
    document.getElementById('playerSparkCount').textContent = playerSparks;

    // Light up bulbs based on spark count
    const sparkBulbs = document.querySelectorAll('.spark-bulb');
    sparkBulbs.forEach(bulb => {
      const sparkNum = parseInt(bulb.dataset.spark);
      if(playerSparks >= sparkNum){
        bulb.classList.add('lit');
      } else {
        bulb.classList.remove('lit');
      }
    });

    // Light up overflow bulbs
    const readyBulb = document.querySelector('.spark-overflow-bulb.ready');
    const ignitionBulb = document.querySelector('.spark-overflow-bulb.ignition');
    if(playerSparks >= 6){
      readyBulb.classList.add('lit');
    } else {
      readyBulb.classList.remove('lit');
    }
    if(playerSparks >= 12){
      ignitionBulb.classList.add('lit');
    } else {
      ignitionBulb.classList.remove('lit');
    }

    deckTableBody.innerHTML = '';
    const rows = [];
    p.decks.forEach(d=>{
      const total = d.wins + d.losses;
      const winRate = total>0 ? (d.wins/total)*100 : 0;
      const tr = document.createElement('tr');
      const tdColor = document.createElement('td');

      // Render color pips as images instead of text
      if(d.color){
        const pipUrls = {
          'W': 'https://i.ibb.co/sJpHH9VZ/W.png',
          'U': 'https://i.ibb.co/0bPLHLk/U.png',
          'B': 'https://i.ibb.co/nM1ZZz3z/B.png',
          'R': 'https://i.ibb.co/NnjxnmZv/R.png',
          'G': 'https://i.ibb.co/tM5Mb1Q0/G.png',
          'C': 'https://i.ibb.co/xt4Lpn0X/C.png'
        };
        tdColor.style.display = 'flex';
        tdColor.style.gap = '2px';
        tdColor.style.alignItems = 'center';
        for(const letter of d.color){
          if(pipUrls[letter]){
            const img = document.createElement('img');
            img.src = pipUrls[letter];
            img.alt = letter;
            img.style.width = '16px';
            img.style.height = '16px';
            img.style.objectFit = 'contain';
            tdColor.appendChild(img);
          }
        }
      }else{
        tdColor.textContent = '-';
      }

      const tdMatches = document.createElement('td');
      tdMatches.textContent = total;
      const tdWL = document.createElement('td');
      tdWL.textContent = `${d.wins}/${d.losses}`;
      const tdWinRate = document.createElement('td');
      tdWinRate.textContent = `${winRate.toFixed(1)}%`;
      const tdLast = document.createElement('td');
      tdLast.textContent = d.lastBestOf || '-';
      tr.appendChild(tdColor);
      tr.appendChild(tdMatches);
      tr.appendChild(tdWL);
      tr.appendChild(tdWinRate);
      tr.appendChild(tdLast);
      rows.push({winRate, tr});
    });
    rows.sort((a,b)=>b.winRate-a.winRate);
    rows.forEach(r=>deckTableBody.appendChild(r.tr));
    playerOverlay.classList.add('show');
  }

  toggleAfkBtn.addEventListener('click',()=>{
    if(currentPlayerCardId===null) return;
    const evt = currentEvent();
    const p = evt.players.find(x=>x.id===currentPlayerCardId);
    if(!p) return;
    p.status = (p.status==='active' ? 'afk' : 'active');
    log(`${p.name} is now ${p.status.toUpperCase()}.`);
    playerOverlay.classList.remove('show');
    renderLeaderboard();
    saveAll();
  });
  removePlayerBtn.addEventListener('click',()=>{
    if(currentPlayerCardId===null) return;
    const evt = currentEvent();
    const idx = evt.players.findIndex(x=>x.id===currentPlayerCardId);
    if(idx>=0){
      const removed = evt.players.splice(idx,1)[0];
      log(`Removed ${removed.name} from the session.`);
    }
    playerOverlay.classList.remove('show');
    currentPlayerCardId = null;
    renderLeaderboard();
    saveAll();
  });
  closePlayerCardBtn.addEventListener('click',()=>{
    playerOverlay.classList.remove('show');
    currentPlayerCardId=null;
  });

  // Close player card when clicking outside
  playerOverlay.addEventListener('click',(e)=>{
    if(e.target === playerOverlay){
      playerOverlay.classList.remove('show');
      currentPlayerCardId=null;
    }
  });

  function handleWinnerBanner(player, reason, hits, isLuna){
    const evt = currentEvent();
    evt.deadSpinStreak = 0;
    evt.spinCount++;
    player.slotGames = (player.slotGames||0) + 1;
    player.slotWins = (player.slotWins||0) + 1;
    clampPlayer(player);
    pendingWinner = player;
    currentWinnerMeta = {reason,hits};
    winnerLunaSticker.style.display = isLuna ? 'block' : 'none';
    winnerNameEl.textContent = player.name;
    if(reason==='luna'){
      winnerHeading.textContent = 'LUNA LUCK!';
      winnerMetaEl.textContent = `${player.name} wins with Luna Luck!`;
    }else if(reason==='ignited'){
      winnerHeading.textContent = 'IGNITED!';
      winnerMetaEl.textContent = `${player.name} has ${MAX_SPARKS} sparks & has been Ignited.`;
    }else if(reason==='carlo'){
      winnerHeading.textContent = 'CARLO PICK';
      winnerMetaEl.textContent = `CARLO hit  streamer plays their own deck this round.`;
    }else{
      winnerHeading.textContent = 'WINNER';
      if(hits>=5){
        winnerMetaEl.textContent = `${player.name} hit 5 symbols  high-odds pick!`;
      }else if(hits===4){
        winnerMetaEl.textContent = `${player.name} hit 4 symbols  strong roll.`;
      }else{
        winnerMetaEl.textContent = `${player.name}'s deck is up next.`;
      }
    }
    winnerOverlay.classList.add('show');
  }

  function finishRunPrompt(player){
    const evt = currentEvent();
    const hits = (currentWinnerMeta && currentWinnerMeta.hits) || 3;
    const showBonusChoice = hits === 4 || hits === 5;
    evt.currentRun = {
      playerId: player.id,
      bonusPerReel: 0
    };
    runWinsInput.value = "0";
    runLossesInput.value = "0";
    updateResultsDisplay();
    selectedColorSet = new Set();
    Array.from(colorChips.children).forEach(ch=>ch.classList.remove('active'));
    queueReaddChoice = 'yes';
    Array.from(queueChoice.children).forEach(ch=>{
      ch.classList.toggle('active', ch.dataset.choice === 'yes');
    });
    bonusRewardChoice = 'tickets';
    Array.from(bonusChoice.children).forEach(ch=>{
      ch.classList.toggle('active', ch.dataset.choice === 'tickets');
    });
    bonusChoiceField.style.display = showBonusChoice ? 'block' : 'none';
    finishSaveBtn.disabled = false;
    finishOverlay.classList.add('show');
  }

  winnerPlayBtn.addEventListener('click',()=>{
    if(!pendingWinner) return;
    const p=pendingWinner;
    pendingWinner=null;
    winnerOverlay.classList.remove('show');
    finishRunPrompt(p);
  });

  winnerSkipBtn.addEventListener('click',()=>{
    const evt = currentEvent();
    if(pendingWinner){
      log(`Winner ${pendingWinner.name} skipped / removed from queue.`);
      const idx = evt.players.findIndex(x=>x.id===pendingWinner.id);
      if(idx>=0) evt.players.splice(idx,1);
    }
    pendingWinner=null;
    winnerOverlay.classList.remove('show');
    renderLeaderboard();
    saveAll();
  });

  colorChips.addEventListener('click',e=>{
    const chip = e.target.closest('.color-chip');
    if(!chip) return;
    const c = chip.dataset.color;
    if(selectedColorSet.has(c)){
      selectedColorSet.delete(c);
      chip.classList.remove('active');
    }else{
      selectedColorSet.add(c);
      chip.classList.add('active');
    }
  });

  queueChoice.addEventListener('click',e=>{
    const chip = e.target.closest('.queue-chip');
    if(!chip) return;
    queueReaddChoice = chip.dataset.choice;
    Array.from(queueChoice.children).forEach(ch=>{
      ch.classList.toggle('active', ch===chip);
    });
  });

  bonusChoice.addEventListener('click',e=>{
    const chip = e.target.closest('.queue-chip');
    if(!chip) return;
    bonusRewardChoice = chip.dataset.choice;
    Array.from(bonusChoice.children).forEach(ch=>{
      ch.classList.toggle('active', ch===chip);
    });
  });

  finishCancelBtn.addEventListener('click',()=>{
    finishOverlay.classList.remove('show');
  });

  finishSaveBtn.addEventListener('click',()=>{
    const evt = currentEvent();
    if(!evt.currentRun) return;

    // Prevent double-click by disabling button immediately
    if(finishSaveBtn.disabled) return;
    finishSaveBtn.disabled = true;

    const run = evt.currentRun;
    const player = evt.players.find(p=>p.id===run.playerId);
    if(!player){
      evt.currentRun=null;
      finishOverlay.classList.remove('show');
      finishSaveBtn.disabled = false;
      return;
    }
    const wins = Math.max(0,parseInt(runWinsInput.value,10)||0);
    const losses = Math.max(0,parseInt(runLossesInput.value,10)||0);
    const colors = Array.from(selectedColorSet).join('');  // Keep input order, don't sort
    const matchType = matchTypeSelect ? matchTypeSelect.value : 'BO3';
    player.overallWins += wins;
    player.overallLosses += losses;
    if(colors){
      let deck = player.decks.find(d=>d.color===colors);
      if(!deck){
        // Check 32 deck limit - supports all MTG color identities:
        // 5 mono (W,U,B,R,G) + 10 dual + 10 triple + 5 four-color + 1 five-color + 1 colorless
        if(player.decks.length >= 32){
          // Remove deck with lowest win percentage
          const sorted = player.decks.slice().sort((a,b)=>{
            const winRateA = (a.wins+a.losses)>0 ? a.wins/(a.wins+a.losses) : 0;
            const winRateB = (b.wins+b.losses)>0 ? b.wins/(b.wins+b.losses) : 0;
            if(winRateA !== winRateB) return winRateA - winRateB;
            return (a.wins+a.losses) - (b.wins+b.losses);
          });
          const toRemove = sorted[0];
          const idx = player.decks.indexOf(toRemove);
          if(idx >= 0){
            player.decks.splice(idx, 1);
            log(`${player.name} reached 32 deck limit. Removed deck ${toRemove.color} (lowest win rate).`);
          }
        }
        deck = {color:colors,wins:0,losses:0,lastBestOf:null};
        player.decks.push(deck);
      }
      deck.wins += wins;
      deck.losses += losses;
      deck.lastBestOf = matchType;
    }
    const hits = (currentWinnerMeta && currentWinnerMeta.hits) || 3;
    const bonus = hits>=5 ? 2 : hits===4 ? 1 : 0;

    // Check if this was a 4/5-of-a-kind and they chose extra games
    if(bonus > 0 && bonusRewardChoice === 'games' && !player.extraGamesRemaining){
      player.extraGamesRemaining = bonus;
      log(`${player.name} chose extra games bonus: ${bonus} additional game(s) remaining`);
    }

    // Check if player has extra games remaining
    if(player.extraGamesRemaining && player.extraGamesRemaining > 0){
      player.extraGamesRemaining--;
      if(player.extraGamesRemaining > 0){
        log(`${player.name} finished game. ${player.extraGamesRemaining} extra game(s) remaining.`);
        evt.currentRun=null;
        finishOverlay.classList.remove('show');
        finishSaveBtn.disabled = false;
        // Show them in the finish prompt again for next game
        setTimeout(()=> finishRunPrompt(player), 100);
        renderLeaderboard();
        saveAll();
        return;
      }else{
        log(`${player.name} finished all extra games. Re-entering queue.`);
        delete player.extraGamesRemaining;
      }
    }

    if(queueReaddChoice==='yes'){
      const bonusTickets = (bonus > 0 && bonusRewardChoice === 'tickets') ? bonus : 0;
      const baseTickets = 1 + bonusTickets;
      for(let i=0;i<5;i++){
        let newTickets = baseTickets;
        if(newTickets > TICKET_CAP){
          const overflow = newTickets - TICKET_CAP;
          newTickets = TICKET_CAP;
          applyOverflowToSparks(player, overflow);
        }
        player.tickets[i] = newTickets;
      }
      player.sparks = 0;
      player.createdAt = Date.now();
      clampPlayer(player);
      log(`${player.name} re-added to queue with ${baseTickets} ticket(s) per reel.`);

      // When winner re-enters, double all other active players' tickets (patience reward)
      // EXCEPT for ignited wins - don't double on ignited re-entry to prevent feedback loop
      const isIgnitedWin = currentWinnerMeta && currentWinnerMeta.reason === 'ignited';
      if(!isIgnitedWin){
        for(const other of evt.players){
          if(other.id === player.id) continue;
          if(other.status !== 'active') continue;
          doubleTicketsAllReels(other);
        }
        log(`All other players' tickets doubled (patience reward for ${player.name} re-entry).`);
      }else{
        log(`Ignited win re-entry: no doubling for others (prevents feedback loop).`);
      }
    }else{
      player.status='afk';
      log(`${player.name} marked as AFK.`);
    }
    log(`Reported run for ${player.name}: ${wins}W/${losses}L, colors=${colors||'none'}, type=${matchType}`);
    evt.currentRun=null;
    finishOverlay.classList.remove('show');
    finishSaveBtn.disabled = false;
    renderLeaderboard();
    saveAll();
  });

  function performSpin(){
    const evt = currentEvent();
    if(evt.currentRun){
      smallStatus.textContent = "Finish current run before next spin.";
      finishOverlay.classList.add('show');
      return;
    }

    // Update ignition queue with any players at 12 sparks
    updateIgnitionQueue(evt);

    // Check if we can process an ignition this spin (cooldown check)
    if(canTriggerIgnition(evt)){
      const ignitedPlayer = processIgnitionQueue(evt);
      if(ignitedPlayer){
        const activeCount = evt.players.filter(p=>p.status==='active').length;
        const cooldown = getIgnitionCooldown(activeCount);
        const queueLength = ignitedQueue.length;
        log(`<span style="color:#fcd34d;font-weight:600;">${ignitedPlayer.name} has been Ignited! (${ignitedPlayer.sparks} sparks, ${queueLength} in queue, cooldown: ${cooldown} spins)</span>`);
        // Start bulb celebration for ignited player
        startBulbsAnimation(false);
        setTimeout(()=>{
          stopBulbsAnimation();
          handleWinnerBanner(ignitedPlayer,'ignited',3,false);
        },1200);
        renderLeaderboard();
        saveAll();
        return;
      }
    }

    const activePlayers = evt.players.filter(p=>p.status==='active');
    if(activePlayers.length===0){
      smallStatus.textContent="No active players. Add someone first.";
      return;
    }
    spinBtn.disabled=true;
    leverEl.classList.add('pull');
    spinAnimationStart();
    smallStatus.textContent="Spinning";

    // Build spin result immediately (for timing calculation)
    const symbols = buildSpinResult(evt);
    const isCarlo = detectCarlo(symbols);
    let isLunaWin = false;
    const lunaPick = detectLunaWinner(evt,symbols);
    if(lunaPick) isLunaWin = true;
    const hasWinner = isCarlo || lunaPick || detectHitWinner(evt,symbols);

    // Start bulb animation immediately if there's a winner
    if(hasWinner){
      startBulbsAnimation(isLunaWin);
    }

    // Use cascading reel stops with callback when all reels finish
    spinAnimationStopCascade(() => {
      leverEl.classList.remove('pull');
      renderSpinResult(symbols);

      // Log Luna appearances (regardless of win/loss)
      const lunaCount = symbols.filter(s => s.type === 'luna').length;
      if(lunaCount > 0){
        const appearanceText = lunaCount === 1 ? 'appearance' : 'appearances';
        log(`<span style="color:#f973fa;font-weight:600;">Luna made ${lunaCount} ${appearanceText}</span>`);
      }

      const reelPlayers=[];
      symbols.forEach((s,idx)=>{
        if(s.type==='player') reelPlayers.push({index:idx,playerId:s.playerId});
      });
      let winner=null;
      let reason='normal';
      let hits=3;
      if(isCarlo){
        // CARLO: Bulbs already running, wait a bit more then show banner
        setTimeout(()=>{
          stopBulbsAnimation();
          evt.carloHits++;
          winnerOverlay.classList.add('show');
          winnerHeading.textContent='CARLO!';
          winnerNameEl.textContent='CARLO';
          winnerMetaEl.textContent='Streamer plays their own deck this round.';
          winnerLunaSticker.style.display='none';
          pendingWinner=null;
          currentWinnerMeta={reason:'carlo',hits:0};
          evt.spinCount++;
          evt.deadSpinStreak=0;
          renderLeaderboard();
          saveAll();
          spinBtn.disabled=false;
          smallStatus.textContent="Ready.";
        },200); // Short delay after last reel stops
        return;
      }
      if(lunaPick){
        winner = lunaPick.player;
        reason='luna';
        hits = lunaPick.hits;
        isLunaWin=true;
        evt.lunaHits++;
      }else{
        const hit = detectHitWinner(evt,symbols);
        if(hit){
          winner = hit.player;
          reason='normal';
          hits = hit.hits;
        }
      }
      if(winner){
        // Winner found: Bulbs already running, handle tickets then show banner
        handleWinTickets(evt,winner,symbols,reelPlayers);
        // Color code: pink for Luna wins, green for regular wins
        const winColor = isLunaWin ? '#f973fa' : '#22c55e';
        log(`<span style="color:${winColor};font-weight:600;">${winner.name} wins the slot (${reason}, hits=${hits}).</span>`);
        // Short delay after last reel stops before showing winner banner
        setTimeout(()=>{
          stopBulbsAnimation();
          handleWinnerBanner(winner,reason,hits,isLunaWin);
          spinBtn.disabled=false;
          smallStatus.textContent="Ready.";
        },200);
      }else{
        // Dead spin: No bulb celebration
        evt.deadSpinStreak++;
        log(`<span style="color:var(--red);">Dead spin (#${evt.deadSpinStreak}).</span>`);
        handleDeadSpinTickets(evt,symbols,reelPlayers);
        spinBtn.disabled=false;
        smallStatus.textContent="Ready.";
      }
      evt.spinCount++;
      renderLeaderboard();
      saveAll();
    });
  }

  spinBtn.addEventListener('click',performSpin);
  leverEl.addEventListener('click',performSpin);

  addPlayerForm.addEventListener('submit',e=>{
    e.preventDefault();
    e.stopPropagation();

    // Grab value FIRST
    const nameToAdd = playerNameInput.value.trim();

    // Immediately clear
    playerNameInput.value = '';

    // Add player if there's a name
    if(nameToAdd){
      addPlayer(nameToAdd);
    }

    // Ensure focus stays for next entry
    setTimeout(() => {
      playerNameInput.focus();
    }, 0);

    return false;
  });

  helpBtn.addEventListener('click',()=>helpOverlay.classList.add('show'));
  closeHelpBtn.addEventListener('click',()=>helpOverlay.classList.remove('show'));
  diagBtn.addEventListener('click',()=>diagOverlay.classList.add('show'));
  closeDiagBtn.addEventListener('click',()=>diagOverlay.classList.remove('show'));
  exportBtn.addEventListener('click',()=>{
    const exportData = {
      version: '1.0',
      exportDate: new Date().toISOString(),
      state: state,
      theme: document.body.className
    };
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `carlo-slot-session-${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    log('Session exported successfully.');
  });

  importBtn.addEventListener('click',()=>{
    importFileInput.click();
  });

  importFileInput.addEventListener('change',e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = evt=>{
      try{
        const imported = JSON.parse(evt.target.result);
        if(!imported.state){
          alert('Invalid import file: missing state data.');
          return;
        }
        if(!confirm('Import will replace ALL current data. Continue?')) return;
        state.events = imported.state.events || [];
        state.currentEventIndex = imported.state.currentEventIndex || 1;
        if(imported.theme){
          const themeMatch = imported.theme.match(/theme-(white|blue|black|red|green)/);
          if(themeMatch){
            const colorMap = {white:'W',blue:'U',black:'B',red:'R',green:'G'};
            applyTheme(colorMap[themeMatch[1]]);
          }
        }
        log('Session imported successfully.');
        renderEvents();
        renderLeaderboard();
        saveAll();
      }catch(err){
        alert('Import failed: ' + err.message);
      }
    };
    reader.readAsText(file);
    importFileInput.value = '';
  });

  resetEventBtn.addEventListener('click',()=>{
    if(!confirm("Factory reset this session? All players and stats will be lost."))return;
    state.events[state.currentEventIndex]={
      players:[],
      spinCount:0,
      deadSpinStreak:0,
      currentRun:null,
      carloHits:0,
      lunaHits:0
    };
    log('Session reset.');
    renderLeaderboard();
    saveAll();
  });

  runDiagNowBtn.addEventListener('click',()=>{
    const evt = currentEvent();
    const players = evt.players.filter(p=>p.status==='active');
    if(players.length===0){
      diagResult.innerHTML='<span class="warn">No active players. Add some before running diagnostics.</span>';
      return;
    }
    const sim = runDiagnosticsSimulation(evt,300);
    const passWins = sim.wins>=100;
    const passCarlo = sim.carlo>=4;
    const passLuna = sim.luna>=10;
    const passFourKind = sim.fourKind>=2;
    const passFiveKind = sim.fiveKind>=1;
    const ignitedRate = (sim.ignitedWins / 300 * 100).toFixed(1);
    const passIgnited = sim.ignitedWins <= 30; // Less than 10% is good
    const allPass = passWins && passCarlo && passLuna && passFourKind && passFiveKind && passIgnited;
    diagResult.innerHTML = `
      <div><strong>Simulated 300 spins (Hypergeometric):</strong></div>
      <div>Total wins: ${sim.wins} ${passWins?'<span class="pass">(100 )</span>':'<span class="warn">(Need 100)</span>'}</div>
      <div>CARLO jackpots: ${sim.carlo} ${passCarlo?'<span class="pass">(4 )</span>':'<span class="warn">(Need 4)</span>'}</div>
      <div>Luna Luck wins: ${sim.luna} ${passLuna?'<span class="pass">(10 )</span>':'<span class="warn">(Need 10)</span>'}</div>
      <div>4-of-a-kind: ${sim.fourKind} ${passFourKind?'<span class="pass">(2 )</span>':'<span class="warn">(Need 2)</span>'}</div>
      <div>5-of-a-kind: ${sim.fiveKind} ${passFiveKind?'<span class="pass">(1 )</span>':'<span class="warn">(Need 1)</span>'}</div>
      <div>Ignited wins: ${sim.ignitedWins} (${ignitedRate}%) ${passIgnited?'<span class="pass">(10% )</span>':'<span class="warn">(>10% - too many)</span>'}</div>
      <div style="margin-top:8px;font-weight:700;">${allPass?'<span class="pass">All checks PASSED </span>':'<span class="warn">Some checks FAILED</span>'}</div>
    `;
  });

  function runDiagnosticsSimulation(evt, spins){
    const players = evt.players.filter(p=>p.status==='active').map(p=>{
      return {
        name:p.name,
        tickets:p.tickets.slice(),
        sparks:p.sparks,
        createdAt:p.createdAt
      };
    });
    function randomPlayer(idx, arr){
      let tot=0;
      arr.forEach(p=>tot+=p.tickets[idx]);
      const r=Math.random()*tot;
      let x=r;
      for(const p of arr){
        if(x < p.tickets[idx]) return p;
        x -= p.tickets[idx];
      }
      return arr[arr.length-1];
    }
    function normTickets(){
      players.forEach(p=>{
        const tot=totalTickets(p);
        if(tot===0) p.tickets=[1,1,1,1,1];
      });
    }
    normTickets();
    let wins=0, carlo=0, luna=0, fourKind=0, fiveKind=0, ignitedWins=0;
    for(let spin=0;spin<spins;spin++){
      const candIgnited = players.filter(p=>p.sparks>=MAX_SPARKS);
      if(candIgnited.length>0){
        candIgnited.sort((a,b)=>{
          if(a.createdAt !== b.createdAt) return a.createdAt - b.createdAt;
          if(b.sparks !== a.sparks) return b.sparks - a.sparks;
          const td = totalTickets(b) - totalTickets(a);
          return td !== 0 ? td : a.name.localeCompare(b.name);
        });
        const p = candIgnited[0];
        wins++;ignitedWins++;p.sparks=0;
        continue;
      }
      const active = players.slice();
      const symbols=[];
      let lunaIndex=-1;
      if(Math.random() < LUNA_BASE_ODDS){
        lunaIndex=Math.floor(Math.random()*5);
      }
      const letters=['C','A','R','L','O'];
      for(let i=0;i<5;i++){
        if(i===lunaIndex){symbols.push({type:'luna'});continue;}
        if(Math.random() < CARLO_LETTER_ODDS){
          symbols.push({type:'letter',letter:letters[i]});
        }else{
          const p = randomPlayer(i,active);
          symbols.push({type:'player',name:p.name});
        }
      }
      if(symbols.every((s,i)=>s.type==='letter' && s.letter===letters[i])){carlo++;continue;}
      let lunaWinner=null;
      if(lunaIndex!==-1){
        for(let i=-2;i<=0;i++){
          const idx=lunaIndex+i;
          if(idx<0||idx+2>=5) continue;
          const triple=symbols.slice(idx,idx+3);
          const ps=triple.filter(x=>x.type==='player');
          if(ps.length===0) continue;
          const cts={};ps.forEach(x=>cts[x.name]=(cts[x.name]||0)+1);
          const candidate=Object.keys(cts).find(n=>cts[n]>=2);
          if(candidate){
            lunaWinner=candidate;break;
          }else if(ps.length===1){
            lunaWinner=ps[0].name;break;
          }
        }
      }
      if(lunaWinner){luna++;wins++;continue;}
      const hits={};
      let hitPlayer=null;let hitCount=0;
      symbols.forEach(s=>{
        if(s.type==='player'){
          hits[s.name]=(hits[s.name]||0)+1;
          if(hits[s.name]>hitCount){
            hitPlayer=s.name;
            hitCount=hits[s.name];
          }
        }
      });
      if(hitCount>=3){
        wins++;
        if(hitCount===4) fourKind++;
        if(hitCount===5) fiveKind++;
      }
    }
    return {wins, carlo, luna, fourKind, fiveKind, ignitedWins};
  }

  function toggleThemeColor(code){
    if(selectedColors.has(code)){
      selectedColors.delete(code);
      // Allow no colors selected - removes all glows
    }else{
      selectedColors.add(code);
    }
    applyMultiTheme();
  }

  function applyMultiTheme(){
    // Remove old theme classes
    const classes = ['theme-white','theme-blue','theme-black','theme-red','theme-green','theme-gold'];
    document.body.classList.remove(...classes);

    // If all 5 colors selected, use gold
    if(selectedColors.size === 5){
      document.body.classList.add('theme-gold');
    }else{
      // Use the first selected color as primary theme
      const primary = Array.from(selectedColors)[0];
      let cls='';
      if(primary==='W') cls='theme-white';
      else if(primary==='U') cls='theme-blue';
      else if(primary==='B') cls='theme-black';
      else if(primary==='R') cls='theme-red';
      else if(primary==='G') cls='theme-green';
      document.body.classList.add(cls);
    }

    // Update active chips
    themeChips.forEach(ch=>{
      ch.classList.toggle('active', selectedColors.has(ch.dataset.color));
    });

    // Apply animated gradient glow
    applyGradientGlow();

    // Save to localStorage
    localStorage.setItem('carlo_theme_multi', JSON.stringify(Array.from(selectedColors)));
  }

  // MTG Color Identity Mappings - Proper ordering for all combinations
  const COLOR_HEX = {
    'W': '#fefce8',
    'U': '#38bdf8',
    'B': '#4b5563',
    'R': '#fb4b4b',
    'G': '#22c55e'
  };

  const MTG_COLOR_ORDERS = {
    // Mono (5)
    'W': ['W'],
    'U': ['U'],
    'B': ['B'],
    'R': ['R'],
    'G': ['G'],
    // Dual (10) - Allied pairs
    'WU': ['W','U'], // Azorius
    'UB': ['U','B'], // Dimir
    'BR': ['B','R'], // Rakdos
    'RG': ['R','G'], // Gruul
    'GW': ['G','W'], // Selesnya
    // Dual - Enemy pairs
    'WB': ['W','B'], // Orzhov
    'UR': ['U','R'], // Izzet
    'BG': ['B','G'], // Golgari
    'WR': ['W','R'], // Boros
    'UG': ['U','G'], // Simic
    // Triple (10) - Shards
    'GWU': ['G','W','U'], // Bant
    'WUB': ['W','U','B'], // Esper
    'UBR': ['U','B','R'], // Grixis
    'BRG': ['B','R','G'], // Jund
    'RGW': ['R','G','W'], // Naya
    // Triple - Wedges
    'WBG': ['W','B','G'], // Abzan
    'URW': ['U','R','W'], // Jeskai
    'BGU': ['B','G','U'], // Sultai
    'RWB': ['R','W','B'], // Mardu
    'GUR': ['G','U','R'], // Temur
    // Four-color (5)
    'UBRG': ['U','B','R','G'],
    'BRGW': ['B','R','G','W'],
    'RGWU': ['R','G','W','U'],
    'GWUB': ['G','W','U','B'],
    'WUBR': ['W','U','B','R'],
    // Five-color (1)
    'WUBRG': ['W','U','B','R','G']
  };

  function getColorIdentityKey(colorSet){
    const sorted = Array.from(colorSet).sort((a,b)=>{
      const order = ['W','U','B','R','G'];
      return order.indexOf(a) - order.indexOf(b);
    });
    return sorted.join('');
  }

  function applyGradientGlow(){
    // No colors selected - default to white glow
    if(selectedColors.size === 0){
      const whiteGradient = 'linear-gradient(90deg, #ffffff, #e5e7eb, #d1d5db, #ffffff)';
      document.documentElement.style.setProperty('--gradient-border', whiteGradient);
      document.documentElement.style.setProperty('--gradient-border-size', '200%');
      document.documentElement.style.setProperty('--logo-ring-gradient', `conic-gradient(from 0deg, #ffffff 0deg 60deg, transparent 60deg 120deg, #ffffff 120deg 180deg, transparent 180deg 240deg, #ffffff 240deg 300deg, transparent 300deg 360deg)`);
      document.documentElement.style.setProperty('--theme-glow', 'rgba(255,255,255,0.4)');
      document.documentElement.style.setProperty('--theme-color', '#ffffff');
      return;
    }

    // Get the proper MTG color order for this combination
    const identityKey = getColorIdentityKey(selectedColors);
    const colorOrder = MTG_COLOR_ORDERS[identityKey] || Array.from(selectedColors);
    const colors = colorOrder.map(code => COLOR_HEX[code]);

    // All 5 selected = gold with WUBRG order
    if(selectedColors.size === 5){
      const allColors = colors.join(', ');
      document.documentElement.style.setProperty('--multi-theme-gradient', '#fcd34d');
      document.documentElement.style.setProperty('--gradient-border', `linear-gradient(90deg, ${allColors}, ${allColors})`);
      document.documentElement.style.setProperty('--gradient-border-size', '200%');
      document.documentElement.style.setProperty('--button-text-color', `linear-gradient(90deg, ${allColors})`);
      document.documentElement.style.setProperty('--button-text-is-gradient', '1');
      const segments = colors.map((c, i) => {
        const start = i * 72;
        const end = start + 36;
        return `${c} ${start}deg ${end}deg, transparent ${end}deg ${(i + 1) * 72}deg`;
      }).join(', ');
      document.documentElement.style.setProperty('--logo-ring-gradient', `conic-gradient(from 0deg, ${segments})`);
      return;
    }

    // Non-gold mode: white text for buttons
    document.documentElement.style.setProperty('--button-text-color', '#ffffff');
    document.documentElement.style.setProperty('--button-text-is-gradient', '0');

    // Create animated gradient with proper MTG color order
    if(colors.length > 1){
      const gradient = `linear-gradient(90deg, ${colors.join(', ')}, ${colors.join(', ')})`;
      document.documentElement.style.setProperty('--multi-theme-gradient', gradient);
      document.documentElement.style.setProperty('--gradient-border', gradient);
      document.documentElement.style.setProperty('--gradient-border-size', '200%');
    } else {
      const singleColorGradient = `linear-gradient(90deg, ${colors[0]}, ${colors[0]}, ${colors[0]})`;
      document.documentElement.style.setProperty('--multi-theme-gradient', singleColorGradient);
      document.documentElement.style.setProperty('--gradient-border', singleColorGradient);
      document.documentElement.style.setProperty('--gradient-border-size', '200%');
    }

    // Create conic gradient for logo ring
    if(colors.length > 1){
      const segments = colors.map((c, i) => {
        const degreesPerColor = 360 / colors.length;
        const start = i * degreesPerColor;
        const end = start + (degreesPerColor / 2);
        return `${c} ${start}deg ${end}deg, transparent ${end}deg ${(i + 1) * degreesPerColor}deg`;
      }).join(', ');
      document.documentElement.style.setProperty('--logo-ring-gradient', `conic-gradient(from 0deg, ${segments})`);
    } else {
      document.documentElement.style.setProperty('--logo-ring-gradient', `conic-gradient(from 0deg,
        ${colors[0]} 0deg 60deg,
        transparent 60deg 120deg,
        ${colors[0]} 120deg 180deg,
        transparent 180deg 240deg,
        ${colors[0]} 240deg 300deg,
        transparent 300deg 360deg)`);
    }
  }

  themeChips.forEach(ch=>{
    ch.addEventListener('click',()=>toggleThemeColor(ch.dataset.color));
  });

  function loadTheme(){
    const saved = localStorage.getItem('carlo_theme_multi');
    if(saved){
      try{
        selectedColors = new Set(JSON.parse(saved));
      }catch(e){
        selectedColors = new Set(); // Empty = white glow default
      }
    }else{
      // Migrate old single-color theme
      const oldSaved = localStorage.getItem('carlo_theme');
      if(oldSaved){
        selectedColors = new Set([oldSaved]);
      }else{
        // Default to white glow (no theme selected)
        selectedColors = new Set();
      }
    }
    applyMultiTheme();
  }

  function init(){
    loadAll();
    initBulbs();
    setupReelsPlaceholder();
    renderEvents();
    renderLeaderboard();
    loadTheme();
    timeTimer = setInterval(renderLeaderboard, 30000);
  }
  init();
})();
</script>
</body>
</html>
