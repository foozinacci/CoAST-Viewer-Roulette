<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CarloMTG Viewer Slot Machine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg:#020617;
      --panel:#0b0f1a;
      --border:#273549;
      --accent:#60a5fa;
      --gold:#facc15;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --danger:#f97373;
      --ok:#4ade80;
      --reel-width:80px;
      --reel-height:120px;
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#1f2937 0,#020617 50%,#000 100%);
      color:var(--text);
      display:flex;
      justify-content:center;
      min-height:100vh;
    }

    #app {
      width:100%;
      max-width:1200px;
      margin:8px;
      border-radius:18px;
      border:1px solid var(--border);
      background:linear-gradient(135deg,#020617 0,#020617 40%,#020617 60%,#000 100%);
      box-shadow:0 0 40px rgba(0,0,0,.8);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    /* HEADER */

    header {
      padding:10px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }

    .header-left {
      display:flex;
      gap:10px;
      align-items:center;
    }

    .logo {
      width:44px;
      height:44px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--gold);
      box-shadow:0 0 12px rgba(250,204,21,.6);
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .logo img {
      width:100%;
      height:100%;
      object-fit:contain;
    }

    .title-block {
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .title {
      font-size:18px;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--gold);
      text-shadow:0 0 10px rgba(250,204,21,.55);
    }

    .subtitle {
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }

    .header-right {
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      font-size:11px;
      color:var(--muted);
    }

    .spin-meta span {
      color:var(--accent);
      font-weight:600;
    }

    /* LAYOUT: SLOT + SIDE */

    main {
      flex:1;
      display:flex;
      flex-direction:column;
      overflow:auto;
    }

    .slot-layout {
      display:grid;
      grid-template-columns:2.1fr 1.4fr;
      gap:10px;
      padding:10px;
    }

    @media(max-width:900px){
      .slot-layout {
        grid-template-columns:1fr;
      }
    }

    .slot-panel,
    .side-panel {
      background:radial-gradient(circle at top,#020617 0,#020617 50%,#000 100%);
      border-radius:16px;
      border:1px solid var(--border);
      padding:10px;
      position:relative;
      overflow:hidden;
    }

    .slot-panel::before {
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at top,rgba(250,250,250,.04) 0,transparent 55%),
        radial-gradient(circle at center,rgba(56,189,248,.05) 0,transparent 55%),
        radial-gradient(circle at bottom,rgba(236,72,153,.07) 0,transparent 60%);
      opacity:.45;
      pointer-events:none;
    }

    /* SLOT HEADER */

    .slot-header {
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-bottom:6px;
      position:relative;
      z-index:1;
    }

    .slot-title {
      font-size:13px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }

    #statusText {
      font-size:11px;
      color:var(--muted);
      text-align:right;
    }

    /* REELS + LEVER AREA */

    .slot-main-row {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:18px;
      position:relative;
      z-index:1;
      padding:6px 0 4px;
    }

    .reels-shell {
      position:relative;
      padding:18px 18px 26px;
      flex:1 1 auto;
      max-width:520px;
    }

    /* LIGHTS WRAP ONLY REELS */

    .bulb-row {
      position:absolute;
      left:20px;
      right:20px;
      height:8px;
      display:flex;
      justify-content:space-between;
      pointer-events:none;
    }

    .bulb-row.top { top:4px; }
    .bulb-row.bottom { bottom:4px; }

    .bulb-col {
      position:absolute;
      top:18px;
      bottom:22px;
      width:8px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      pointer-events:none;
    }

    .bulb-col.left { left:4px; }
    .bulb-col.right { right:4px; }

    .bulb {
      width:8px;
      height:8px;
      border-radius:999px;
      background:#4b5563;
      box-shadow:0 0 4px rgba(0,0,0,.8);
    }

    .bulb.active {
      box-shadow:0 0 10px currentColor;
    }

    .reels-box {
      position:relative;
      border-radius:16px;
      border:2px solid rgba(148,116,72,.9);
      background:linear-gradient(180deg,#020617 0,#020617 40%,#000 100%);
      padding:10px 8px 14px;
      box-shadow:
        inset 0 0 18px rgba(15,23,42,.9),
        0 0 26px rgba(0,0,0,.9);
      overflow:hidden;
    }

    .reel-labels {
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
      font-size:10px;
      color:var(--muted);
      letter-spacing:.18em;
      text-transform:uppercase;
    }

    .reels {
      display:flex;
      gap:6px;
      justify-content:space-between;
    }

    .reel {
      flex:1;
      background:radial-gradient(circle at top,#020617 0,#000 70%);
      border-radius:12px;
      border:1px solid rgba(148,116,72,.7);
      padding:16px 4px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
      box-shadow:
        inset 0 0 18px rgba(15,23,42,.9),
        0 0 18px rgba(0,0,0,.9);
      min-width:0;
    }

    .reel-inner {
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      transform:translateY(0);
      transition:transform .18s ease-out;
    }

    .reel-symbol {
      font-size:14px;
      font-weight:800;
      text-transform:uppercase;
      padding:4px 6px;
      border-radius:8px;
      min-width:64px;
      max-width:100%;
      text-align:center;
      box-shadow:0 0 10px rgba(15,23,42,.9);
      white-space:normal;
      line-height:1.1;
      word-break:break-word;
    }

    .reel-symbol.player {
      background:rgba(15,23,42,.95);
      border:1px solid rgba(248,250,252,.25);
      color:#f9fafb;
      text-shadow:0 0 8px rgba(248,250,252,.7);
    }

    .reel-symbol.letter {
      background:rgba(15,23,42,.95);
      border:1px solid var(--gold);
      color:var(--gold);
      text-shadow:0 0 12px rgba(250,204,21,.9);
    }

    .reel-symbol.luna {
      background:rgba(15,23,42,.95);
      border:1px solid #f973fa;
      box-shadow:0 0 16px rgba(244,114,182,.9);
      color:#f9a8d4;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .reel-symbol.luna img {
      max-width:40px;
      max-height:40px;
      border-radius:999px;
      display:block;
    }

    .reel.glow-win {
      box-shadow:0 0 28px rgba(250,204,21,.8),
                 inset 0 0 20px rgba(250,250,250,.1);
      border-color:var(--gold);
    }

    .reel.glow-carlo {
      box-shadow:0 0 26px rgba(56,189,248,.9),
                 inset 0 0 20px rgba(15,23,42,.95);
      border-color:#38bdf8;
    }

    .reel.glow-luna {
      box-shadow:0 0 24px rgba(244,114,182,.95),
                 inset 0 0 18px rgba(24,24,27,.9);
      border-color:#f973fa;
    }

    @keyframes reelSpin {
      0%   { transform:translateY(0); }
      100% { transform:translateY(-40%); }
    }
    .reel.spinning .reel-inner {
      animation:reelSpin .25s linear infinite;
    }

    /* LEVER TO THE RIGHT OF REELS */

    .lever-column {
      display:flex;
      align-items:center;
      justify-content:center;
      padding-right:6px;
    }

    .lever {
      width:24px;
      height:120px;
      border-radius:999px;
      background:linear-gradient(180deg,#111827 0,#020617 100%);
      border:1px solid #4b5563;
      position:relative;
      box-shadow:
        inset 0 0 8px rgba(15,23,42,.9),
        0 0 16px rgba(0,0,0,.8);
      cursor:pointer;
    }

    .lever-knob {
      width:28px;
      height:28px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%,#fee2e2 0,#f97373 35%,#7f1d1d 100%);
      border:2px solid #fef2f2;
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:-14px;
      box-shadow:0 0 16px rgba(248,113,113,.85);
      transition:top .14s ease-out;
    }

    .lever.pull .lever-knob {
      top:72px;
    }

    /* CONTROLS UNDER REELS */

    .controls {
      margin-top:10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      position:relative;
      z-index:1;
    }

    .control-buttons {
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn {
      border-radius:999px;
      padding:8px 18px;
      border:none;
      font-size:12px;
      font-weight:700;
      letter-spacing:.18em;
      text-transform:uppercase;
      cursor:pointer;
      background:radial-gradient(circle at top,#3b82f6 0,#1d4ed8 40%,#1e3a8a 100%);
      color:#eef2ff;
      text-shadow:0 0 4px rgba(15,23,42,.8);
      box-shadow:0 0 14px rgba(59,130,246,.6),
                 inset 0 0 4px rgba(248,250,252,.3);
      transition:transform .1s ease-out,box-shadow .1s ease-out,opacity .1s ease-out;
    }

    .btn.secondary {
      background:radial-gradient(circle at top,#6b7280 0,#4b5563 40%,#111827 100%);
      color:#e5e7eb;
      box-shadow:0 0 10px rgba(107,114,128,.6);
      letter-spacing:.14em;
    }

    .btn:disabled {
      opacity:.45;
      cursor:default;
      box-shadow:0 0 6px rgba(15,23,42,.9);
    }

    .btn:active:not(:disabled) {
      transform:translateY(1px) scale(.99);
      box-shadow:0 0 8px rgba(59,130,246,.5),
                 inset 0 0 3px rgba(15,23,42,.9);
    }

    .small-status {
      font-size:11px;
      color:var(--muted);
      text-align:center;
      min-height:1.2em;
    }

    /* SIDE PANEL (simplified but breathable) */

    .side-panel-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }

    .side-panel-section-title {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
    }

    .add-player-form {
      display:flex;
      gap:6px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }

    .add-player-form input {
      flex:1;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      font-size:11px;
      padding:6px 8px;
    }

    .add-player-form button {
      border-radius:999px;
      border:1px solid var(--accent);
      background:radial-gradient(circle at top,#60a5fa 0,#2563eb 40%,#1d4ed8 100%);
      font-size:11px;
      padding:6px 10px;
      color:#0b1120;
      text-transform:uppercase;
      letter-spacing:.12em;
      cursor:pointer;
      box-shadow:0 0 12px rgba(59,130,246,.7),
                 inset 0 0 5px rgba(248,250,252,.4);
    }

    .summary-cards {
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-bottom:8px;
      font-size:11px;
    }

    .summary-card {
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      padding:6px 8px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .summary-label {
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.14em;
      font-size:10px;
    }

    .summary-value {
      font-weight:600;
      font-size:12px;
    }

    .leaderboard-wrapper {
      max-height:260px;
      overflow:auto;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(15,23,42,.9);
      margin-top:6px;
    }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }

    thead {
      position:sticky;
      top:0;
      background:#020617;
      z-index:1;
    }

    th, td {
      border-bottom:1px solid var(--border);
      padding:4px 6px;
      text-align:left;
      vertical-align:top;
    }

    th {
      text-transform:uppercase;
      letter-spacing:.12em;
      font-size:10px;
      color:var(--muted);
    }

    .time-cell { color:var(--muted); white-space:nowrap; }
    .pity-pill {
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:10px;
      display:inline-block;
      min-width:22px;
      text-align:center;
    }

    .pity-pill.hot {
      border-color:var(--danger);
      color:#fecaca;
      box-shadow:0 0 10px rgba(248,113,113,.9);
    }

    .log {
      margin-top:8px;
      padding-top:6px;
      border-top:1px solid var(--border);
      font-size:11px;
      max-height:120px;
      overflow-y:auto;
      color:var(--muted);
    }

    .log-entry + .log-entry {
      margin-top:2px;
    }

    /* OVERLAYS (winner + finish) */

    .overlay {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.9);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }

    .overlay.show { display:flex; }

    .winner-card,
    .finish-card {
      width:100%;
      max-width:460px;
      border-radius:18px;
      border:1px solid var(--border);
      background:radial-gradient(circle at top,#1e293b 0,#020617 50%,#000 100%);
      padding:14px 16px 18px;
      box-shadow:0 0 30px rgba(0,0,0,.9);
      font-size:12px;
      position:relative;
    }

    .winner-heading {
      font-size:16px;
      font-weight:900;
      letter-spacing:.24em;
      text-transform:uppercase;
      color:var(--gold);
      text-align:center;
      margin-bottom:6px;
    }

    .winner-name {
      font-size:18px;
      font-weight:800;
      text-align:center;
      margin-bottom:4px;
    }

    .winner-meta {
      font-size:12px;
      color:var(--muted);
      text-align:center;
      margin-bottom:10px;
    }

    .winner-actions,
    .finish-actions {
      display:flex;
      justify-content:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }

    .winner-actions button,
    .finish-actions button {
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      font-size:11px;
      padding:6px 10px;
      cursor:pointer;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }

    .finish-actions .primary {
      border-color:var(--gold);
      color:var(--gold);
    }

    .finish-field { margin-bottom:8px; }

    .finish-label {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-bottom:4px;
    }

    .finish-input-row {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }

    .finish-input-row input[type="number"] {
      width:80px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      font-size:12px;
      padding:4px 8px;
    }

    .queue-choice {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .queue-chip {
      border-radius:999px;
      border:1px solid var(--border);
      padding:4px 10px;
      font-size:11px;
      cursor:pointer;
      text-transform:uppercase;
      letter-spacing:.1em;
      opacity:.7;
    }

    .queue-chip.active {
      opacity:1;
      border-color:var(--accent);
      color:var(--accent);
      box-shadow:0 0 8px rgba(96,165,250,.8);
    }

    /* RESPONSIVE TWEAKS */

    @media(max-width:900px){
      .slot-panel { margin-bottom:8px; }
      :root {
        --reel-width:60px;
        --reel-height:90px;
      }
      .reel-symbol { font-size:12px; }
      .lever { height:100px; }
      .lever.pull .lever-knob { top:60px; }
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="header-left">
      <div class="logo">
        <img src="https://i.ibb.co/PvbYChDZ/G0-Gsi-Gv-XIAEk-Rf1-removebg-preview.png" alt="CARLO" />
      </div>
      <div class="title-block">
        <div class="title">CARLO SLOT</div>
        <div class="subtitle">Viewer Deck Roulette · 5-Reel · Luna Luck &amp; Carlo Jackpots</div>
      </div>
    </div>
    <div class="header-right">
      <div class="spin-meta">
        Spins: <span id="spinCount">0</span> · Dead streak: <span id="deadStreak">0</span>
      </div>
      <div class="spin-meta">
        Active players: <span id="playerCount">0</span> / 50 · Ticket cap: 500 · Pity max: 7
      </div>
    </div>
  </header>

  <main>
    <div class="slot-layout">
      <!-- SLOT SIDE -->
      <section class="slot-panel">
        <div class="slot-header">
          <div class="slot-title">Five-Reel Viewer Slot</div>
          <div id="statusText">Add players, then spin.</div>
        </div>

        <!-- reels + lever row -->
        <div class="slot-main-row">
          <!-- reels with lights around ONLY this box -->
          <div class="reels-shell">
            <div class="bulb-row top" id="bulbRowTop"></div>
            <div class="bulb-row bottom" id="bulbRowBottom"></div>
            <div class="bulb-col left" id="bulbColLeft"></div>
            <div class="bulb-col right" id="bulbColRight"></div>

            <div class="reels-box">
              <div class="reel-labels">
                <span>C</span><span>A</span><span>R</span><span>L</span><span>O</span>
              </div>
              <div class="reels" id="reels"></div>
            </div>
          </div>

          <!-- lever to the RIGHT of reels -->
          <div class="lever-column">
            <div class="lever" id="lever">
              <div class="lever-knob"></div>
            </div>
          </div>
        </div>

        <!-- centered controls under reels -->
        <div class="controls">
          <div class="control-buttons">
            <button class="btn" id="spinBtn">SPIN</button>
            <button class="btn secondary" id="reportBtn">REPORT RESULTS</button>
          </div>
          <div class="small-status" id="smallStatus">Ready.</div>
        </div>
      </section>

      <!-- SIDE PANEL -->
      <section class="side-panel">
        <div class="side-panel-header">
          <div class="side-panel-section-title">Leaderboard &amp; Odds</div>
        </div>

        <form class="add-player-form" id="addPlayerForm">
          <input id="playerNameInput" placeholder="Viewer name / handle" autocomplete="off" />
          <button type="submit">Add</button>
        </form>

        <div class="summary-cards">
          <div class="summary-card">
            <div class="summary-label">Diag target (150 spins)</div>
            <div class="summary-value">≈50 wins · ≈2× CARLO · ≈5× Luna</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">Rules snapshot</div>
            <div class="summary-value">3+ of a kind wins · Luna wild in 3-windows · Pity @ 7</div>
          </div>
        </div>

        <div class="leaderboard-wrapper">
          <table>
            <thead>
            <tr>
              <th>Time</th>
              <th>Player</th>
              <th>Tickets</th>
              <th>Spins</th>
              <th>Pity</th>
              <th>Slot W%</th>
              <th>Deck W-L</th>
            </tr>
            </thead>
            <tbody id="leaderboardBody"></tbody>
          </table>
        </div>

        <div class="log" id="log"></div>
      </section>
    </div>
  </main>
</div>

<!-- Winner overlay -->
<div class="overlay" id="winnerOverlay">
  <div class="winner-card">
    <div class="winner-heading">WINNER</div>
    <div class="winner-name" id="winnerName"></div>
    <div class="winner-meta" id="winnerMeta"></div>
    <div class="winner-actions">
      <button id="winnerCloseBtn">Close</button>
      <button id="winnerReportBtn">Report Results</button>
    </div>
  </div>
</div>

<!-- Finish / report overlay -->
<div class="overlay" id="finishOverlay">
  <div class="finish-card">
    <div class="finish-title" id="finishTitle"></div>
    <div class="finish-sub">Record this run, then decide whether to re-add them to the queue.</div>

    <div class="finish-field">
      <div class="finish-label">Run record</div>
      <div class="finish-input-row">
        <label>Wins <input type="number" id="runWins" min="0" value="0"></label>
        <label>Losses <input type="number" id="runLosses" min="0" value="1"></label>
      </div>
    </div>

    <div class="finish-field">
      <div class="finish-label">Re-add to queue?</div>
      <div class="queue-choice">
        <div class="queue-chip active" data-readd="yes">Re-add with tickets</div>
        <div class="queue-chip" data-readd="no">Don’t re-add</div>
      </div>
    </div>

    <div class="finish-actions">
      <button id="finishCancelBtn">Cancel</button>
      <button class="primary" id="finishSaveBtn">Save</button>
    </div>
  </div>
</div>

<script>
  // ========= CONFIG =========
  const NUM_REELS = 5;
  const INITIAL_TICKETS = [1,1,1,1,1];
  const MAX_TICKETS_PER_REEL = 500;
  const PITY_CAP = 7;
  const CARLO = ["C","A","R","L","O"];
  const LUNA_PROB = 1/30;   // ≈3.3%
  const LETTER_PROB = 1/75; // ≈1.3%

  // ========= STATE =========
  const state = {
    spinCount: 0,
    deadStreak: 0,
    nextPlayerId: 1,
    players: [],
    lastSpin: null,
    currentWinner: null
  };

  // ========= UTILITIES =========
  const $ = sel => document.querySelector(sel);
  const logEl = $("#log");
  function log(msg){
    const div = document.createElement("div");
    div.className = "log-entry";
    const time = new Date().toLocaleTimeString();
    div.textContent = `[${time}] ${msg}`;
    logEl.prepend(div);
  }

  function updateHeaderStats(){
    $("#spinCount").textContent = state.spinCount;
    $("#deadStreak").textContent = state.deadStreak;
    $("#playerCount").textContent = state.players.filter(p => !p.afk).length;
  }

  function timeSince(ts){
    const diff = Date.now() - ts;
    const s = Math.floor(diff/1000);
    if (s < 60) return s + "s";
    const m = Math.floor(s/60);
    if (m < 60) return m + "m " + (s%60) + "s";
    const h = Math.floor(m/60);
    return h + "h " + (m%60) + "m";
  }

  function clampTicketsAndOverflow(player){
    for(let i=0;i<NUM_REELS;i++){
      let t = player.tickets[i];
      if(t < 1) t = 1;
      if(t > MAX_TICKETS_PER_REEL){
        const overflow = t - MAX_TICKETS_PER_REEL;
        const overflowMod = overflow % 500;
        const pityGain = Math.floor(overflow / 500) || 1;
        player.tickets[i] = Math.max(overflowMod,1);
        player.pity = Math.min(PITY_CAP, player.pity + pityGain);
      } else {
        player.tickets[i] = t;
      }
    }
    if(player.pity > PITY_CAP) player.pity = PITY_CAP;
  }

  // ========= RENDER: REELS + LIGHTS =========
  function buildLights(){
    const top = $("#bulbRowTop");
    const bottom = $("#bulbRowBottom");
    const left = $("#bulbColLeft");
    const right = $("#bulbColRight");
    top.innerHTML = "";
    bottom.innerHTML = "";
    left.innerHTML = "";
    right.innerHTML = "";

    const colors = ["#facc15","#38bdf8","#22c55e","#fb7185","#a855f7","#e5e7eb"];
    const topCount = 24;
    for(let i=0;i<topCount;i++){
      const b1 = document.createElement("div");
      const b2 = document.createElement("div");
      b1.className = b2.className = "bulb";
      const c = colors[i % colors.length];
      b1.style.color = b2.style.color = c;
      b1.style.backgroundColor = b2.style.backgroundColor = c;
      top.appendChild(b1);
      bottom.appendChild(b2);
    }
    const sideCount = 14;
    for(let i=0;i<sideCount;i++){
      const bL = document.createElement("div");
      const bR = document.createElement("div");
      bL.className = bR.className = "bulb";
      const c = colors[(i+2) % colors.length];
      bL.style.color = bR.style.color = c;
      bL.style.backgroundColor = bR.style.backgroundColor = c;
      left.appendChild(bL);
      right.appendChild(bR);
    }
  }

  function renderReels(spinSymbols){
    const reelsEl = $("#reels");
    reelsEl.innerHTML = "";
    for(let i=0;i<NUM_REELS;i++){
      const reel = document.createElement("div");
      reel.className = "reel";
      const inner = document.createElement("div");
      inner.className = "reel-inner";

      const finalSym = spinSymbols ? spinSymbols[i] : null;
      const dummy1 = document.createElement("div");
      dummy1.className = "reel-symbol";
      dummy1.textContent = "?";
      inner.appendChild(dummy1);

      const dummy2 = document.createElement("div");
      dummy2.className = "reel-symbol";
      dummy2.textContent = "?";
      inner.appendChild(dummy2);

      const finalEl = document.createElement("div");
      finalEl.className = "reel-symbol";
      if(finalSym){
        if(finalSym.type === "player"){
          finalEl.classList.add("player");
          const p = state.players.find(p=>p.id===finalSym.value);
          finalEl.textContent = p ? p.name : "???";
        } else if(finalSym.type === "letter"){
          finalEl.classList.add("letter");
          finalEl.textContent = finalSym.value;
        } else if(finalSym.type === "luna"){
          finalEl.classList.add("luna");
          const img = document.createElement("img");
          img.src = "https://i.ibb.co/8g6ZQM5C/IMG-2604.png";
          img.alt = "Luna";
          finalEl.appendChild(img);
        }
      } else {
        finalEl.textContent = "?";
      }
      inner.appendChild(finalEl);

      reel.appendChild(inner);
      reelsEl.appendChild(reel);
    }
  }

  // ========= RENDER: LEADERBOARD =========
  function renderLeaderboard(){
    const body = $("#leaderboardBody");
    body.innerHTML = "";
    const players = [...state.players].sort((a,b)=>a.joinedAt - b.joinedAt);
    for(const p of players){
      const tr = document.createElement("tr");
      const totalTickets = p.tickets.reduce((a,b)=>a+b,0);
      const w = p.slotWins || 0;
      const s = p.slotSpins || 0;
      const slotWinPct = s ? Math.round((w/s)*100) : 0;
      const deckW = p.deckWins || 0;
      const deckL = p.deckLosses || 0;

      tr.innerHTML = `
        <td class="time-cell">${timeSince(p.joinedAt)}</td>
        <td>${p.name}</td>
        <td>${totalTickets}</td>
        <td>${s}</td>
        <td>
          <span class="pity-pill ${p.pity>=PITY_CAP? "hot":""}">${p.pity}</span>
        </td>
        <td>${s?slotWinPct:0}%</td>
        <td>${deckW}-${deckL}</td>
      `;
      body.appendChild(tr);
    }
  }

  // ========= PLAYER MGMT =========
  function addPlayer(name){
    name = name.trim();
    if(!name) return;
    if(state.players.length >= 50){
      log("Queue is full (50 players).");
      return;
    }
    const player = {
      id: state.nextPlayerId++,
      name,
      tickets: [...INITIAL_TICKETS],
      pity: 0,
      joinedAt: Date.now(),
      slotWins: 0,
      slotSpins: 0,
      deckWins: 0,
      deckLosses: 0,
      afk: false
    };
    state.players.push(player);
    log(`Player added: ${name}`);
    updateHeaderStats();
    renderLeaderboard();
  }

  // ========= SPIN ENGINE =========
  function pickPityWinner(){
    const eligible = state.players.filter(p=>!p.afk && p.pity >= PITY_CAP);
    if(eligible.length === 0) return null;
    eligible.sort((a,b)=>{
      if(a.pity !== b.pity) return b.pity - a.pity;
      const aTickets = a.tickets.reduce((x,y)=>x+y,0);
      const bTickets = b.tickets.reduce((x,y)=>x+y,0);
      if(aTickets !== bTickets) return bTickets - aTickets;
      return a.joinedAt - b.joinedAt;
    });
    return eligible[0];
  }

  function buildSymbols(){
    const symbols = [];
    for(let i=0;i<NUM_REELS;i++){
      const r = Math.random();
      if(r < LUNA_PROB){
        symbols.push({type:"luna", value:"LUNA"});
      } else if(r < LUNA_PROB + LETTER_PROB){
        symbols.push({type:"letter", value:CARLO[i]});
      } else {
        const candidates = state.players.filter(p=>!p.afk && p.tickets[i] > 0);
        if(candidates.length === 0){
          symbols.push({type:"letter", value:CARLO[i]});
        } else {
          const total = candidates.reduce((sum,p)=>sum+p.tickets[i],0);
          let t = Math.random()*total;
          let chosen = candidates[0];
          for(const p of candidates){
            if(t < p.tickets[i]){ chosen = p; break; }
            t -= p.tickets[i];
          }
          symbols.push({type:"player", value:chosen.id});
        }
      }
    }
    return symbols;
  }

  function evaluateSpin(symbols){
    const result = {
      symbols,
      winnerId: null,
      winType: null,
      carlo: false,
      fourKind: false,
      fiveKind: false,
      dead: false,
      lunaWin: false
    };

    // CARLO check
    if(symbols.every((s,idx)=>s.type==="letter" && s.value === CARLO[idx])){
      result.carlo = true;
      result.winType = "carlo";
      return result;
    }

    // Count players
    const counts = {};
    symbols.forEach((s,idx)=>{
      if(s.type === "player"){
        counts[s.value] = (counts[s.value]||0)+1;
      }
    });

    // LunaLuck (wild in any 3-window)
    const lunaIdxs = symbols.map((s,i)=>s.type==="luna"?i:-1).filter(i=>i>=0);
    if(lunaIdxs.length === 1){
      const lIndex = lunaIdxs[0];
      for(let start=0;start<=NUM_REELS-3;start++){
        const window = symbols.slice(start,start+3);
        if(lIndex < start || lIndex > start+2) continue;
        const playersInWindow = window.filter(s=>s.type==="player");
        const idSet = new Set(playersInWindow.map(s=>s.value));
        const hasLetter = window.some(s=>s.type==="letter");
        if(playersInWindow.length === 2 && idSet.size===1 && !hasLetter){
          result.winnerId = playersInWindow[0].value;
          result.winType = "luna";
          result.lunaWin = true;
          return result;
        }
      }
    }

    // Regular 3+/4/5 of a kind
    let bestId = null;
    let bestCount = 0;
    for(const id in counts){
      if(counts[id] > bestCount){
        bestId = parseInt(id,10);
        bestCount = counts[id];
      }
    }
    if(bestId != null && bestCount >=3){
      result.winnerId = bestId;
      result.winType = "normal";
      result.fourKind = (bestCount===4);
      result.fiveKind = (bestCount===5);
      return result;
    }

    // Dead spin
    result.dead = true;
    return result;
  }

  function applyTicketsAndPity(result){
    if(result.carlo){
      // no player ticket changes
      return;
    }
    if(result.winnerId){
      const winner = state.players.find(p=>p.id===result.winnerId);
      if(!winner) return;
      // winner tickets reset
      winner.tickets = [...INITIAL_TICKETS];
      winner.pity = 0;
      winner.slotSpins = (winner.slotSpins||0)+1;
      winner.slotWins = (winner.slotWins||0)+1;

      for(const p of state.players){
        if(p.id === winner.id || p.afk) continue;
        // appeared?
        const appears = result.symbols.some(s=>s.type==="player" && s.value===p.id);
        if(appears){
          for(let i=0;i<NUM_REELS;i++){
            const appearedOnReel = result.symbols[i].type==="player" && result.symbols[i].value===p.id;
            if(!appearedOnReel){
              p.tickets[i] = Math.max(1,p.tickets[i]-1);
            }
          }
        }
      }
      state.players.forEach(clampTicketsAndOverflow);
    } else if(result.dead){
      // dead spin ticket / pity logic
      for(const p of state.players){
        if(p.afk) continue;
        const appears = result.symbols.some(s=>s.type==="player" && s.value===p.id);
        if(appears){
          // appeared: lose 1 ticket per reel, no pity
          for(let i=0;i<NUM_REELS;i++){
            const appearedOnReel = result.symbols[i].type==="player" && result.symbols[i].value===p.id;
            if(appearedOnReel){
              p.tickets[i] = Math.max(1,p.tickets[i]-1);
            }
          }
        } else {
          // unseen: halve then +1, gain pity
          for(let i=0;i<NUM_REELS;i++){
            p.tickets[i] = Math.ceil(p.tickets[i]/2)+1;
          }
          p.pity = Math.min(PITY_CAP, p.pity+1);
        }
        clampTicketsAndOverflow(p);
      }
    }
  }

  function setWinner(result){
    if(!result.winnerId) return;
    const player = state.players.find(p=>p.id===result.winnerId);
    if(!player) return;
    state.currentWinner = {
      playerId: player.id,
      winType: result.winType,
      fourKind: !!result.fourKind,
      fiveKind: !!result.fiveKind,
      luna: !!result.lunaWin
    };
    // show overlay
    $("#winnerName").textContent = player.name;
    let meta = "";
    if(result.winType === "luna") meta = "LunaLuck – wild connects a 3-of-a-kind.";
    else if(result.winType === "normal" && result.fiveKind) meta = "5-of-a-kind! Mega hit.";
    else if(result.winType === "normal" && result.fourKind) meta = "4-of-a-kind! Big hit.";
    else meta = "Normal 3+-of-a-kind win.";
    $("#winnerMeta").textContent = meta;
    $("#winnerOverlay").classList.add("show");
    $("#spinBtn").disabled = true;
    $("#reportBtn").disabled = false;
    $("#statusText").textContent = "Winner selected – play their deck and report.";
    $("#smallStatus").textContent = "Winner pending…";
  }

  function clearWinner(){
    state.currentWinner = null;
    $("#winnerOverlay").classList.remove("show");
    $("#finishOverlay").classList.remove("show");
    $("#spinBtn").disabled = false;
    $("#reportBtn").disabled = false;
    $("#statusText").textContent = "Ready.";
    $("#smallStatus").textContent = "Ready.";
  }

  let isSpinning = false;

  async function spin(){
    if(isSpinning) return;
    if(state.currentWinner){
      alert("You already have a winner pending. Report their run before spinning again.");
      return;
    }
    const activePlayers = state.players.filter(p=>!p.afk);
    if(activePlayers.length === 0){
      alert("Add at least one player before spinning.");
      return;
    }

    const pityWinner = pickPityWinner();
    let symbols;
    let result;
    const reelsEls = Array.from(document.querySelectorAll(".reel"));

    isSpinning = true;
    $("#spinBtn").disabled = true;
    $("#reportBtn").disabled = true;
    $("#statusText").textContent = "Spinning…";
    $("#smallStatus").textContent = "Spinning…";
    $("#lever").classList.add("pull");

    // fake animation
    reelsEls.forEach(r => r.classList.add("spinning"));
    await new Promise(res => setTimeout(res, 550));

    if(pityWinner){
      // rig symbols to land on pity winner
      symbols = [];
      for(let i=0;i<NUM_REELS;i++){
        symbols.push({type:"player", value:pityWinner.id});
      }
      result = {
        symbols,
        winnerId: pityWinner.id,
        winType: "normal",
        carlo: false,
        fourKind: true,
        fiveKind: false,
        dead: false,
        lunaWin: false
      };
      log(`Pity pick: ${pityWinner.name} at ${pityWinner.pity} tokens.`);
    } else {
      symbols = buildSymbols();
      result = evaluateSpin(symbols);
    }

    state.spinCount++;
    if(result.dead) state.deadStreak++;
    else state.deadStreak = 0;

    // stop animation, render final
    reelsEls.forEach(r => r.classList.remove("spinning"));
    renderReels(symbols);
    $("#lever").classList.remove("pull");

    applyTicketsAndPity(result);
    state.lastSpin = result;
    updateHeaderStats();
    renderLeaderboard();

    if(result.carlo){
      $("#statusText").textContent = "CARLOMTG jackpot – host deck slot.";
      $("#smallStatus").textContent = "CARLO hit!";
      log("CARLOMTG jackpot hit.");
    } else if(result.winnerId){
      const p = state.players.find(p=>p.id===result.winnerId);
      log(`Winner: ${p ? p.name : "???"} (${result.winType})`);
      setWinner(result);
    } else {
      $("#statusText").textContent = "Dead spin.";
      $("#smallStatus").textContent = "Nobody hit this time.";
      log("Dead spin.");
      $("#spinBtn").disabled = false;
      $("#reportBtn").disabled = false;
    }

    isSpinning = false;
  }

  // ========= REPORT FLOW =========
  function openFinishOverlay(){
    const cw = state.currentWinner;
    if(!cw) return;
    const player = state.players.find(p=>p.id===cw.playerId);
    if(!player) return;
    $("#finishTitle").textContent = `Report: ${player.name}`;
    $("#runWins").value = 0;
    $("#runLosses").value = 1;
    document.querySelectorAll(".queue-chip").forEach(chip=>{
      chip.classList.toggle("active", chip.dataset.readd === "yes");
    });
    $("#finishOverlay").classList.add("show");
  }

  function saveRunResults(){
    const cw = state.currentWinner;
    if(!cw) return;
    const playerIndex = state.players.findIndex(p=>p.id===cw.playerId);
    if(playerIndex === -1) return;
    const player = state.players[playerIndex];

    const wins = Math.max(0, parseInt($("#runWins").value || "0",10));
    const losses = Math.max(0, parseInt($("#runLosses").value || "0",10));
    if(wins+losses === 0){
      alert("Wins + losses must be at least 1.");
      return;
    }
    player.deckWins = (player.deckWins||0)+wins;
    player.deckLosses = (player.deckLosses||0)+losses;

    const readdYes = document
      .querySelector('.queue-chip[data-readd="yes"]')
      .classList.contains("active");

    if(!readdYes){
      // remove from queue
      state.players.splice(playerIndex,1);
      log(`Removed ${player.name} from queue after their run.`);
    } else {
      // reset pity; simple ticket boost based on run
      player.pity = 0;
      const bonus = Math.min(3,wins);
      player.tickets = INITIAL_TICKETS.map(t=>Math.min(MAX_TICKETS_PER_REEL, t+bonus));
      player.joinedAt = Date.now();
      log(`Re-added ${player.name} with +${bonus} tickets per reel.`);
    }

    renderLeaderboard();
    updateHeaderStats();
    clearWinner();
  }

  // ========= EVENT WIRING =========
  function init(){
    buildLights();
    renderReels(null);
    renderLeaderboard();
    updateHeaderStats();

    $("#addPlayerForm").addEventListener("submit", e=>{
      e.preventDefault();
      const input = $("#playerNameInput");
      addPlayer(input.value);
      input.value = "";
      input.focus();
    });

    $("#spinBtn").addEventListener("click", spin);
    $("#lever").addEventListener("click", spin);
    $("#reportBtn").addEventListener("click", ()=>{
      if(!state.currentWinner){
        alert("No winner pending to report.");
        return;
      }
      openFinishOverlay();
    });

    $("#winnerCloseBtn").addEventListener("click", ()=>{
      $("#winnerOverlay").classList.remove("show");
    });
    $("#winnerReportBtn").addEventListener("click", ()=>{
      $("#winnerOverlay").classList.remove("show");
      openFinishOverlay();
    });

    document.querySelectorAll(".queue-chip").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        document.querySelectorAll(".queue-chip").forEach(c=>c.classList.remove("active"));
        chip.classList.add("active");
      });
    });

    $("#finishCancelBtn").addEventListener("click", ()=>{
      $("#finishOverlay").classList.remove("show");
    });
    $("#finishSaveBtn").addEventListener("click", saveRunResults);
  }

  window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
